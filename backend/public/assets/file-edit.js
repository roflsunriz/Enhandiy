import{r as B,i as D,$ as e,b as p,c as y,a as w,d as m,e as f}from"./error-handling.js";import{r as g,p as T,g as k}from"./http.js";import{h as S,s as I}from"./bootstrap.js";let h=null;B(()=>{D(),_()});function _(){const n=e("#saveCommentBtn");n&&n.addEventListener("click",N);const s=e("#replaceFileBtn");s&&s.addEventListener("click",K),document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(d=>{d.addEventListener("shown.bs.tab",U)});const a=e("#generateShareLinkBtn");a&&a.addEventListener("click",H);const t=e("#saveShareSettingsBtn");t&&t.addEventListener("click",O),document.querySelectorAll('input[name="shareFormat"]').forEach(d=>{d.addEventListener("change",A)});const i=e("#copyShareUrlBtn");i&&i.addEventListener("click",C);const r=e("#shareMaxDownloads"),c=e("#shareExpiresDays");r&&r.addEventListener("input",x),c&&c.addEventListener("input",x)}function E(n,s,o=""){const a=e("#editFileId"),t=e("#replaceFileId"),l=e("#editFileName"),i=e("#replaceFileName"),r=e("#editComment");a&&(a.value=n),t&&(t.value=n),l&&(l.value=s),i&&(i.value=s),r&&(r.value=o),F("comment-tab","commentTab"),I("editModal"),setTimeout(()=>{const c=e("#saveCommentBtn"),d=e("#replaceFileBtn");c&&(m(c,"d-none"),c.style.display="inline-block"),d&&(f(d,"d-none"),d.style.display="none")},10)}function L(n,s,o=""){const a=e("#editFileId"),t=e("#replaceFileId"),l=e("#editFileName"),i=e("#replaceFileName"),r=e("#editComment");a&&(a.value=n),t&&(t.value=n),l&&(l.value=s),i&&(i.value=s),r&&(r.value=o);const c=e("#editReplaceKeyInput");c&&(c.value="");const d=e("#editMasterKeyInput");d&&(d.value=""),F("comment-tab","commentTab"),I("editModal"),setTimeout(()=>{const u=e("#saveCommentBtn"),v=e("#replaceFileBtn");u&&(m(u,"d-none"),u.style.display="inline-block"),v&&(f(v,"d-none"),v.style.display="none")},10)}function R(n,s=""){const o=e("#replaceFileId"),a=e("#editFileName"),t=e("#replaceFileName");o&&(o.value=n),a&&(a.value=s),t&&(t.value=s),F("replace-tab","replaceTab"),I("editModal"),setTimeout(()=>{const l=e("#saveCommentBtn"),i=e("#replaceFileBtn");i&&(m(i,"d-none"),i.style.display="inline-block"),l&&(f(l,"d-none"),l.style.display="none")},10)}function M(n,s,o=""){const a=e("#shareFileName"),t=e("#shareFileComment");a&&(a.value=s,a.setAttribute("data-file-id",n)),t&&(t.value=o),P(n),setTimeout(()=>{x()},100);const l=e("#shareResultPanel"),i=e("#regenerateShareLinkBtn"),r=e("#generateShareLinkBtn");l&&(f(l,"d-none"),l.style.display="none"),i&&(i.style.display="none"),r&&(r.style.display="inline-block"),I("shareLinkModal")}async function N(){const n=e("#editFileId"),s=e("#editComment"),o=e("#editReplaceKeyInput"),a=e("#editMasterKeyInput");if(!n||!s){p("必要な入力項目が見つかりません。");return}const t=n.value,l=s.value,i=o?.value||"",r=a?.value||"";if(!t){p("ファイルIDが指定されていません。");return}if(!r.trim()&&!i.trim()){p("マスターキーまたは差し替えキーのいずれかを入力してください。");return}try{const c=await g(`/api/index.php?path=/api/files/${encodeURIComponent(t)}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:l,master_key:r.trim(),replace_key:i.trim()})});if(c.success)y("コメントを保存しました。"),S("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(c.error||"コメントの保存に失敗しました。")}catch(c){console.error("コメント保存エラー:",c),p("コメントの保存に失敗しました。")}}async function K(){const n=e("#replaceFileId"),s=e("#replaceFileInput"),o=e("#replaceMasterKeyInput"),a=e("#modalReplaceKeyInput");if(!n||!s){p("必要な入力項目が見つかりません。");return}const t=n.value,l=s.files;if(!t){p("ファイルIDが指定されていません。");return}if(!l||l.length===0){p("差し替えるファイルを選択してください。");return}const i=l[0],r=o?.value||"",c=a?.value||"";if(!r.trim()&&!c.trim()){p("マスターキーまたは差し替えキーのいずれかを入力してください。");return}const d=new FormData;d.append("file",i),d.append("master_key",r.trim()),d.append("replacekey",c.trim()),d.append("csrf_token",window.config?.csrf_token||"");try{const u=await T(`/api/index.php?path=/api/files/${encodeURIComponent(t)}/replace`,d);if(u.success)y("ファイルを差し替えました。"),S("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else{const v=u.message||u.error||"ファイルの差し替えに失敗しました。";throw new Error(v)}}catch(u){console.error("ファイル差し替えエラー:",u),p("ファイルの差し替えに失敗しました。")}}function U(n){const s=n.target,o=w(s,"data-bs-target"),a=e("#saveCommentBtn"),t=e("#replaceFileBtn");o==="#commentTab"?(a&&(m(a,"d-none"),a.style.display="inline-block"),t&&(f(t,"d-none"),t.style.display="none")):o==="#replaceTab"&&(a&&(f(a,"d-none"),a.style.display="none"),t&&(m(t,"d-none"),t.style.display="inline-block"))}async function H(){const n=e("#shareFileName"),s=e("#shareMaxDownloads"),o=e("#shareExpiresDays");if(!n){p("ファイル情報が見つかりません。");return}const a=w(n,"data-file-id"),t=s?.value||null,l=o?.value||null;if(!a){p("ファイルIDが見つかりません。");return}const i=e("#generateShareLinkBtn");i&&(i.disabled=!0,i.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const r=await g(`/api/index.php?path=/api/files/${encodeURIComponent(a)}/share`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({max_downloads:t,expires_days:l})});if(r.success&&r.data)h=r.data,$(r.data),await C(),y("共有リンクを生成しました。");else{const c=r,d=c.message||c.error||"共有リンクの生成に失敗しました。";throw new Error(d)}}catch(r){console.error("共有リンク生成エラー:",r);const c=r instanceof Error?r.message:"共有リンクの生成に失敗しました。";p(c)}finally{i&&(i.disabled=!1,i.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function $(n){const s=e("#shareMaxDownloads");s&&(s.value=n.max_downloads?.toString()||"");const o=e("#shareExpiresDays");o&&(o.value=n.expires_days?.toString()||"");const a=e("#currentMaxDownloads"),t=e("#currentExpiresDays");if(a){const d=n.max_downloads||"無制限";a.innerHTML=`<strong>最大ダウンロード数:</strong> ${d}`}if(t){const d=n.expires_days||"無期限";t.innerHTML=`<strong>有効期限:</strong> ${d}`}const l=e("#shareResultPanel");l&&(m(l,"d-none"),l.style.display="block");const i=e("#regenerateShareLinkBtn"),r=e("#generateShareLinkBtn");i&&(i.style.display="inline-block"),r&&(r.style.display="none");const c=document.querySelector('input[name="shareFormat"][value="url_only"]');c&&(c.checked=!0,b(n))}function A(){h&&b(h)}function b(n){const s=document.querySelector('input[name="shareFormat"]:checked'),o=e("#shareUrlTextField");if(!s||!o)return;const a=s.value;a==="url_only"?o.value=n.urlOnly||n.share_url||"":a==="url_with_comment"&&(o.value=n.urlWithComment||n.share_url_with_comment||"")}function F(n,s){document.querySelectorAll(".nav-link").forEach(t=>{m(t,"active"),w(t,"aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(t=>{m(t,"active"),m(t,"show")});const o=e("#"+n),a=e("#"+s);o&&(f(o,"active"),w(o,"aria-selected","true")),a&&(f(a,"active"),f(a,"show"))}function q(n,s="",o=""){E(n,s,o)}if(typeof window<"u"){const n=window;n.openEditDialog=E,n.editFile=q,n.editComment=L,n.replaceFile=R,n.openShareModal=M}async function P(n){try{const s=await k(`/api/index.php?path=/api/files/${encodeURIComponent(n)}/share`);if(s.success&&s.data){const o=s.data,a=e("#shareMaxDownloads"),t=e("#shareExpiresDays");a&&(a.value=o.max_downloads?.toString()||""),t&&(t.value=o.expires_days?.toString()||""),h={...h,max_downloads:o.max_downloads,expires_days:o.expires_days}}}catch(s){console.error("設定取得エラー:",s)}}async function O(){const n=e("#shareFileName"),s=e("#shareMaxDownloads"),o=e("#shareExpiresDays");if(!n){p("ファイル情報が見つかりません。");return}const a=n.getAttribute("data-file-id")||"",t=s?.value||null,l=o?.value||null,i=e("#saveShareSettingsBtn");i&&(i.disabled=!0,i.innerText="保存中...");try{const r=await g(`/api/index.php?path=/api/files/${encodeURIComponent(a)}/share`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({max_downloads:t?parseInt(t):null,expires_days:l?parseInt(l):null})});if(r.success)y("設定を保存しました。"),h={...h,max_downloads:t?parseInt(t):void 0,expires_days:l?parseInt(l):void 0};else throw new Error(r.error||"設定保存に失敗しました。")}catch(r){console.error("設定保存エラー:",r),p("設定の保存に失敗しました。")}finally{i&&(i.disabled=!1,i.innerText="設定を保存")}}async function C(){const n=e("#shareUrlTextField");if(!n||!n.value){p("コピーする共有内容がありません。");return}try{await navigator.clipboard.writeText(n.value),y("共有内容をクリップボードにコピーしました。")}catch{n.select(),document.execCommand("copy"),y("共有内容をクリップボードにコピーしました。")}}function x(){const n=e("#shareMaxDownloads"),s=e("#shareExpiresDays"),o=e("#currentMaxDownloads"),a=e("#currentExpiresDays");if(o&&n){const t=n.value.trim()||"無制限";o.innerHTML=`<strong>最大ダウンロード数:</strong> ${t}`}if(a&&s){const t=s.value.trim()||"無期限";a.innerHTML=`<strong>有効期限:</strong> ${t} ${t!=="無期限"?"日":""}`}}window.openShareModal=M;
