import{r as L,i as B,$ as c,e as h,d as I}from"./error-handling.js";import{s as m}from"./modal.js";import{a as C}from"./http.js";import{i as g}from"./password-strength.js";import{b as x}from"./bootstrap.js";let p=[],u=!1;L(()=>{B(),S()});function S(){const e=c("#dragDropArea"),o=c("#selectFilesBtn"),r=c("#selectFolderBtn"),i=c("#multipleFileInput"),l=c("#folderInput"),t=c("#clearFilesBtn");if(!e){console.warn("Drag drop area not found");return}e.addEventListener("dragover",T),e.addEventListener("dragenter",M),e.addEventListener("dragleave",q),e.addEventListener("drop",U),o&&o.addEventListener("click",()=>{u||i?.click()}),e.addEventListener("click",n=>{if(u)return;n.target.tagName!=="BUTTON"&&i?.click()}),r&&r.addEventListener("click",()=>{u||l?.click()}),i&&i.addEventListener("change",n=>{const s=n.target;s.files&&y(s.files)}),l&&l.addEventListener("change",n=>{const s=n.target;s.files&&y(s.files)}),t&&t.addEventListener("click",()=>{u||k()}),document.addEventListener("click",n=>{if(n.target.id==="uploadBtn"){if(n.preventDefault(),n.stopPropagation(),typeof window.enhancedFileUpload=="function")window.enhancedFileUpload();else if(p.length>0)E();else{const a=c("#multipleFileInput");a?.files&&a.files.length>0?D(a.files[0]):m("ファイルが選択されていません。")}return!1}})}function T(e){e.preventDefault(),e.stopPropagation(),h(e.currentTarget,"drag-over")}function M(e){e.preventDefault(),e.stopPropagation(),h(e.currentTarget,"drag-over")}function q(e){e.preventDefault(),e.stopPropagation();const o=e.currentTarget;o.contains(e.relatedTarget)||I(o,"drag-over")}function U(e){if(e.preventDefault(),e.stopPropagation(),I(e.currentTarget,"drag-over"),u)return;const o=e.dataTransfer?.files;o&&y(o)}function y(e){if(!(!e||e.length===0)){for(let o=0;o<e.length;o++){const r=e[o];p.some(l=>l.name===r.name&&l.size===r.size&&l.lastModified===r.lastModified)||p.push(r)}w(),A()}}function w(){const e=c("#selectedFilesList");if(!e)return;e.innerHTML="",p.forEach((t,n)=>{const s=document.createElement("div");s.className="file-item",s.dataset.filename=t.name;const a=_(t.name),d=t.name,f=z(t.size);s.innerHTML=`
      <div class="upload-method-indicator" style="display: none;"></div>
      <span class="file-icon">${a}</span>
      <div class="file-info">
        <span class="file-name">${P(d)}</span>
        <span class="file-size">${f}</span>
      </div>
      <div class="upload-controls">
        <button type="button" class="upload-control-btn pause" title="一時停止" style="display: none;">
          <span class="glyphicon glyphicon-pause"></span>
        </button>
        <button type="button" class="upload-control-btn resume" title="再開" style="display: none;">
          <span class="glyphicon glyphicon-play"></span>
        </button>
        <button type="button" class="upload-control-btn cancel" title="キャンセル" style="display: none;">
          <span class="glyphicon glyphicon-stop"></span>
        </button>
      </div>
      <button type="button" class="file-remove" data-index="${n}">
        <span class="glyphicon glyphicon-remove"></span>
      </button>
      <div class="upload-progress" style="display: none;">
        <div class="upload-progress-bar"></div>
      </div>
      <div class="upload-status" style="display: none;"></div>
      <div class="detailed-progress" style="display: none;">
        <div class="progress-text">
          <span class="progress-percentage">0%</span>
          <span class="progress-size">0B / ${f}</span>
        </div>
        <div class="speed-info">速度: 計算中...</div>
      </div>
    `,e.appendChild(s)}),e.querySelectorAll(".file-remove").forEach(t=>{t.addEventListener("click",n=>{if(u)return;const s=n.currentTarget,a=parseInt(s.dataset.index||"0");p.splice(a,1),w(),p.length===0&&v()})}),e.querySelectorAll(".upload-control-btn.pause").forEach(t=>{t.addEventListener("click",n=>{const a=n.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.pauseUpload=="function"&&window.pauseUpload(a)})}),e.querySelectorAll(".upload-control-btn.resume").forEach(t=>{t.addEventListener("click",n=>{const a=n.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.resumeUpload=="function"&&window.resumeUpload(a)})}),e.querySelectorAll(".upload-control-btn.cancel").forEach(t=>{t.addEventListener("click",n=>{const a=n.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.cancelUpload=="function"&&window.cancelUpload(a)})})}function _(e){const o=e.split(".").pop()?.toLowerCase()||"";return x(o,20)}function z(e){if(e===0)return"0 Bytes";const o=1024,r=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(o));return parseFloat((e/Math.pow(o,i)).toFixed(1))+" "+r[i]}function A(){const e=c("#selectedFilesContainer");e&&(e.style.display="block",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.transition="all 0.3s ease",e.style.opacity="1",e.style.transform="translateY(0)"},10))}function v(){const e=c("#selectedFilesContainer");e&&(e.style.transition="all 0.3s ease",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.display="none"},300))}function k(){p=[],w(),v();const e=c("#multipleFileInput"),o=c("#folderInput");e&&(e.value=""),o&&(o.value="")}async function E(){if(p.length===0){await m("ファイルが選択されていません。");return}if(u){await m("アップロード中です。しばらくお待ちください。");return}u=!0;const e=c("#errorContainer"),o=c("#uploadContainer");e&&(e.style.display="none"),o&&(o.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(i=>{i.style.display="block"}),F(0)}async function F(e){if(e>=p.length){u=!1,p.length=0;const t=c("#uploadContainer"),n=c("#selectedFilesList");t&&(t.style.display="none"),n&&(n.innerHTML="");const s=document.querySelector("#selectedFilesContainer .file-count");s&&(s.textContent="0"),v(),window.fileManagerInstance&&await window.fileManagerInstance.refreshFromServer(),window.folderManager&&await window.folderManager.refreshAll(),!window.fileManagerInstance&&!window.folderManager&&window.location.reload();return}const o=p[e],i=document.querySelectorAll(".file-item")[e],l=i.querySelector(".upload-progress-bar");try{const t=b();await D(o,t,l),l&&(l.style.width="100%"),i.style.backgroundColor="#d4edda",setTimeout(()=>{F(e+1)},500)}catch(t){t instanceof Error&&t.message.includes("キーが弱すぎます")?await m(t.message):H(t,o.name),u=!1;const n=c("#uploadContainer");n&&(n.style.display="none")}}async function D(e,o,r){return new Promise((i,l)=>{const t=new FormData;t.append("file",e);let n;try{n=o||b()}catch(d){if(d instanceof Error&&d.message.includes("キーが弱すぎます")){l(d);return}else throw d}t.append("comment",n.comment||""),t.append("dlkey",n.dlkey||""),t.append("delkey",n.delkey||""),t.append("replacekey",n.replacekey||""),n.maxDownloads&&n.maxDownloads>0&&t.append("max_downloads",n.maxDownloads.toString()),n.expiresDays&&n.expiresDays>0&&t.append("expires_days",n.expiresDays.toString()),n.folderId&&t.append("folder_id",String(n.folderId));const s=C();s&&t.append("csrf_token",s);const a=new XMLHttpRequest;r&&a.upload&&a.upload.addEventListener("progress",d=>{if(d.lengthComputable){const f=Math.round(d.loaded/d.total*100);r.style.width=f+"%"}}),a.addEventListener("load",()=>{try{const d=JSON.parse(a.responseText);d.status==="ok"?i():l(d)}catch{l({status:"network_error",message:"レスポンスの解析に失敗しました"})}}),a.addEventListener("error",()=>{l({status:"network_error",message:"ネットワークエラーが発生しました"})}),a.open("POST","/api/index.php?path=/api/files"),s&&a.setRequestHeader("X-CSRF-Token",s),a.send(t)})}function b(){const e=document.getElementById("commentInput"),o=document.getElementById("dlkeyInput"),r=document.getElementById("delkeyInput"),i=document.getElementById("replaceKeyInput"),l=document.getElementById("maxDownloadsUploadInput"),t=document.getElementById("expiresDaysUploadInput"),n=document.getElementById("folder-select"),s=o?.value||"",a=r?.value||"",d=i?.value||"";if(s&&g(s))throw new Error("DLキーが弱すぎます。より複雑なキーを設定してください。");if(a&&g(a))throw new Error("削除キーが弱すぎます。より複雑なキーを設定してください。");if(d&&g(d))throw new Error("差し替えキーが弱すぎます。より複雑なキーを設定してください。");return{comment:e?.value||"",dlkey:s,delkey:a,replacekey:d,maxDownloads:l&&parseInt(l.value)||void 0,expiresDays:t&&parseInt(t.value)||void 0,folderId:n?.value||void 0}}function H(e,o){let r="";switch(e.error_code?e.error_code:e.status){case"filesize_over":r="ファイル容量が大きすぎます: "+o;break;case"extension_error":r="許可されていない拡張子です: "+o+" (拡張子: "+e.ext+")";break;case"comment_error":r="コメントの文字数が規定数を超えています。";break;case"dlkey_required":r="DLキーは必須入力です。";break;case"delkey_required":r="DELキーは必須入力です。";break;case"sqlwrite_error":r="データベースの書き込みに失敗しました: "+o;break;case"network_error":r=e.message+": "+o;break;default:r="アップロードに失敗しました: "+o;break}const l=c("#errorContainer"),t=l?.querySelector(".panel-body");t&&(t.textContent=r),l&&(l.style.display="block")}function P(e){const o=document.createElement("div");return o.textContent=e,o.innerHTML}window.selectedFiles=p;window.isUploading=u;window.handleFiles=y;window.uploadMultipleFiles=E;window.clearSelectedFiles=k;
