import{r as C,i as B,$ as s,e as w,d as v}from"./error-handling.js";import{s as f}from"./modal.js";import{a as T}from"./http.js";import{i as y}from"./password-strength.js";import{a as g}from"./bootstrap.js";let p=[],u=!1;C(()=>{B(),S()});function S(){const e=s("#dragDropArea"),n=s("#selectFilesBtn"),l=s("#selectFolderBtn"),i=s("#multipleFileInput"),r=s("#folderInput"),t=s("#clearFilesBtn");if(!e){console.warn("Drag drop area not found");return}e.addEventListener("dragover",x),e.addEventListener("dragenter",M),e.addEventListener("dragleave",U),e.addEventListener("drop",_),n&&n.addEventListener("click",()=>{u||i?.click()}),e.addEventListener("click",o=>{if(u)return;o.target.tagName!=="BUTTON"&&i?.click()}),l&&l.addEventListener("click",()=>{u||r?.click()}),i&&i.addEventListener("change",o=>{const a=o.target;a.files&&m(a.files)}),r&&r.addEventListener("change",o=>{const a=o.target;a.files&&m(a.files)}),t&&t.addEventListener("click",()=>{u||h()}),document.addEventListener("click",o=>{if(o.target.id==="uploadBtn"){if(o.preventDefault(),o.stopPropagation(),typeof window.enhancedFileUpload=="function")window.enhancedFileUpload();else if(p.length>0)E();else{const d=s("#multipleFileInput");d?.files&&d.files.length>0?b(d.files[0]):f("ファイルが選択されていません。")}return!1}})}function x(e){e.preventDefault(),e.stopPropagation(),w(e.currentTarget,"drag-over")}function M(e){e.preventDefault(),e.stopPropagation(),w(e.currentTarget,"drag-over")}function U(e){e.preventDefault(),e.stopPropagation();const n=e.currentTarget;n.contains(e.relatedTarget)||v(n,"drag-over")}function _(e){if(e.preventDefault(),e.stopPropagation(),v(e.currentTarget,"drag-over"),u)return;const n=e.dataTransfer?.files;n&&m(n)}function m(e){if(!(!e||e.length===0)){for(let n=0;n<e.length;n++){const l=e[n];p.some(r=>r.name===l.name&&r.size===l.size&&r.lastModified===l.lastModified)||p.push(l)}k(),A()}}function q(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function k(){const e=s("#selectedFilesList");if(!e)return;e.innerHTML="",p.forEach(r=>{const t=document.createElement("div");t.className="file-item",t.dataset.filename=r.name,t.innerHTML=`
      <div class="upload-method-indicator" style="display: none;"></div>
      <span class="file-name">${q(r.name)}</span>
      <div class="upload-controls upload-controls--lg">
        <button type="button" class="upload-control-btn upload-control-btn--lg pause" title="一時停止" style="display: none;">
          ${g.pause(20)}
        </button>
        <button type="button" class="upload-control-btn upload-control-btn--lg resume" title="再開" style="display: none;">
          ${g.resume(20)}
        </button>
        <button type="button" class="upload-control-btn upload-control-btn--lg cancel" title="キャンセル" style="display: none;">
          ${g.cancel(20)}
        </button>
      </div>
    `,e.appendChild(t)}),e.querySelectorAll(".upload-control-btn.pause").forEach(r=>{r.addEventListener("click",t=>{const a=t.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.pauseUpload=="function"&&window.pauseUpload(a)})}),e.querySelectorAll(".upload-control-btn.resume").forEach(r=>{r.addEventListener("click",t=>{const a=t.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.resumeUpload=="function"&&window.resumeUpload(a)})}),e.querySelectorAll(".upload-control-btn.cancel").forEach(r=>{r.addEventListener("click",t=>{const a=t.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.cancelUpload=="function"&&window.cancelUpload(a)})})}function A(){const e=s("#selectedFilesContainer");e&&(e.style.display="block",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.transition="all 0.3s ease",e.style.opacity="1",e.style.transform="translateY(0)"},10))}function I(){const e=s("#selectedFilesContainer");e&&(e.style.transition="all 0.3s ease",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.display="none"},300))}function h(){p=[],k(),I();const e=s("#multipleFileInput"),n=s("#folderInput");e&&(e.value=""),n&&(n.value="")}async function E(){if(p.length===0){await f("ファイルが選択されていません。");return}if(u){await f("アップロード中です。しばらくお待ちください。");return}u=!0;const e=s("#errorContainer"),n=s("#uploadContainer");e&&(e.style.display="none"),n&&(n.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(i=>{i.style.display="block"}),D(0)}async function D(e){if(e>=p.length){u=!1,p.length=0;const t=s("#uploadContainer"),o=s("#selectedFilesList");t&&(t.style.display="none"),o&&(o.innerHTML="");const a=document.querySelector("#selectedFilesContainer .file-count");a&&(a.textContent="0"),I(),window.fileManagerInstance&&await window.fileManagerInstance.refreshFromServer(),window.folderManager&&await window.folderManager.refreshAll(),!window.fileManagerInstance&&!window.folderManager&&window.location.reload();return}const n=p[e],i=document.querySelectorAll(".file-item")[e],r=i.querySelector(".upload-progress-bar");try{const t=F();await b(n,t,r),r&&(r.style.width="100%"),i.style.backgroundColor="#d4edda",setTimeout(()=>{D(e+1)},500)}catch(t){t instanceof Error&&t.message.includes("キーが弱すぎます")?await f(t.message):H(t,n.name),u=!1;const o=s("#uploadContainer");o&&(o.style.display="none")}}async function b(e,n,l){return new Promise((i,r)=>{const t=new FormData;t.append("file",e);let o;try{o=n||F()}catch(c){if(c instanceof Error&&c.message.includes("キーが弱すぎます")){r(c);return}else throw c}t.append("comment",o.comment||""),t.append("dlkey",o.dlkey||""),t.append("delkey",o.delkey||""),t.append("replacekey",o.replacekey||""),o.maxDownloads&&o.maxDownloads>0&&t.append("max_downloads",o.maxDownloads.toString()),o.expiresDays&&o.expiresDays>0&&t.append("expires_days",o.expiresDays.toString()),o.folderId&&t.append("folder_id",String(o.folderId));const a=T();a&&t.append("csrf_token",a);const d=new XMLHttpRequest;l&&d.upload&&d.upload.addEventListener("progress",c=>{if(c.lengthComputable){const L=Math.round(c.loaded/c.total*100);l.style.width=L+"%"}}),d.addEventListener("load",()=>{try{const c=JSON.parse(d.responseText);c.status==="ok"?i():r(c)}catch{r({status:"network_error",message:"レスポンスの解析に失敗しました"})}}),d.addEventListener("error",()=>{r({status:"network_error",message:"ネットワークエラーが発生しました"})}),d.open("POST","/api/index.php?path=/api/files"),a&&d.setRequestHeader("X-CSRF-Token",a),d.send(t)})}function F(){const e=document.getElementById("commentInput"),n=document.getElementById("dlkeyInput"),l=document.getElementById("delkeyInput"),i=document.getElementById("replaceKeyInput"),r=document.getElementById("maxDownloadsUploadInput"),t=document.getElementById("expiresDaysUploadInput"),o=document.getElementById("folder-select"),a=n?.value||"",d=l?.value||"",c=i?.value||"";if(a&&y(a))throw new Error("DLキーが弱すぎます。より複雑なキーを設定してください。");if(d&&y(d))throw new Error("削除キーが弱すぎます。より複雑なキーを設定してください。");if(c&&y(c))throw new Error("差し替えキーが弱すぎます。より複雑なキーを設定してください。");return{comment:e?.value||"",dlkey:a,delkey:d,replacekey:c,maxDownloads:r&&parseInt(r.value)||void 0,expiresDays:t&&parseInt(t.value)||void 0,folderId:o?.value||void 0}}function H(e,n){let l="";switch(e.error_code?e.error_code:e.status){case"filesize_over":l="ファイル容量が大きすぎます: "+n;break;case"extension_error":l="許可されていない拡張子です: "+n+" (拡張子: "+e.ext+")";break;case"comment_error":l="コメントの文字数が規定数を超えています。";break;case"dlkey_required":l="DLキーは必須入力です。";break;case"delkey_required":l="DELキーは必須入力です。";break;case"sqlwrite_error":l="データベースの書き込みに失敗しました: "+n;break;case"network_error":l=e.message+": "+n;break;default:l="アップロードに失敗しました: "+n;break}const r=s("#errorContainer"),t=r?.querySelector(".panel-body");t&&(t.textContent=l),r&&(r.style.display="block")}window.selectedFiles=p;window.isUploading=u;window.handleFiles=m;window.uploadMultipleFiles=E;window.clearSelectedFiles=h;
