import{r as G,i as J,$ as S,d as w,e as B,b as W}from"./error-handling.js";import{a as R}from"./http.js";import{s as v}from"./modal.js";import{h as j,b as X}from"./bootstrap.js";import{i as q}from"./password-strength.js";const m={};let C=!1,E=!1;G(()=>{J(),Y(),S(".global-upload-status")||document.body.insertAdjacentHTML("beforeend",`
      <div class="global-upload-status">
        <h6>アップロード進行状況</h6>
        <div class="global-upload-progress">
          <div class="global-upload-progress-bar"></div>
        </div>
        <div class="global-upload-info"></div>
      </div>
    `),document.getElementById("uploadErrorToast")||document.body.insertAdjacentHTML("beforeend",`
      <div id="uploadErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1060;">
        <div class="d-flex">
          <div class="toast-body">アップロードに失敗しました。</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`)});async function Y(){if(typeof window.tus>"u"){console.warn("Tus.js library not loaded, falling back to traditional upload"),C=!1;return}try{(await fetch("/api/index.php?path=/api/tus-upload",{method:"OPTIONS",signal:AbortSignal.timeout(2e3)})).headers.get("Tus-Resumable")?C=!0:(console.warn("Tus.io server response invalid, falling back to traditional upload"),C=!1)}catch(e){console.warn("Tus.io server not available, falling back to traditional upload:",e),C=!1}}function M(e,r={}){return new Promise((o,n)=>{const{comment:s="",dlkey:a="",delkey:i="",replacekey:t="",maxDownloads:d=null,expiresDays:l=null,folderId:c=null}=r,b=window.config?.upload_method_priority||"resumable",u=window.config?.upload_fallback_enabled!==!1;if(b==="normal"){F(e,r).then(o).catch(p=>{u&&C?f():n(p)});return}if(!C){u?F(e,r).then(o).catch(n):n(new Error("Resumable upload not available and fallback disabled"));return}f();function f(){if(!window.tus){n(new Error("Tus.js not available"));return}const p={filename:e.name,filetype:e.type||"application/octet-stream"},k=R();k?p.csrf_token=k:console.error("CSRF Debug - Token not found or empty!"),s&&(p.comment=s),a&&(p.dlkey=a),i&&(p.delkey=i),d&&(p.max_downloads=d.toString()),l&&(p.expires_days=l.toString()),c&&(p.folder_id=c.toString()),t&&(p.replacekey=t.toString());const y=new window.tus.Upload(e,{endpoint:"/api/index.php?path=/api/tus-upload",retryDelays:[0,1e3,3e3,5e3],metadata:p,chunkSize:512*1024,removeFingerprintOnSuccess:!0,resume:!1,onError:g=>{console.error("Tus upload failed:",g),delete m[e.name],E=!0,u?F(e,r).then(o).catch(n):n(g)},onProgress:(g,x)=>{const T=Math.round(g/x*100),I=Date.now(),h=m[e.name];if(h){h.lastTime||(h.lastTime=I,h.lastBytes=0);const A=(I-h.lastTime)/1e3,K=g-(h.lastBytes||0),L=A>0?K/A:0;h.lastTime=I,h.lastBytes=g,h.progress=T,h.lastSpeed=L,h.uploadedBytes=g,h.totalBytes=x,H(e.name,T,g,x,"resumable",L)}},onSuccess:()=>{U(e.name),o()}});y.start(),m[e.name]={upload:y,file:e,options:r,progress:0}}})}async function F(e,r){const o=new FormData;o.append("file",e),o.append("comment",r.comment||"");const n=R();return n?o.append("csrf_token",n):console.error("Fallback CSRF Debug - Token not found or empty!"),o.append("dlkey",r.dlkey||""),o.append("delkey",r.delkey||""),o.append("replacekey",r.replacekey||""),r.maxDownloads&&o.append("max_downloads",r.maxDownloads.toString()),r.expiresDays&&o.append("expires_days",r.expiresDays.toString()),r.folderId&&o.append("folder_id",r.folderId.toString()),new Promise((s,a)=>{const i=Date.now();let t=i,d=0;m[e.name]||(m[e.name]={file:e,options:r,progress:0,lastTime:i,lastBytes:0,lastSpeed:0,uploadedBytes:0,totalBytes:e.size});const l=new XMLHttpRequest;l.upload&&l.upload.addEventListener("progress",c=>{if(c.lengthComputable){const b=Math.round(c.loaded/c.total*100),u=Date.now(),f=(u-t)/1e3,p=c.loaded-d,k=f>0?p/f:0;t=u,d=c.loaded;const y=m[e.name];y&&(y.progress=b,y.lastTime=u,y.lastBytes=c.loaded,y.lastSpeed=k,y.uploadedBytes=c.loaded,y.totalBytes=c.total),H(e.name,b,c.loaded,c.total,"fallback",k)}}),l.addEventListener("load",()=>{const c=l.status>=200&&l.status<300,b=l.getResponseHeader("Content-Type")||"",u=(l.responseText||"").trim();let f=null;if(b.includes("application/json")&&u.length>0)try{f=JSON.parse(u)}catch{console.error("Failed to parse JSON response:",u)}else if(u.startsWith("{"))try{f=JSON.parse(u)}catch{}if(f){if(f.status==="ok"||f.status==="success"){U(e.name),s();return}console.error("Fallback upload failed with response:",f),D(f,e.name),E=!0,a(new Error("Upload failed: "+f.status));return}if(c){U(e.name),s();return}const p="HTTP "+l.status+" "+l.statusText+(u?" - "+u.slice(0,200):"");D({status:"server_error",message:p},e.name),E=!0,a(new Error(p))}),l.addEventListener("error",()=>{console.error("Fallback upload network error:",{status:l.status,statusText:l.statusText,responseText:l.responseText});const c={status:"network_error",message:"Network error: "+l.statusText};D(c,e.name),E=!0,a(new Error("Network error: "+l.statusText))}),l.open("POST","/api/index.php?path=/api/files"),l.send(o)})}function H(e,r,o,n,s,a){const i=document.querySelectorAll(".file-item");let t=null;for(const d of i)if(d.dataset.filename===e){t=d;break}if(t){B(t,"uploading");const d=t.querySelector(".upload-progress"),l=t.querySelector(".upload-status"),c=t.querySelector(".detailed-progress");d&&(d.style.display="block"),l&&(l.style.display="block"),c&&(c.style.display="block");const b=t.querySelector(".upload-progress-bar");b&&(b.style.width=r+"%");const u=t.querySelector(".upload-method-indicator");if(u&&(w(u,"resumable"),w(u,"fallback"),w(u,"failed"),B(u,s),u.textContent=s==="resumable"?"再開可能":"通常",u.style.display="block"),s==="resumable"){const x=t.querySelector(".upload-control-btn.pause"),T=t.querySelector(".upload-control-btn.cancel");x&&(x.style.display="block"),T&&(T.style.display="block")}const f=P(o)+" / "+P(n),p=a?N(a):"計算中...";l&&(l.textContent=r+"% ("+f+")");const k=t.querySelector(".progress-percentage"),y=t.querySelector(".progress-size"),g=t.querySelector(".speed-info");if(k&&(k.textContent=r+"%"),y&&(y.textContent=f),g&&(g.textContent="速度: "+p),a&&a>0&&g){const x=(n-o)/a,T=ee(x);g.textContent="速度: "+p+" | 残り: "+T}}_()}function U(e,r){const o=document.querySelectorAll(".file-item");let n=null;for(const s of o)if(s.dataset.filename===e){n=s;break}if(n){w(n,"uploading"),w(n,"paused"),B(n,"completed");const s=n.querySelector(".upload-progress-bar"),a=n.querySelector(".upload-status"),i=n.querySelectorAll(".upload-controls button"),t=n.querySelector(".detailed-progress");s&&(s.style.width="100%"),a&&(a.textContent="完了"),i.forEach(l=>l.style.display="none"),t&&(t.style.display="none");const d=n.querySelector(".file-info");d&&!d.querySelector(".upload-success-icon")&&d.insertAdjacentHTML("beforeend",`
        <span class="upload-success-icon" style="color: #5cb85c; margin-left: 10px;">
          <span class="glyphicon glyphicon-ok-circle"></span>
        </span>
      `)}delete m[e],_(),Object.keys(m).length===0&&(E?X("uploadErrorToast"):j("uploadModal"),setTimeout(async()=>{const s=S(".global-upload-status");s&&w(s,"active"),document.querySelectorAll(".file-item").forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)});try{const t=window;Array.isArray(t.selectedFiles)&&(t.selectedFiles.length=0);const d=document.getElementById("selectedFilesList");d&&(d.innerHTML="");const l=document.getElementById("multipleFileInput"),c=document.getElementById("folderInput");l&&(l.value=""),c&&(c.value="");const b=document.querySelector("#selectedFilesContainer .file-count");b&&(b.textContent="0")}catch(t){console.warn("Failed to clear selected files UI:",t)}const i=document.getElementById("selectedFilesContainer");i&&(i.style.transition="all 0.3s ease",i.style.opacity="0",i.style.transform="translateY(-10px)",setTimeout(()=>{i.style.display="none"},300));try{window.folderManager?await window.folderManager.refreshAll():window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload()}catch(t){console.error("resumable-upload: 更新処理エラー:",t),window.location.reload()}},2e3))}function $(e){const r=m[e];if(r?.upload){r.upload.abort();const o=document.querySelectorAll(".file-item");for(const n of o){const s=n;if(s.dataset.filename===e){w(s,"uploading"),B(s,"paused");const a=s.querySelector(".upload-control-btn.pause"),i=s.querySelector(".upload-control-btn.resume"),t=s.querySelector(".upload-status");a&&(a.style.display="none"),i&&(i.style.display="block"),t&&(t.textContent="一時停止");break}}return!0}return!1}function Q(e){const r=m[e];if(r?.upload){r.upload.start();const o=document.querySelectorAll(".file-item");for(const n of o){const s=n;if(s.dataset.filename===e){w(s,"paused"),B(s,"uploading");const a=s.querySelector(".upload-control-btn.resume"),i=s.querySelector(".upload-control-btn.pause"),t=s.querySelector(".upload-status");a&&(a.style.display="none"),i&&(i.style.display="block"),t&&(t.textContent="再開中...");break}}return!0}return!1}function V(e){const r=m[e];if(r?.upload){r.upload.abort();const o=document.querySelectorAll(".file-item");for(const n of o){const s=n;if(s.dataset.filename===e){w(s,"uploading"),w(s,"paused"),B(s,"failed");const a=s.querySelectorAll(".upload-controls button"),i=s.querySelector(".upload-status"),t=s.querySelector(".upload-method-indicator");a.forEach(d=>d.style.display="none"),i&&(i.textContent="キャンセル済み"),t&&(w(t,"resumable"),B(t,"failed"));break}}return delete m[e],_(),!0}return!1}async function Z(){const e=document.getElementById("replaceKeyInput");if(!e){await v("差し替えキー入力フィールドが見つかりません。");return}const r=e.value;if(!r||r.trim()===""){await v("差し替えキーの入力は必須です。");return}const o=document.getElementById("multipleFileInput"),n=window.selectedFiles;if(n&&n.length>0){try{await O(n)}catch(s){if(s instanceof Error&&s.message.includes("キーが弱すぎます"))await v(s.message);else throw s}return}if(o?.files&&o.files.length>0){const s=Array.from(o.files);if(s.length===1)try{const a=z();M(s[0],a)}catch(a){if(a instanceof Error&&a.message.includes("キーが弱すぎます"))await v(a.message);else throw a}else try{await O(s)}catch(a){if(a instanceof Error&&a.message.includes("キーが弱すぎます"))await v(a.message);else throw a}return}console.warn("No files selected for upload"),await v("ファイルが選択されていません。ファイルを選択してからアップロードボタンを押してください。")}async function O(e){if(e.length===0)return;window.isUploading=!0;const r=S("#errorContainer"),o=S("#uploadContainer");r&&(r.style.display="none"),o&&(o.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(t=>t.style.display="block");let s;try{s=z()}catch(t){if(t instanceof Error&&t.message.includes("キーが弱すぎます")){await v(t.message),window.isUploading=!1,o&&(o.style.display="none");return}else throw t}let a=0;const i=e.length;e.forEach((t,d)=>{setTimeout(()=>{M(t,s).then(()=>{a++,a===i&&(window.isUploading=!1,o&&(o.style.display="none"))}).catch(l=>{console.error("Upload failed for",t.name,l),a++,a===i&&(window.isUploading=!1,o&&(o.style.display="none"))})},d*100)})}function z(){const e=document.getElementById("commentInput"),r=document.getElementById("dlkeyInput"),o=document.getElementById("delkeyInput"),n=document.getElementById("replaceKeyInput"),s=document.getElementById("maxDownloadsUploadInput"),a=document.getElementById("expiresDaysUploadInput"),i=document.getElementById("folder-select"),t=r?.value||"",d=o?.value||"",l=n?.value||"";if(t&&q(t))throw new Error("DLキーが弱すぎます。より複雑なキーを設定してください。");if(d&&q(d))throw new Error("削除キーが弱すぎます。より複雑なキーを設定してください。");if(l&&q(l))throw new Error("差し替えキーが弱すぎます。より複雑なキーを設定してください。");return{comment:e?.value||"",dlkey:t,delkey:d,replacekey:l,maxDownloads:s&&parseInt(s.value)||void 0,expiresDays:a&&parseInt(a.value)||void 0,folderId:i?.value||void 0}}function _(){const e=Object.keys(m).length,r=S(".global-upload-status");r&&(w(r,"active"),r.style.display="none");const o=S("#progressContainer"),n=S("#progressBar"),s=S("#progressPercent"),a=S("#progressSpeed");if(e===0){o&&(o.style.display="none");return}let i=0,t=0;Object.values(m).forEach(c=>{c.progress!==void 0&&(i+=c.progress),typeof c.lastSpeed=="number"&&c.lastSpeed>=0&&(t+=c.lastSpeed)});const d=Math.round(i/e);o&&(w(o,"d-none"),o.style.display="block"),n&&(n.style.width=d+"%"),s&&(s.textContent=d+"%");const l=t>0?N(t):"計算中...";a&&(a.textContent=l)}function P(e){if(e===0)return"0 Bytes";const r=1024,o=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(r));return parseFloat((e/Math.pow(r,n)).toFixed(1))+" "+o[n]}function N(e){return e<1024?e.toFixed(1)+" B/s":e<1024*1024?(e/1024).toFixed(1)+" KB/s":e<1024*1024*1024?(e/(1024*1024)).toFixed(1)+" MB/s":(e/(1024*1024*1024)).toFixed(1)+" GB/s"}function ee(e){return e<60?Math.round(e)+"秒":e<3600?Math.round(e/60)+"分":Math.round(e/3600)+"時間"}function D(e,r){let o="";switch(e.error_code?e.error_code:e.status){case"filesize_over":o="ファイル容量が大きすぎます: "+r;break;case"extension_error":o="許可されていない拡張子です: "+r+" (拡張子: "+e.ext+")";break;case"comment_error":o="コメントの文字数が規定数を超えています。";break;case"dlkey_required":o="DLキーは必須入力です。";break;case"delkey_required":o="DELキーは必須入力です。";break;case"sqlwrite_error":o="データベースの書き込みに失敗しました: "+r;break;case"network_error":o=e.message+": "+r;break;default:o="アップロードに失敗しました: "+r;break}W(o)}window.enhancedFileUpload=Z;window.pauseUpload=$;window.resumeUpload=Q;window.cancelUpload=V;window.uploadFileResumable=M;
