import{r as K,i as G,$ as h,d as y,e as v,b as J}from"./error-handling.js";import{a as R}from"./http.js";import{s as T}from"./modal.js";import{h as W,c as j}from"./bootstrap.js";import{i as q}from"./password-strength.js";const w={};let I=!1,E=!1;K(()=>{G(),X(),h(".global-upload-status")||document.body.insertAdjacentHTML("beforeend",`
      <div class="global-upload-status">
        <h6>アップロード進行状況</h6>
        <div class="global-upload-progress">
          <div class="global-upload-progress-bar"></div>
        </div>
        <div class="global-upload-info"></div>
      </div>
    `),document.getElementById("uploadErrorToast")||document.body.insertAdjacentHTML("beforeend",`
      <div id="uploadErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1060;">
        <div class="d-flex">
          <div class="toast-body">アップロードに失敗しました。</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`)});async function X(){if(typeof window.tus>"u"){console.warn("Tus.js library not loaded, falling back to traditional upload"),I=!1;return}try{(await fetch("/api/index.php?path=/api/tus-upload",{method:"OPTIONS",signal:AbortSignal.timeout(2e3)})).headers.get("Tus-Resumable")?I=!0:(console.warn("Tus.io server response invalid, falling back to traditional upload"),I=!1)}catch(e){console.warn("Tus.io server not available, falling back to traditional upload:",e),I=!1}}function M(e,r={}){return new Promise((o,n)=>{const{comment:s="",dlkey:a="",delkey:i="",replacekey:t="",maxDownloads:d=null,expiresDays:l=null,folderId:u=null}=r,g=window.config?.upload_method_priority||"resumable",c=window.config?.upload_fallback_enabled!==!1;if(g==="normal"){F(e,r).then(o).catch(p=>{c&&I?f():n(p)});return}if(!I){c?F(e,r).then(o).catch(n):n(new Error("Resumable upload not available and fallback disabled"));return}f();function f(){if(!window.tus){n(new Error("Tus.js not available"));return}const p={filename:e.name,filetype:e.type||"application/octet-stream"},k=R();k?p.csrf_token=k:console.error("CSRF Debug - Token not found or empty!"),s&&(p.comment=s),a&&(p.dlkey=a),i&&(p.delkey=i),d&&(p.max_downloads=d.toString()),l&&(p.expires_days=l.toString()),u&&(p.folder_id=u.toString()),t&&(p.replacekey=t.toString());const C=new window.tus.Upload(e,{endpoint:"/api/index.php?path=/api/tus-upload",retryDelays:[0,1e3,3e3,5e3],metadata:p,chunkSize:512*1024,removeFingerprintOnSuccess:!0,resume:!1,onError:m=>{console.error("Tus upload failed:",m),delete w[e.name],E=!0,c?F(e,r).then(o).catch(n):n(m)},onProgress:(m,x)=>{const S=Math.round(m/x*100),B=Date.now(),b=w[e.name];if(b){b.lastTime||(b.lastTime=B,b.lastBytes=0);const A=(B-b.lastTime)/1e3,z=m-(b.lastBytes||0),N=A>0?z/A:0;b.lastTime=B,b.lastBytes=m,b.progress=S,H(e.name,S,m,x,"resumable",N)}},onSuccess:()=>{U(e.name),o()}});C.start(),w[e.name]={upload:C,file:e,options:r,progress:0}}})}async function F(e,r){const o=new FormData;o.append("file",e),o.append("comment",r.comment||"");const n=R();return n?o.append("csrf_token",n):console.error("Fallback CSRF Debug - Token not found or empty!"),o.append("dlkey",r.dlkey||""),o.append("delkey",r.delkey||""),o.append("replacekey",r.replacekey||""),r.maxDownloads&&o.append("max_downloads",r.maxDownloads.toString()),r.expiresDays&&o.append("expires_days",r.expiresDays.toString()),r.folderId&&o.append("folder_id",r.folderId.toString()),new Promise((s,a)=>{let t=Date.now(),d=0;const l=new XMLHttpRequest;l.upload&&l.upload.addEventListener("progress",u=>{if(u.lengthComputable){const g=Math.round(u.loaded/u.total*100),c=Date.now(),f=(c-t)/1e3,p=u.loaded-d,k=f>0?p/f:0;t=c,d=u.loaded,H(e.name,g,u.loaded,u.total,"fallback",k)}}),l.addEventListener("load",()=>{const u=l.status>=200&&l.status<300,g=l.getResponseHeader("Content-Type")||"",c=(l.responseText||"").trim();let f=null;if(g.includes("application/json")&&c.length>0)try{f=JSON.parse(c)}catch{console.error("Failed to parse JSON response:",c)}else if(c.startsWith("{"))try{f=JSON.parse(c)}catch{}if(f){if(f.status==="ok"||f.status==="success"){U(e.name),s();return}console.error("Fallback upload failed with response:",f),D(f,e.name),E=!0,a(new Error("Upload failed: "+f.status));return}if(u){U(e.name),s();return}const p="HTTP "+l.status+" "+l.statusText+(c?" - "+c.slice(0,200):"");D({status:"server_error",message:p},e.name),E=!0,a(new Error(p))}),l.addEventListener("error",()=>{console.error("Fallback upload network error:",{status:l.status,statusText:l.statusText,responseText:l.responseText});const u={status:"network_error",message:"Network error: "+l.statusText};D(u,e.name),E=!0,a(new Error("Network error: "+l.statusText))}),l.open("POST","/api/index.php?path=/api/files"),l.send(o)})}function H(e,r,o,n,s,a){const i=document.querySelectorAll(".file-item");let t=null;for(const d of i)if(d.dataset.filename===e){t=d;break}if(t){v(t,"uploading");const d=t.querySelector(".upload-progress"),l=t.querySelector(".upload-status"),u=t.querySelector(".detailed-progress");d&&(d.style.display="block"),l&&(l.style.display="block"),u&&(u.style.display="block");const g=t.querySelector(".upload-progress-bar");g&&(g.style.width=r+"%");const c=t.querySelector(".upload-method-indicator");if(c&&(y(c,"resumable"),y(c,"fallback"),y(c,"failed"),v(c,s),c.textContent=s==="resumable"?"再開可能":"通常",c.style.display="block"),s==="resumable"){const x=t.querySelector(".upload-control-btn.pause"),S=t.querySelector(".upload-control-btn.cancel");x&&(x.style.display="block"),S&&(S.style.display="block")}const f=O(o)+" / "+O(n),p=a?Z(a):"計算中...";l&&(l.textContent=r+"% ("+f+")");const k=t.querySelector(".progress-percentage"),C=t.querySelector(".progress-size"),m=t.querySelector(".speed-info");if(k&&(k.textContent=r+"%"),C&&(C.textContent=f),m&&(m.textContent="速度: "+p),a&&a>0&&m){const x=(n-o)/a,S=ee(x);m.textContent="速度: "+p+" | 残り: "+S}}_()}function U(e,r){const o=document.querySelectorAll(".file-item");let n=null;for(const s of o)if(s.dataset.filename===e){n=s;break}if(n){y(n,"uploading"),y(n,"paused"),v(n,"completed");const s=n.querySelector(".upload-progress-bar"),a=n.querySelector(".upload-status"),i=n.querySelectorAll(".upload-controls button"),t=n.querySelector(".detailed-progress");s&&(s.style.width="100%"),a&&(a.textContent="完了"),i.forEach(l=>l.style.display="none"),t&&(t.style.display="none");const d=n.querySelector(".file-info");d&&!d.querySelector(".upload-success-icon")&&d.insertAdjacentHTML("beforeend",`
        <span class="upload-success-icon" style="color: #5cb85c; margin-left: 10px;">
          <span class="glyphicon glyphicon-ok-circle"></span>
        </span>
      `)}delete w[e],_(),Object.keys(w).length===0&&(E?j("uploadErrorToast"):W("uploadModal"),setTimeout(async()=>{const s=h(".global-upload-status");s&&y(s,"active"),document.querySelectorAll(".file-item").forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)});try{const t=window;Array.isArray(t.selectedFiles)&&(t.selectedFiles.length=0);const d=document.getElementById("selectedFilesList");d&&(d.innerHTML="");const l=document.getElementById("multipleFileInput"),u=document.getElementById("folderInput");l&&(l.value=""),u&&(u.value="");const g=document.querySelector("#selectedFilesContainer .file-count");g&&(g.textContent="0")}catch(t){console.warn("Failed to clear selected files UI:",t)}const i=document.getElementById("selectedFilesContainer");i&&(i.style.transition="all 0.3s ease",i.style.opacity="0",i.style.transform="translateY(-10px)",setTimeout(()=>{i.style.display="none"},300));try{window.folderManager?await window.folderManager.refreshAll():window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload()}catch(t){console.error("resumable-upload: 更新処理エラー:",t),window.location.reload()}},2e3))}function Y(e){const r=w[e];if(r?.upload){r.upload.abort();const o=document.querySelectorAll(".file-item");for(const n of o){const s=n;if(s.dataset.filename===e){y(s,"uploading"),v(s,"paused");const a=s.querySelector(".upload-control-btn.pause"),i=s.querySelector(".upload-control-btn.resume"),t=s.querySelector(".upload-status");a&&(a.style.display="none"),i&&(i.style.display="block"),t&&(t.textContent="一時停止");break}}return!0}return!1}function $(e){const r=w[e];if(r?.upload){r.upload.start();const o=document.querySelectorAll(".file-item");for(const n of o){const s=n;if(s.dataset.filename===e){y(s,"paused"),v(s,"uploading");const a=s.querySelector(".upload-control-btn.resume"),i=s.querySelector(".upload-control-btn.pause"),t=s.querySelector(".upload-status");a&&(a.style.display="none"),i&&(i.style.display="block"),t&&(t.textContent="再開中...");break}}return!0}return!1}function Q(e){const r=w[e];if(r?.upload){r.upload.abort();const o=document.querySelectorAll(".file-item");for(const n of o){const s=n;if(s.dataset.filename===e){y(s,"uploading"),y(s,"paused"),v(s,"failed");const a=s.querySelectorAll(".upload-controls button"),i=s.querySelector(".upload-status"),t=s.querySelector(".upload-method-indicator");a.forEach(d=>d.style.display="none"),i&&(i.textContent="キャンセル済み"),t&&(y(t,"resumable"),v(t,"failed"));break}}return delete w[e],_(),!0}return!1}async function V(){const e=document.getElementById("replaceKeyInput");if(!e){await T("差し替えキー入力フィールドが見つかりません。");return}const r=e.value;if(!r||r.trim()===""){await T("差し替えキーの入力は必須です。");return}const o=document.getElementById("multipleFileInput"),n=window.selectedFiles;if(n&&n.length>0){try{await L(n)}catch(s){if(s instanceof Error&&s.message.includes("キーが弱すぎます"))await T(s.message);else throw s}return}if(o?.files&&o.files.length>0){const s=Array.from(o.files);if(s.length===1)try{const a=P();M(s[0],a)}catch(a){if(a instanceof Error&&a.message.includes("キーが弱すぎます"))await T(a.message);else throw a}else try{await L(s)}catch(a){if(a instanceof Error&&a.message.includes("キーが弱すぎます"))await T(a.message);else throw a}return}console.warn("No files selected for upload"),await T("ファイルが選択されていません。ファイルを選択してからアップロードボタンを押してください。")}async function L(e){if(e.length===0)return;window.isUploading=!0;const r=h("#errorContainer"),o=h("#uploadContainer");r&&(r.style.display="none"),o&&(o.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(t=>t.style.display="block");let s;try{s=P()}catch(t){if(t instanceof Error&&t.message.includes("キーが弱すぎます")){await T(t.message),window.isUploading=!1,o&&(o.style.display="none");return}else throw t}let a=0;const i=e.length;e.forEach((t,d)=>{setTimeout(()=>{M(t,s).then(()=>{a++,a===i&&(window.isUploading=!1,o&&(o.style.display="none"))}).catch(l=>{console.error("Upload failed for",t.name,l),a++,a===i&&(window.isUploading=!1,o&&(o.style.display="none"))})},d*100)})}function P(){const e=document.getElementById("commentInput"),r=document.getElementById("dlkeyInput"),o=document.getElementById("delkeyInput"),n=document.getElementById("replaceKeyInput"),s=document.getElementById("maxDownloadsUploadInput"),a=document.getElementById("expiresDaysUploadInput"),i=document.getElementById("folder-select"),t=r?.value||"",d=o?.value||"",l=n?.value||"";if(t&&q(t))throw new Error("DLキーが弱すぎます。より複雑なキーを設定してください。");if(d&&q(d))throw new Error("削除キーが弱すぎます。より複雑なキーを設定してください。");if(l&&q(l))throw new Error("差し替えキーが弱すぎます。より複雑なキーを設定してください。");return{comment:e?.value||"",dlkey:t,delkey:d,replacekey:l,maxDownloads:s&&parseInt(s.value)||void 0,expiresDays:a&&parseInt(a.value)||void 0,folderId:i?.value||void 0}}function _(){const e=Object.keys(w).length,r=h(".global-upload-status");r&&(y(r,"active"),r.style.display="none");const o=h("#progressContainer"),n=h("#progressBar"),s=h("#progressText"),a=h("#uploadStatus");if(e===0){o&&(o.style.display="none");return}let i=0,t=0;Object.values(w).forEach(l=>{l.progress!==void 0&&(i+=l.progress),l.completed&&t++});const d=Math.round(i/e);o&&(o.style.display="block"),n&&(n.style.width=d+"%"),s&&(s.textContent=d+"%"),a&&(a.textContent="完了: "+t+"/"+e)}function O(e){if(e===0)return"0 Bytes";const r=1024,o=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(r));return parseFloat((e/Math.pow(r,n)).toFixed(1))+" "+o[n]}function Z(e){return e<1024?e.toFixed(1)+" B/s":e<1024*1024?(e/1024).toFixed(1)+" KB/s":e<1024*1024*1024?(e/(1024*1024)).toFixed(1)+" MB/s":(e/(1024*1024*1024)).toFixed(1)+" GB/s"}function ee(e){return e<60?Math.round(e)+"秒":e<3600?Math.round(e/60)+"分":Math.round(e/3600)+"時間"}function D(e,r){let o="";switch(e.error_code?e.error_code:e.status){case"filesize_over":o="ファイル容量が大きすぎます: "+r;break;case"extension_error":o="許可されていない拡張子です: "+r+" (拡張子: "+e.ext+")";break;case"comment_error":o="コメントの文字数が規定数を超えています。";break;case"dlkey_required":o="DLキーは必須入力です。";break;case"delkey_required":o="DELキーは必須入力です。";break;case"sqlwrite_error":o="データベースの書き込みに失敗しました: "+r;break;case"network_error":o=e.message+": "+r;break;default:o="アップロードに失敗しました: "+r;break}J(o)}window.enhancedFileUpload=V;window.pauseUpload=Y;window.resumeUpload=$;window.cancelUpload=Q;window.uploadFileResumable=M;
