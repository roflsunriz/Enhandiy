<?php

declare(strict_types=1);

/**
 * PHP Uploader Ver.4.3.1 設定ファイル
 *
 * このファイルおよびデータディレクトリは外部からアクセスできないように
 * .htaccess等で保護してください
 */

class config {
    public function index(): array {
        return [
            // 管理者用マスターキー（必ず変更してください）
            'master' => 'CHANGE_THIS_MASTER_KEY',

            // 暗号化・ハッシュ化用キー（必ず変更してください）
            'key' => 'CHANGE_THIS_ENCRYPTION_KEY',

            // セッション用ソルト（必ず変更してください）
            'session_salt' => 'CHANGE_THIS_SESSION_SALT',

            // RESTful API設定
            'api_enabled' => true,   // RESTful API機能の有効/無効
            'api_keys' => [  // 有効なAPIキー（配列で複数設定可能）
                'CHANGE_THIS_API_KEY_1' => [
                    'name' => 'Default API Key',
                    'permissions' => ['read', 'write', 'delete', 'admin'],
                    'expires' => null  // null = 無期限, または 'YYYY-MM-DD HH:mm:ss' 形式
                ]
            ],
            'api_rate_limit' => 100,    // 1時間あたりのリクエスト制限数（0で無制限）

            // アプリケーション設定
            'title' => 'PHP Uploader',
            // アップローダ説明（任意）：空のままなら表示しない
            'uploader_info' => [
                'title' => 'example title',
                'description' => 'example description',
                'url' => 'https://example.com'
            ],
            'save_max_files' => 2000,  // 制限値を増加
            'max_comment' => 1024,     // 制限値を増加
            'max_file_size' => 100, // MB
            
            // DLキーの必須設定（DELキーはシステムレベルで常に必須のため設定を廃止）
            'dlkey_required' => false,  // true: 必須, false: 任意
            // 削除セキュリティポリシー（Ver 3.0+）
            'deletion_security' => [
                'auth_mode' => 'key_or_master',   // 'key_or_master': 削除キーまたはマスターキーで削除可能
                'bulk_delete_enabled' => true,    // 一括削除機能の有効/無効（マスターキーのみ）
                'max_bulk_delete_files' => 100,   // 一括削除の最大ファイル数
                'require_confirmation' => true,   // 削除確認ダイアログ必須
                'individual_delete_enabled' => true // 個別削除キーサポート
            ],
            
            // アップロード方式設定
            'upload_method_priority' => 'resumable', // 'resumable': 再開優先, 'normal': 通常優先
            'upload_fallback_enabled' => true,       // フォールバック機能の有効/無効

            // フォルダ構造管理機能
            'folders_enabled' => true,   // フォルダ機能の有効/無効
            'max_folder_depth' => 5,      // 最大フォルダ階層深さ（1-10）
            'max_folders_per_level' => 50,   // 各階層での最大フォルダ数
            'allow_folder_creation' => true, // ユーザーによるフォルダ作成許可
            'allow_folder_deletion' => true, // ユーザーによるフォルダ削除許可

            // ファイル差し替え・編集機能
            'allow_file_replace' => true,   // ファイル差し替え機能の有効/無効
            'allow_comment_edit' => true,   // コメント編集機能の有効/無効
            'file_edit_admin_only' => false, // true: 管理者のみ編集可能, false: 誰でも編集可能
            // 注意: 差し替えキーはシステムレベルで必須のため設定項目はありません

            // ディレクトリ設定（アプリケーションルート直下を参照）
            'db_directory' => $this->getAppRoot() . '/db',
            'data_directory' => $this->getAppRoot() . '/data',
            'log_directory' => $this->getAppRoot() . '/storage/logs',

            // セキュリティ設定
            'security' => [
                'csrf_token_expiry' => 30, // 分
                'min_key_length' => 4,
                'log_ip_address' => true,
                'max_login_attempts' => 5,
                'lockout_duration' => 900, // 15分

                // HTTPS設定
                'enforce_https' => true,    // HTTPSを強制（サーバーがHTTPS対応時のみ）
                'auto_detect_https' => true, // HTTPS対応の自動検出

                // ファイルアップロード制限
                'max_uploads_per_hour' => 50,      // 1時間あたりの最大アップロード数
                'max_concurrent_uploads' => 5,     // 同時並行アップロード数
                'max_file_size_per_ip' => 1000,    // IPあたりの1時間最大アップロードサイズ（MB）
                'cleanup_interval' => 3600         // レート制限データクリーンアップ間隔（秒）
            ],

            // ログ設定
            'log_level' => 'INFO', // DEBUG, INFO, WARNING, ERROR
            'log_retention_days' => 30,

            // アップロード拡張子ポリシー
            // mode: 'all' | 'whitelist' | 'blacklist'
            //  - all: すべて許可（サイズやMIME等の他チェックは継続）
            //  - whitelist: 許可した拡張子のみ
            //  - blacklist: 拒否した拡張子以外を許可
            'upload_extension_policy' => [
                'mode' => 'all',
                'whitelist' => [
                    // 下記の従来リストをデフォルトの参考として残す
                ],
                'blacklist' => [
                    // 例: セキュリティ観点で拒否したい拡張子
                    'php', 'phtml', 'php3', 'php4', 'php5', 'phar', 'cgi', 'exe', 'bat', 'cmd', 'ps1', 'vbs'
                ],
            ],

            // 互換性のための従来設定（whitelistとして扱う）。新規では未使用。
            'extension' => [
                // アーカイブ・圧縮ファイル
                'zip', 'rar', 'lzh', '7z', 'tar', 'gz', 'bz2', 'xz',
                
                // ドキュメント
                'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx',
                'odt', 'ods', 'odp', 'rtf', 'txt', 'csv',
                
                // 画像
                'jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp',
                'tiff', 'tif', 'ico', 'psd',
                
                // 音声
                'mp3', 'wav', 'aac', 'ogg', 'flac', 'm4a', 'wma',
                
                // 動画
                'mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv', 'webm',
                'm4v', 'mpg', 'mpeg',
                
                // 開発・設定ファイル
                'json', 'xml', 'yaml', 'yml', 'ini', 'conf', 'cfg',
                'sql', 'log', 'md', 'html', 'htm', 'css', 'js',
                
                // プログラミング言語
                'php', 'py', 'rb', 'pl', 'sh', 'bat', 'cmd', 'ps1', 'vbs',
                'c', 'cpp', 'cxx', 'cc', 'h', 'hpp', 'hxx', 'cs', 'java',
                'go', 'rs', 'swift', 'kt', 'scala', 'dart', 'lua', 'r',
                'ts', 'jsx', 'tsx', 'vue', 'svelte', 'm', 'mm',
                
                // 設定・データファイル
                'toml', 'properties', 'env', 'gitignore', 'dockerfile',
                'makefile', 'cmake', 'gradle', 'lock', 'sum', 'mod',
                'editorconfig', 'eslintrc', 'prettierrc', 'babelrc',
                
                // シェル・スクリプト
                'zsh', 'fish', 'awk', 'sed', 'vim', 'vimrc',
                
                // データベース
                'sqlite', 'db', 'sqlite3',
                
                // その他
                'epub', 'mobi', 'azw3', 'fb2'
            ],

            // トークン設定
            'token_expiry_minutes' => 10,

            // バージョン情報（composer.jsonから自動取得）
            'version' => $this->getVersion()
        ];
    }

    /**
     * セキュリティ設定の検証を行う
     */
    public function validateSecurityConfig(): bool
    {
        $config = $this->index();

        // 基本的なセキュリティ設定をチェック
        if (strpos($config['master'], 'CHANGE_THIS') !== false) {
            return false;
        }

        if (strpos($config['key'], 'CHANGE_THIS') !== false) {
            return false;
        }

        if (strpos($config['session_salt'], 'CHANGE_THIS') !== false) {
            return false;
        }

        return true;
    }    
    
    /**
     * 設定の検証を行う
     */
    public function validate(): array
    {
        $errors = [];
        $config = $this->index();

        // 必須設定の確認
        if (
            $config['master'] === 'CHANGE_THIS_MASTER_KEY'
            || $config['master'] === 'CHANGE_THIS_MASTER_KEY_Ver2'
            || strpos($config['master'], 'CHANGE_THIS') !== false
        ) {
            $errors[] = '⚠️ マスターキーを変更してください（セキュリティリスク）';
        }

        if (
            $config['key'] === 'CHANGE_THIS_ENCRYPTION_KEY'
            || $config['key'] === 'CHANGE_THIS_ENCRYPTION_KEY_Ver2'
            || strpos($config['key'], 'CHANGE_THIS') !== false
        ) {
            $errors[] = '⚠️ 暗号化キーを変更してください（セキュリティリスク）';
        }

        if (
            $config['session_salt'] === 'CHANGE_THIS_SESSION_SALT'
            || strpos($config['session_salt'], 'CHANGE_THIS') !== false
        ) {
            $errors[] = '⚠️ セッションソルトを変更してください（セキュリティリスク）';
        }

        // APIキーの検証
        if ($config['api_enabled'] && isset($config['api_keys'])) {
            foreach ($config['api_keys'] as $key => $keyConfig) {
                if (strpos($key, 'CHANGE_THIS') !== false) {
                    $errors[] = '⚠️ APIキーを変更してください（セキュリティリスク）';
                    break;
                }
            }
        }

        // キーの長さ検証
        if (strlen($config['master']) < 16) {
            $errors[] = '⚠️ マスターキーは16文字以上にしてください';
        }

        if (strlen($config['key']) < 32) {
            $errors[] = '⚠️ 暗号化キーは32文字以上にしてください';
        }

        if (strlen($config['session_salt']) < 16) {
            $errors[] = '⚠️ セッションソルトは16文字以上にしてください';
        }

        // ディレクトリの存在確認
        $directories = ['db_directory', 'data_directory', 'log_directory'];
        foreach ($directories as $dir) {
            if (!is_dir($config[$dir])) {
                $errors[] = "{$dir} ディレクトリが存在しません: {$config[$dir]}";
            }
        }

        return $errors;
    }

    /**
     * composer.jsonからバージョン情報を取得
     */
    private function getVersion(): string
    {
        // v4.0.0-roflsunriz: composer.jsonのversionフィールドは削除したため、
        // 固定バージョンを返す。リリース時に手動で更新する。
        return '4.3.1';
    }

    /**
     * アプリケーションルートディレクトリを取得
     */
    private function getAppRoot(): string
    {
        // config.phpの位置（backend/config）から2階層上がアプリケーションルート
        return dirname(__DIR__, 2);
    }
}
