import{r as B,i as D,$ as e,b as c,c as f,h as F,d as m,e as h,f as w,g as v}from"./errorHandling.js";import{p as y,g as M}from"./http.js";let u=null;B(()=>{console.log("File Edit functionality initialized (TypeScript)"),D(),k()});function k(){const n=e("#saveCommentBtn");n&&n.addEventListener("click",L);const s=e("#replaceFileBtn");s&&s.addEventListener("click",T),document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(d=>{d.addEventListener("shown.bs.tab",N)});const a=e("#generateShareLinkBtn");a&&a.addEventListener("click",R);const t=e("#saveShareSettingsBtn");t&&t.addEventListener("click",A),document.querySelectorAll('input[name="shareFormat"]').forEach(d=>{d.addEventListener("change",H)});const o=e("#copyShareUrlBtn");o&&o.addEventListener("click",b);const l=e("#shareMaxDownloads"),p=e("#shareExpiresDays");l&&l.addEventListener("input",x),p&&p.addEventListener("input",x)}function I(n,s,i=""){const a=e("#editFileId"),t=e("#replaceFileId"),r=e("#editFileName"),o=e("#replaceFileName"),l=e("#editComment");a&&(a.value=n),t&&(t.value=n),r&&(r.value=s),o&&(o.value=s),l&&(l.value=i),g("comment-tab","commentTab"),h("editModal")}function C(n,s,i=""){const a=e("#editFileId"),t=e("#replaceFileId"),r=e("#editFileName"),o=e("#replaceFileName"),l=e("#editComment");a&&(a.value=n),t&&(t.value=n),r&&(r.value=s),o&&(o.value=s),l&&(l.value=i),g("comment-tab","commentTab");const p=e("#saveCommentBtn"),d=e("#replaceFileBtn");p&&(p.style.display="inline-block"),d&&(d.style.display="none"),h("editModal")}function _(n,s=""){const i=e("#replaceFileId"),a=e("#editFileName"),t=e("#replaceFileName");i&&(i.value=n),a&&(a.value=s),t&&(t.value=s),g("replace-tab","replaceTab");const r=e("#saveCommentBtn"),o=e("#replaceFileBtn");o&&(o.style.display="inline-block"),r&&(r.style.display="none"),h("editModal")}function E(n,s,i=""){const a=e("#shareFileName"),t=e("#shareFileComment");a&&(a.value=s,a.setAttribute("data-file-id",n)),t&&(t.value=i),q(n),setTimeout(()=>{x()},100);const r=e("#shareResultPanel"),o=e("#regenerateShareLinkBtn"),l=e("#generateShareLinkBtn");r&&(r.style.display="none"),o&&(o.style.display="none"),l&&(l.style.display="inline-block"),h("shareLinkModal")}async function L(){const n=e("#editFileId"),s=e("#editComment");if(!n||!s){c("必要な入力項目が見つかりません。");return}const i=n.value,a=s.value;if(!i){c("ファイルIDが指定されていません。");return}try{const t=new FormData;t.append("file_id",i),t.append("comment",a),t.append("csrf_token",window.config?.csrf_token||"");const r=await y("./app/api/edit-comment.php",t);if(r.success)f("コメントを保存しました。"),F("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(r.error||"コメントの保存に失敗しました。")}catch(t){console.error("コメント保存エラー:",t),c("コメントの保存に失敗しました。")}}async function T(){const n=e("#replaceFileId"),s=e("#replaceFileInput");if(!n||!s){c("必要な入力項目が見つかりません。");return}const i=n.value,a=s.files;if(!i){c("ファイルIDが指定されていません。");return}if(!a||a.length===0){c("差し替えるファイルを選択してください。");return}const t=a[0],r=new FormData;r.append("file",t),r.append("replacekey",document.getElementById("modalReplaceKeyInput")?.value||""),r.append("csrf_token",window.config?.csrf_token||"");try{const o=await y(`./app/api/replace-file.php?id=${encodeURIComponent(i)}`,r);if(o.success)f("ファイルを差し替えました。"),F("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(o.error||"ファイルの差し替えに失敗しました。")}catch(o){console.error("ファイル差し替えエラー:",o),c("ファイルの差し替えに失敗しました。")}}function N(n){const s=n.target,i=m(s,"data-bs-target"),a=e("#saveCommentBtn"),t=e("#replaceFileBtn");i==="#commentTab"?(a&&(a.style.display="inline-block"),t&&(t.style.display="none")):i==="#replaceTab"&&(a&&(a.style.display="none"),t&&(t.style.display="inline-block"))}async function R(){const n=e("#shareFileName"),s=e("#shareMaxDownloads"),i=e("#shareExpiresDays");if(!n){c("ファイル情報が見つかりません。");return}const a=m(n,"data-file-id"),t=s?.value||null,r=i?.value||null;if(!a){c("ファイルIDが見つかりません。");return}const o=e("#generateShareLinkBtn");o&&(o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const l=await y("./app/api/generatesharelink.php",{id:a,max_downloads:t,expires_days:r});if(l.success&&l.data)u=l.data,U(l.data),await b(),f("共有リンクを生成しました。");else throw new Error(l.error||"共有リンクの生成に失敗しました。")}catch(l){console.error("共有リンク生成エラー:",l),c("共有リンクの生成に失敗しました。")}finally{o&&(o.disabled=!1,o.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function U(n){const s=e("#shareMaxDownloads");s&&(s.value=n.max_downloads?.toString()||"");const i=e("#shareExpiresDays");i&&(i.value=n.expires_days?.toString()||"");const a=e("#currentMaxDownloads"),t=e("#currentExpiresDays");if(a){const d=n.max_downloads||"無制限";a.innerHTML=`<strong>最大ダウンロード数:</strong> ${d}`}if(t){const d=n.expires_days||"無期限";t.innerHTML=`<strong>有効期限:</strong> ${d}`}const r=e("#shareResultPanel");r&&(r.style.display="block");const o=e("#regenerateShareLinkBtn"),l=e("#generateShareLinkBtn");o&&(o.style.display="inline-block"),l&&(l.style.display="none");const p=document.querySelector('input[name="shareFormat"][value="url_only"]');p&&(p.checked=!0,S(n))}function H(){u&&S(u)}function S(n){const s=document.querySelector('input[name="shareFormat"]:checked'),i=e("#shareUrl");if(!s||!i)return;const a=s.value;a==="url_only"?i.value=n.urlOnly||n.share_url||"":a==="url_with_comment"&&(i.value=n.urlWithComment||n.share_url_with_comment||"")}function g(n,s){document.querySelectorAll(".nav-link").forEach(t=>{w(t,"active"),m(t,"aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(t=>{w(t,"active"),w(t,"show")});const i=e("#"+n),a=e("#"+s);i&&(v(i,"active"),m(i,"aria-selected","true")),a&&(v(a,"active"),v(a,"show"))}function $(n,s="",i=""){I(n,s,i)}if(typeof window<"u"){const n=window;n.openEditDialog=I,n.editFile=$,n.editComment=C,n.replaceFile=_,n.openShareModal=E}async function q(n){try{const s=await M(`./app/api/generatesharelink.php?id=${encodeURIComponent(n)}`);if(s.success&&s.data){const i=s.data,a=e("#shareMaxDownloads"),t=e("#shareExpiresDays");a&&(a.value=i.max_downloads?.toString()||""),t&&(t.value=i.expires_days?.toString()||""),u={...u,max_downloads:i.max_downloads,expires_days:i.expires_days}}}catch(s){console.error("設定取得エラー:",s)}}async function A(){const n=e("#shareFileName"),s=e("#shareMaxDownloads"),i=e("#shareExpiresDays");if(!n){c("ファイル情報が見つかりません。");return}const a=n.getAttribute("data-file-id")||"",t=s?.value||null,r=i?.value||null,o=e("#saveShareSettingsBtn");o&&(o.disabled=!0,o.innerText="保存中...");try{const l=await y("./app/api/generatesharelink.php",{action:"updateSettings",id:a,max_downloads:t,expires_days:r});if(l.success)f("設定を保存しました。"),u={...u,max_downloads:t?parseInt(t):void 0,expires_days:r?parseInt(r):void 0};else throw new Error(l.error||"設定保存に失敗しました。")}catch(l){console.error("設定保存エラー:",l),c("設定の保存に失敗しました。")}finally{o&&(o.disabled=!1,o.innerText="設定を保存")}}async function b(){const n=e("#shareUrl");if(!n||!n.value){c("コピーする共有内容がありません。");return}try{await navigator.clipboard.writeText(n.value),f("共有内容をクリップボードにコピーしました。")}catch{n.select(),document.execCommand("copy"),f("共有内容をクリップボードにコピーしました。")}}function x(){const n=e("#shareMaxDownloads"),s=e("#shareExpiresDays"),i=e("#currentMaxDownloads"),a=e("#currentExpiresDays");if(i&&n){const t=n.value.trim()||"無制限";i.innerHTML=`<strong>最大ダウンロード数:</strong> ${t}`}if(a&&s){const t=s.value.trim()||"無期限";a.innerHTML=`<strong>有効期限:</strong> ${t} ${t!=="無期限"?"日":""}`}}window.openShareModal=E;
