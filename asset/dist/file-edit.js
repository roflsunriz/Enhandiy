import{r as D,i as M,$ as e,b as c,c as f,h as F,d as m,e as h,f as w,g as v}from"./errorHandling.js";import{g as k,p as y,a as C}from"./http.js";let u=null;D(()=>{console.log("File Edit functionality initialized (TypeScript)"),M(),_()});function _(){const n=e("#saveCommentBtn");n&&n.addEventListener("click",N);const s=e("#replaceFileBtn");s&&s.addEventListener("click",R),document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(p=>{p.addEventListener("shown.bs.tab",U)});const t=e("#generateShareLinkBtn");t&&t.addEventListener("click",H);const a=e("#saveShareSettingsBtn");a&&a.addEventListener("click",P),document.querySelectorAll('input[name="shareFormat"]').forEach(p=>{p.addEventListener("change",q)});const i=e("#copyShareUrlBtn");i&&i.addEventListener("click",B);const o=e("#shareMaxDownloads"),d=e("#shareExpiresDays");o&&o.addEventListener("input",g),d&&d.addEventListener("input",g)}function E(n,s,r=""){const t=e("#editFileId"),a=e("#replaceFileId"),l=e("#editFileName"),i=e("#replaceFileName"),o=e("#editComment");t&&(t.value=n),a&&(a.value=n),l&&(l.value=s),i&&(i.value=s),o&&(o.value=r),x("comment-tab","commentTab"),h("editModal")}function L(n,s,r=""){const t=e("#editFileId"),a=e("#replaceFileId"),l=e("#editFileName"),i=e("#replaceFileName"),o=e("#editComment");t&&(t.value=n),a&&(a.value=n),l&&(l.value=s),i&&(i.value=s),o&&(o.value=r);const d=e("#editReplaceKeyInput");d&&(d.value=""),x("comment-tab","commentTab");const p=e("#saveCommentBtn"),I=e("#replaceFileBtn");p&&(p.style.display="inline-block"),I&&(I.style.display="none"),h("editModal")}function T(n,s=""){const r=e("#replaceFileId"),t=e("#editFileName"),a=e("#replaceFileName");r&&(r.value=n),t&&(t.value=s),a&&(a.value=s),x("replace-tab","replaceTab");const l=e("#saveCommentBtn"),i=e("#replaceFileBtn");i&&(i.style.display="inline-block"),l&&(l.style.display="none"),h("editModal")}function S(n,s,r=""){const t=e("#shareFileName"),a=e("#shareFileComment");t&&(t.value=s,t.setAttribute("data-file-id",n)),a&&(a.value=r),K(n),setTimeout(()=>{g()},100);const l=e("#shareResultPanel"),i=e("#regenerateShareLinkBtn"),o=e("#generateShareLinkBtn");l&&(l.style.display="none"),i&&(i.style.display="none"),o&&(o.style.display="inline-block"),h("shareLinkModal")}async function N(){const n=e("#editFileId"),s=e("#editComment"),r=e("#editReplaceKeyInput");if(!n||!s){c("必要な入力項目が見つかりません。");return}const t=n.value,a=s.value,l=r?.value||"";if(!t){c("ファイルIDが指定されていません。");return}if(!l.trim()){c("差し替えキーが必要です。");return}try{const i=new FormData;i.append("file_id",t),i.append("comment",a),i.append("replace_key",l),i.append("csrf_token",k());const o=await y("./app/api/edit-comment.php",i);if(o.success)f("コメントを保存しました。"),F("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(o.error||"コメントの保存に失敗しました。")}catch(i){console.error("コメント保存エラー:",i),c("コメントの保存に失敗しました。")}}async function R(){const n=e("#replaceFileId"),s=e("#replaceFileInput");if(!n||!s){c("必要な入力項目が見つかりません。");return}const r=n.value,t=s.files;if(!r){c("ファイルIDが指定されていません。");return}if(!t||t.length===0){c("差し替えるファイルを選択してください。");return}const a=t[0],l=new FormData;l.append("file",a),l.append("replacekey",document.getElementById("modalReplaceKeyInput")?.value||""),l.append("csrf_token",window.config?.csrf_token||"");try{const i=await y(`./app/api/replace-file.php?id=${encodeURIComponent(r)}`,l);if(i.success)f("ファイルを差し替えました。"),F("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(i.error||"ファイルの差し替えに失敗しました。")}catch(i){console.error("ファイル差し替えエラー:",i),c("ファイルの差し替えに失敗しました。")}}function U(n){const s=n.target,r=m(s,"data-bs-target"),t=e("#saveCommentBtn"),a=e("#replaceFileBtn");r==="#commentTab"?(t&&(t.style.display="inline-block"),a&&(a.style.display="none")):r==="#replaceTab"&&(t&&(t.style.display="none"),a&&(a.style.display="inline-block"))}async function H(){const n=e("#shareFileName"),s=e("#shareMaxDownloads"),r=e("#shareExpiresDays");if(!n){c("ファイル情報が見つかりません。");return}const t=m(n,"data-file-id"),a=s?.value||null,l=r?.value||null;if(!t){c("ファイルIDが見つかりません。");return}const i=e("#generateShareLinkBtn");i&&(i.disabled=!0,i.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const o=await y("./app/api/generatesharelink.php",{id:t,max_downloads:a,expires_days:l});if(o.success&&o.data)u=o.data,$(o.data),await B(),f("共有リンクを生成しました。");else{const d=o.message||o.error||"共有リンクの生成に失敗しました。";throw new Error(d)}}catch(o){console.error("共有リンク生成エラー:",o);const d=o instanceof Error?o.message:"共有リンクの生成に失敗しました。";c(d)}finally{i&&(i.disabled=!1,i.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function $(n){const s=e("#shareMaxDownloads");s&&(s.value=n.max_downloads?.toString()||"");const r=e("#shareExpiresDays");r&&(r.value=n.expires_days?.toString()||"");const t=e("#currentMaxDownloads"),a=e("#currentExpiresDays");if(t){const p=n.max_downloads||"無制限";t.innerHTML=`<strong>最大ダウンロード数:</strong> ${p}`}if(a){const p=n.expires_days||"無期限";a.innerHTML=`<strong>有効期限:</strong> ${p}`}const l=e("#shareResultPanel");l&&(l.style.display="block");const i=e("#regenerateShareLinkBtn"),o=e("#generateShareLinkBtn");i&&(i.style.display="inline-block"),o&&(o.style.display="none");const d=document.querySelector('input[name="shareFormat"][value="url_only"]');d&&(d.checked=!0,b(n))}function q(){u&&b(u)}function b(n){const s=document.querySelector('input[name="shareFormat"]:checked'),r=e("#shareUrl");if(!s||!r)return;const t=s.value;t==="url_only"?r.value=n.urlOnly||n.share_url||"":t==="url_with_comment"&&(r.value=n.urlWithComment||n.share_url_with_comment||"")}function x(n,s){document.querySelectorAll(".nav-link").forEach(a=>{w(a,"active"),m(a,"aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(a=>{w(a,"active"),w(a,"show")});const r=e("#"+n),t=e("#"+s);r&&(v(r,"active"),m(r,"aria-selected","true")),t&&(v(t,"active"),v(t,"show"))}function A(n,s="",r=""){E(n,s,r)}if(typeof window<"u"){const n=window;n.openEditDialog=E,n.editFile=A,n.editComment=L,n.replaceFile=T,n.openShareModal=S}async function K(n){try{const s=await C(`./app/api/generatesharelink.php?id=${encodeURIComponent(n)}`);if(s.success&&s.data){const r=s.data,t=e("#shareMaxDownloads"),a=e("#shareExpiresDays");t&&(t.value=r.max_downloads?.toString()||""),a&&(a.value=r.expires_days?.toString()||""),u={...u,max_downloads:r.max_downloads,expires_days:r.expires_days}}}catch(s){console.error("設定取得エラー:",s)}}async function P(){const n=e("#shareFileName"),s=e("#shareMaxDownloads"),r=e("#shareExpiresDays");if(!n){c("ファイル情報が見つかりません。");return}const t=n.getAttribute("data-file-id")||"",a=s?.value||null,l=r?.value||null,i=e("#saveShareSettingsBtn");i&&(i.disabled=!0,i.innerText="保存中...");try{const o=await y("./app/api/generatesharelink.php",{action:"updateSettings",id:t,max_downloads:a,expires_days:l});if(o.success)f("設定を保存しました。"),u={...u,max_downloads:a?parseInt(a):void 0,expires_days:l?parseInt(l):void 0};else throw new Error(o.error||"設定保存に失敗しました。")}catch(o){console.error("設定保存エラー:",o),c("設定の保存に失敗しました。")}finally{i&&(i.disabled=!1,i.innerText="設定を保存")}}async function B(){const n=e("#shareUrl");if(!n||!n.value){c("コピーする共有内容がありません。");return}try{await navigator.clipboard.writeText(n.value),f("共有内容をクリップボードにコピーしました。")}catch{n.select(),document.execCommand("copy"),f("共有内容をクリップボードにコピーしました。")}}function g(){const n=e("#shareMaxDownloads"),s=e("#shareExpiresDays"),r=e("#currentMaxDownloads"),t=e("#currentExpiresDays");if(r&&n){const a=n.value.trim()||"無制限";r.innerHTML=`<strong>最大ダウンロード数:</strong> ${a}`}if(t&&s){const a=s.value.trim()||"無期限";t.innerHTML=`<strong>有効期限:</strong> ${a} ${a!=="無期限"?"日":""}`}}window.openShareModal=S;
