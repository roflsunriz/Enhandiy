import{r as b,i as E,$ as e,a as c,b as y,c as u,t as d,d as f,e as h}from"./errorHandling.js";import{p as F}from"./http.js";import{h as w,s as m}from"./bootstrap.js";b(()=>{console.log("File Edit functionality initialized (TypeScript)"),E(),B()});function B(){const t=e("#saveCommentBtn");t&&t.addEventListener("click",x);const l=e("#replaceFileBtn");l&&l.addEventListener("click",M),document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(r=>{r.addEventListener("shown.bs.tab",D)});const n=e("#generateShareLinkBtn");n&&n.addEventListener("click",L),document.querySelectorAll('input[name="shareFormat"]').forEach(r=>{r.addEventListener("change",N)})}function g(t,l,i=""){const n=e("#editFileId"),a=e("#replaceFileId"),r=e("#editFileName"),o=e("#replaceFileName"),s=e("#editComment");n&&(n.value=t),a&&(a.value=t),r&&d(r,l),o&&d(o,l),s&&(s.value=i),v("comment-tab","commentTab"),m("editModal")}function k(t,l,i=""){const n=e("#editFileId"),a=e("#replaceFileId"),r=e("#editFileName"),o=e("#replaceFileName"),s=e("#editComment");n&&(n.value=t),a&&(a.value=t),r&&d(r,l),o&&d(o,l),s&&(s.value=i),v("comment-tab","commentTab");const p=e("#saveCommentBtn"),I=e("#replaceFileBtn");p&&(p.style.display="inline-block"),I&&(I.style.display="none"),m("editModal")}function C(t,l=""){const i=e("#replaceFileId"),n=e("#editFileName"),a=e("#replaceFileName");i&&(i.value=t),n&&d(n,l),a&&d(a,l),v("replace-tab","replaceTab");const r=e("#saveCommentBtn"),o=e("#replaceFileBtn");o&&(o.style.display="inline-block"),r&&(r.style.display="none"),m("editModal")}function S(t,l=""){const i=e("#shareFileName"),n=e("#shareFileComment");i&&(i.value=t),n&&(n.value=l);const a=e("#shareMaxDownloads"),r=e("#shareExpiresDays");a&&(a.value=""),r&&(r.value="");const o=e("#shareResultPanel"),s=e("#regenerateShareLinkBtn"),p=e("#generateShareLinkBtn");o&&(o.style.display="none"),s&&(s.style.display="none"),p&&(p.style.display="inline-block"),m("shareLinkModal")}async function x(){const t=e("#editFileId"),l=e("#editComment");if(!t||!l){c("必要な入力項目が見つかりません。");return}const i=t.value,n=l.value;if(!i){c("ファイルIDが指定されていません。");return}try{const a=await F("/api/edit-comment.php",{fileId:i,comment:n});if(a.success)y("コメントを保存しました。"),w("editModal"),window.location.reload();else throw new Error(a.error||"コメントの保存に失敗しました。")}catch(a){console.error("コメント保存エラー:",a),c("コメントの保存に失敗しました。")}}async function M(){const t=e("#replaceFileId"),l=e("#replaceFileInput");if(!t||!l){c("必要な入力項目が見つかりません。");return}const i=t.value,n=l.files;if(!i){c("ファイルIDが指定されていません。");return}if(!n||n.length===0){c("差し替えるファイルを選択してください。");return}const a=n[0],r=new FormData;r.append("fileId",i),r.append("file",a);try{const o=await F("/api/replace-file.php",r);if(o.success)y("ファイルを差し替えました。"),w("editModal"),window.location.reload();else throw new Error(o.error||"ファイルの差し替えに失敗しました。")}catch(o){console.error("ファイル差し替えエラー:",o),c("ファイルの差し替えに失敗しました。")}}function D(t){const l=t.target,i=u(l,"data-bs-target"),n=e("#saveCommentBtn"),a=e("#replaceFileBtn");i==="#commentTab"?(n&&(n.style.display="inline-block"),a&&(a.style.display="none")):i==="#replaceTab"&&(n&&(n.style.display="none"),a&&(a.style.display="inline-block"))}async function L(){const t=e("#shareFileName"),l=e("#shareMaxDownloads"),i=e("#shareExpiresDays");if(!t){c("ファイル情報が見つかりません。");return}const n=u(t,"data-file-id"),a=l?.value||null,r=i?.value||null;if(!n){c("ファイルIDが見つかりません。");return}const o=e("#generateShareLinkBtn");o&&(o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const s=await F("/api/generatesharelink.php",{fileId:n,maxDownloads:a,expiresDays:r});if(s.success&&s.data)s.data&&typeof s.data=="object"&&"share_key"in s.data&&T(s.data),y("共有リンクを生成しました。");else throw new Error(s.error||"共有リンクの生成に失敗しました。")}catch(s){console.error("共有リンク生成エラー:",s),c("共有リンクの生成に失敗しました。")}finally{o&&(o.disabled=!1,o.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function T(t){const l=e("#currentMaxDownloads"),i=e("#currentExpiresDays");if(l){const s=t.max_downloads||"無制限";l.innerHTML=`<strong>最大ダウンロード数:</strong> ${s}`}if(i){const s=t.expires_days||"無期限";i.innerHTML=`<strong>有効期限:</strong> ${s}`}const n=e("#shareResultPanel");n&&(n.style.display="block");const a=e("#regenerateShareLinkBtn"),r=e("#generateShareLinkBtn");a&&(a.style.display="inline-block"),r&&(r.style.display="none");const o=document.querySelector('input[name="shareFormat"][value="url_only"]');o&&(o.checked=!0,_(t))}function N(){}function _(t){const l=document.querySelector('input[name="shareFormat"]:checked'),i=e("#shareUrl");if(!l||!i)return;const n=l.value;n==="url_only"?i.value=t.urlOnly||t.share_url||"":n==="url_with_comment"&&(i.value=t.urlWithComment||t.share_url_with_comment||"")}function v(t,l){document.querySelectorAll(".nav-link").forEach(a=>{f(a,"active"),u(a,"aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(a=>{f(a,"active"),f(a,"show")});const i=e("#"+t),n=e("#"+l);i&&(h(i,"active"),u(i,"aria-selected","true")),n&&(h(n,"active"),h(n,"show"))}function R(t,l="",i=""){g(t,l,i)}if(typeof window<"u"){const t=window;t.openEditDialog=g,t.editFile=R,t.editComment=k,t.replaceFile=C,t.openShareModal=S}
