import{r as E,i as k,$ as t,b as c,c as u,h as x,d as h,t as m,e as y,f as F,g as w}from"./errorHandling.js";import{p as v,g as C}from"./http.js";let d=null;E(()=>{console.log("File Edit functionality initialized (TypeScript)"),k(),_()});function _(){const e=t("#saveCommentBtn");e&&e.addEventListener("click",L);const i=t("#replaceFileBtn");i&&i.addEventListener("click",T),document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(r=>{r.addEventListener("shown.bs.tab",N)});const n=t("#generateShareLinkBtn");n&&n.addEventListener("click",R);const a=t("#saveShareSettingsBtn");a&&a.addEventListener("click",P),document.querySelectorAll('input[name="shareFormat"]').forEach(r=>{r.addEventListener("change",q)});const o=t("#copyShareUrlBtn");o&&o.addEventListener("click",B)}function I(e,i,s=""){const n=t("#editFileId"),a=t("#replaceFileId"),l=t("#editFileName"),o=t("#replaceFileName"),r=t("#editComment");n&&(n.value=e),a&&(a.value=e),l&&m(l,i),o&&m(o,i),r&&(r.value=s),g("comment-tab","commentTab"),y("editModal")}function M(e,i,s=""){const n=t("#editFileId"),a=t("#replaceFileId"),l=t("#editFileName"),o=t("#replaceFileName"),r=t("#editComment");n&&(n.value=e),a&&(a.value=e),l&&m(l,i),o&&m(o,i),r&&(r.value=s),g("comment-tab","commentTab");const f=t("#saveCommentBtn"),p=t("#replaceFileBtn");f&&(f.style.display="inline-block"),p&&(p.style.display="none"),y("editModal")}function D(e,i=""){const s=t("#replaceFileId"),n=t("#editFileName"),a=t("#replaceFileName");s&&(s.value=e),n&&m(n,i),a&&m(a,i),g("replace-tab","replaceTab");const l=t("#saveCommentBtn"),o=t("#replaceFileBtn");o&&(o.style.display="inline-block"),l&&(l.style.display="none"),y("editModal")}function S(e,i,s=""){const n=t("#shareFileName"),a=t("#shareFileComment");n&&(n.value=i,n.setAttribute("data-file-id",e)),a&&(a.value=s),H(e);const l=t("#shareResultPanel"),o=t("#regenerateShareLinkBtn"),r=t("#generateShareLinkBtn");l&&(l.style.display="none"),o&&(o.style.display="none"),r&&(r.style.display="inline-block"),y("shareLinkModal")}async function L(){const e=t("#editFileId"),i=t("#editComment");if(!e||!i){c("必要な入力項目が見つかりません。");return}const s=e.value,n=i.value;if(!s){c("ファイルIDが指定されていません。");return}try{const a=await v("/api/edit-comment.php",{fileId:s,comment:n});if(a.success)u("コメントを保存しました。"),x("editModal"),window.location.reload();else throw new Error(a.error||"コメントの保存に失敗しました。")}catch(a){console.error("コメント保存エラー:",a),c("コメントの保存に失敗しました。")}}async function T(){const e=t("#replaceFileId"),i=t("#replaceFileInput");if(!e||!i){c("必要な入力項目が見つかりません。");return}const s=e.value,n=i.files;if(!s){c("ファイルIDが指定されていません。");return}if(!n||n.length===0){c("差し替えるファイルを選択してください。");return}const a=n[0],l=new FormData;l.append("fileId",s),l.append("file",a);try{const o=await v("/api/replace-file.php",l);if(o.success)u("ファイルを差し替えました。"),x("editModal"),window.location.reload();else throw new Error(o.error||"ファイルの差し替えに失敗しました。")}catch(o){console.error("ファイル差し替えエラー:",o),c("ファイルの差し替えに失敗しました。")}}function N(e){const i=e.target,s=h(i,"data-bs-target"),n=t("#saveCommentBtn"),a=t("#replaceFileBtn");s==="#commentTab"?(n&&(n.style.display="inline-block"),a&&(a.style.display="none")):s==="#replaceTab"&&(n&&(n.style.display="none"),a&&(a.style.display="inline-block"))}async function R(){const e=t("#shareFileName"),i=t("#shareMaxDownloads"),s=t("#shareExpiresDays");if(!e){c("ファイル情報が見つかりません。");return}const n=h(e,"data-file-id"),a=i?.value||null,l=s?.value||null;if(!n){c("ファイルIDが見つかりません。");return}const o=t("#generateShareLinkBtn");o&&(o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const r=await v("./app/api/generatesharelink.php",{id:n,max_downloads:a,expires_days:l});if(r.success&&r.data)d=r.data,U(r.data),await B(),u("共有リンクを生成しました。");else throw new Error(r.error||"共有リンクの生成に失敗しました。")}catch(r){console.error("共有リンク生成エラー:",r),c("共有リンクの生成に失敗しました。")}finally{o&&(o.disabled=!1,o.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function U(e){const i=t("#shareMaxDownloads");i&&(i.value=e.max_downloads?.toString()||"");const s=t("#shareExpiresDays");s&&(s.value=e.expires_days?.toString()||"");const n=t("#currentMaxDownloads"),a=t("#currentExpiresDays");if(n){const p=e.max_downloads||"無制限";n.innerHTML=`<strong>最大ダウンロード数:</strong> ${p}`}if(a){const p=e.expires_days||"無期限";a.innerHTML=`<strong>有効期限:</strong> ${p}`}const l=t("#shareResultPanel");l&&(l.style.display="block");const o=t("#regenerateShareLinkBtn"),r=t("#generateShareLinkBtn");o&&(o.style.display="inline-block"),r&&(r.style.display="none");const f=document.querySelector('input[name="shareFormat"][value="url_only"]');f&&(f.checked=!0,b(e))}function q(){d&&b(d)}function b(e){const i=document.querySelector('input[name="shareFormat"]:checked'),s=t("#shareUrl");if(!i||!s)return;const n=i.value;n==="url_only"?s.value=e.urlOnly||e.share_url||"":n==="url_with_comment"&&(s.value=e.urlWithComment||e.share_url_with_comment||"")}function g(e,i){document.querySelectorAll(".nav-link").forEach(a=>{F(a,"active"),h(a,"aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(a=>{F(a,"active"),F(a,"show")});const s=t("#"+e),n=t("#"+i);s&&(w(s,"active"),h(s,"aria-selected","true")),n&&(w(n,"active"),w(n,"show"))}function A(e,i="",s=""){I(e,i,s)}if(typeof window<"u"){const e=window;e.openEditDialog=I,e.editFile=A,e.editComment=M,e.replaceFile=D,e.openShareModal=S}async function H(e){try{const i=await C(`/app/api/generatesharelink.php?id=${encodeURIComponent(e)}`);if(i.success&&i.data){const s=i.data,n=t("#shareMaxDownloads"),a=t("#shareExpiresDays");n&&(n.value=s.max_downloads?.toString()||""),a&&(a.value=s.expires_days?.toString()||""),d={...d,max_downloads:s.max_downloads,expires_days:s.expires_days}}}catch(i){console.error("設定取得エラー:",i)}}async function P(){const e=t("#shareFileName"),i=t("#shareMaxDownloads"),s=t("#shareExpiresDays");if(!e){c("ファイル情報が見つかりません。");return}const n=e.getAttribute("data-file-id")||"",a=i?.value||null,l=s?.value||null,o=t("#saveShareSettingsBtn");o&&(o.disabled=!0,o.innerText="保存中...");try{const r=await v("./app/api/generatesharelink.php",{action:"updateSettings",id:n,max_downloads:a,expires_days:l});if(r.success)u("設定を保存しました。"),d={...d,max_downloads:a?parseInt(a):void 0,expires_days:l?parseInt(l):void 0};else throw new Error(r.error||"設定保存に失敗しました。")}catch(r){console.error("設定保存エラー:",r),c("設定の保存に失敗しました。")}finally{o&&(o.disabled=!1,o.innerText="設定を保存")}}async function B(){const e=t("#shareUrl");if(!e||!e.value){c("コピーする共有内容がありません。");return}try{await navigator.clipboard.writeText(e.value),u("共有内容をクリップボードにコピーしました。")}catch{e.select(),document.execCommand("copy"),u("共有内容をクリップボードにコピーしました。")}}window.openShareModal=S;
