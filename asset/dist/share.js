import{r as m,i as y,$ as e,b as w,c,d as u}from"./errorHandling.js";import{p as g}from"./http.js";import{b as x}from"./modal.js";m(()=>{console.log("Share functionality initialized (TypeScript)"),y(),S()});function S(){const n=e("#shareMaxDownloads"),r=e("#shareExpiresDays");if(!n||!r)return;const a=e("#generateShareLinkBtn");a&&a.addEventListener("click",p),document.querySelectorAll('input[name="shareFormat"]').forEach(o=>{o.addEventListener("change",f)});const i=e("#regenerateShareLinkBtn");i&&i.addEventListener("click",L)}async function p(){const n=w(e("#shareFileName"),"data-file-id");if(!n){c("ファイルIDが見つかりません。");return}const r=e("#shareMaxDownloads"),a=e("#shareExpiresDays"),s=r?.value||"",i=a?.value||"",o=e("#generateShareLinkBtn");o&&(o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const t=await g("./app/api/generatesharelink.php",{id:n,max_downloads:s,expires_days:i});if(t.success&&t.data)t.data&&typeof t.data=="object"&&"share_key"in t.data&&k(t.data),u("共有リンクを生成しました。");else throw new Error(t.error||"共有リンクの生成に失敗しました。")}catch(t){console.error("共有リンク生成エラー:",t),c("共有リンクの生成に失敗しました。")}finally{o&&(o.disabled=!1,o.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function k(n){const r=e("#shareUrlInput"),a=e("#shareUrlWithCommentInput");r&&(r.value=n.share_url||""),a&&(a.value=n.share_url_with_comment||"");const s=e("#currentMaxDownloads"),i=e("#currentExpiresDays");if(s){const l=n.max_downloads||"無制限";s.innerHTML=`<strong>最大ダウンロード数:</strong> ${l}`}if(i){const l=n.expires_days||"無期限";i.innerHTML=`<strong>有効期限:</strong> ${l}`}const o=e("#shareResultPanel");o&&(o.style.display="block");const t=e("#regenerateShareLinkBtn"),h=e("#generateShareLinkBtn");t&&(t.style.display="inline-block"),h&&(h.style.display="none");const d=document.querySelector('input[name="shareFormat"][value="url_only"]');d&&(d.checked=!0,f())}function f(){const n=document.querySelector('input[name="shareFormat"]:checked'),r=e("#shareUrl"),a=e("#shareUrlInput"),s=e("#shareUrlWithCommentInput");if(!n||!r)return;const i=n.value;i==="url_only"&&a?r.value=a.value:i==="url_with_comment"&&s&&(r.value=s.value)}async function L(){await x("既存の共有リンクは無効になります。新しい共有リンクを生成しますか？")&&await p()}function v(){const n=e("#shareLinkForm");n&&n.reset();const r=e("#shareResultPanel");r&&(r.style.display="none");const a=e("#regenerateShareLinkBtn"),s=e("#generateShareLinkBtn");a&&(a.style.display="none"),s&&(s.style.display="inline-block")}async function U(){const n=e("#shareUrl");if(!n||!n.value){c("コピーする共有URLがありません。");return}try{await navigator.clipboard.writeText(n.value),u("共有URLをクリップボードにコピーしました。")}catch{n.select(),document.execCommand("copy"),u("共有URLをクリップボードにコピーしました。")}}typeof window<"u"&&(window.copyShareUrl=U,window.resetShareModal=v);
