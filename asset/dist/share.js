import{r as m,i as y,$ as n,a as g,s as c,p as w,b as u}from"./errorHandling.js";m(()=>{console.log("Share functionality initialized (TypeScript)"),y(),S()});function S(){const e=n("#generateShareLinkBtn");e&&e.addEventListener("click",p),document.querySelectorAll('input[name="shareFormat"]').forEach(a=>{a.addEventListener("change",f)});const t=n("#regenerateShareLinkBtn");t&&t.addEventListener("click",L)}async function p(){const e=g(n("#shareFileName"),"data-file-id");if(!e){c("ファイルIDが見つかりません。");return}const r=n("#maxDownloadsInput"),t=n("#expiresInput"),a=r?.value||"",i=t?.value||"",o=n("#generateShareLinkBtn");o&&(o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const s=await w("/api/generatesharelink.php",{fileId:e,maxDownloads:a,expires:i});if(s.success&&s.data)s.data&&typeof s.data=="object"&&"share_key"in s.data&&k(s.data),u("共有リンクを生成しました。");else throw new Error(s.error||"共有リンクの生成に失敗しました。")}catch(s){console.error("共有リンク生成エラー:",s),c("共有リンクの生成に失敗しました。")}finally{o&&(o.disabled=!1,o.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function k(e){const r=n("#shareUrlInput"),t=n("#shareUrlWithCommentInput");r&&(r.value=e.share_url||""),t&&(t.value=e.share_url_with_comment||"");const a=n("#currentMaxDownloads"),i=n("#currentExpiresDays");if(a){const l=e.max_downloads||"無制限";a.innerHTML=`<strong>最大ダウンロード数:</strong> ${l}`}if(i){const l=e.expires_days||"無期限";i.innerHTML=`<strong>有効期限:</strong> ${l}`}const o=n("#shareResultPanel");o&&(o.style.display="block");const s=n("#regenerateShareLinkBtn"),h=n("#generateShareLinkBtn");s&&(s.style.display="inline-block"),h&&(h.style.display="none");const d=document.querySelector('input[name="shareFormat"][value="url_only"]');d&&(d.checked=!0,f())}function f(){const e=document.querySelector('input[name="shareFormat"]:checked'),r=n("#shareUrl"),t=n("#shareUrlInput"),a=n("#shareUrlWithCommentInput");if(!e||!r)return;const i=e.value;i==="url_only"&&t?r.value=t.value:i==="url_with_comment"&&a&&(r.value=a.value)}async function L(){confirm("既存の共有リンクは無効になります。新しい共有リンクを生成しますか？")&&await p()}function x(){const e=n("#shareLinkForm");e&&e.reset();const r=n("#shareResultPanel");r&&(r.style.display="none");const t=n("#regenerateShareLinkBtn"),a=n("#generateShareLinkBtn");t&&(t.style.display="none"),a&&(a.style.display="inline-block")}async function v(){const e=n("#shareUrl");if(!e||!e.value){c("コピーする共有URLがありません。");return}try{await navigator.clipboard.writeText(e.value),u("共有URLをクリップボードにコピーしました。")}catch{e.select(),document.execCommand("copy"),u("共有URLをクリップボードにコピーしました。")}}typeof window<"u"&&(window.copyShareUrl=v,window.resetShareModal=x);
