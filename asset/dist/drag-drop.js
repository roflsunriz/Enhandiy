import{r as F,i as E,$ as r,d as g,c as v}from"./errorHandling.js";let d=[],p=!1;F(()=>{console.log("Drag & Drop functionality initialized (TypeScript)"),E(),x()});function x(){const e=r("#dragDropArea"),t=r("#selectFilesBtn"),s=r("#selectFolderBtn"),i=r("#multipleFileInput"),c=r("#folderInput"),n=r("#clearFilesBtn");if(!e){console.warn("Drag drop area not found");return}e.addEventListener("dragover",L),e.addEventListener("dragenter",B),e.addEventListener("dragleave",C),e.addEventListener("drop",S),t&&t.addEventListener("click",()=>{p||i?.click()}),e.addEventListener("click",o=>{if(p)return;o.target.tagName!=="BUTTON"&&i?.click()}),s&&s.addEventListener("click",()=>{p||c?.click()}),i&&i.addEventListener("change",o=>{const a=o.target;a.files&&u(a.files)}),c&&c.addEventListener("change",o=>{const a=o.target;a.files&&u(a.files)}),n&&n.addEventListener("click",()=>{p||h()}),document.addEventListener("click",o=>{if(o.target.id==="uploadBtn"){if(o.preventDefault(),o.stopPropagation(),console.log("Upload button clicked, selectedFiles:",d.length),typeof window.enhancedFileUpload=="function")console.log("Using enhanced file upload"),window.enhancedFileUpload();else if(console.log("Using traditional upload"),d.length>0)k();else{const l=r("#multipleFileInput");l?.files&&l.files.length>0?I(l.files[0]):alert("ファイルが選択されていません。")}return!1}})}function L(e){e.preventDefault(),e.stopPropagation(),g(e.currentTarget,"drag-over")}function B(e){e.preventDefault(),e.stopPropagation(),g(e.currentTarget,"drag-over")}function C(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget;t.contains(e.relatedTarget)||v(t,"drag-over")}function S(e){if(e.preventDefault(),e.stopPropagation(),v(e.currentTarget,"drag-over"),p)return;const t=e.dataTransfer?.files;t&&u(t)}function u(e){if(!(!e||e.length===0)){for(let t=0;t<e.length;t++){const s=e[t];d.some(c=>c.name===s.name&&c.size===s.size&&c.lastModified===s.lastModified)||d.push(s)}m(),M()}}function m(){const e=r("#selectedFilesList");if(!e)return;e.innerHTML="",d.forEach((n,o)=>{const a=document.createElement("div");a.className="file-item",a.dataset.filename=n.name;const l=T(n.name),f=n.name,y=U(n.size);a.innerHTML=`
      <div class="upload-method-indicator" style="display: none;"></div>
      <span class="file-icon">${l}</span>
      <div class="file-info">
        <span class="file-name">${q(f)}</span>
        <span class="file-size">${y}</span>
      </div>
      <div class="upload-controls">
        <button type="button" class="upload-control-btn pause" title="一時停止" style="display: none;">
          <span class="glyphicon glyphicon-pause"></span>
        </button>
        <button type="button" class="upload-control-btn resume" title="再開" style="display: none;">
          <span class="glyphicon glyphicon-play"></span>
        </button>
        <button type="button" class="upload-control-btn cancel" title="キャンセル" style="display: none;">
          <span class="glyphicon glyphicon-stop"></span>
        </button>
      </div>
      <button type="button" class="file-remove" data-index="${o}">
        <span class="glyphicon glyphicon-remove"></span>
      </button>
      <div class="upload-progress" style="display: none;">
        <div class="upload-progress-bar"></div>
      </div>
      <div class="upload-status" style="display: none;"></div>
      <div class="detailed-progress" style="display: none;">
        <div class="progress-text">
          <span class="progress-percentage">0%</span>
          <span class="progress-size">0B / ${y}</span>
        </div>
        <div class="speed-info">速度: 計算中...</div>
      </div>
    `,e.appendChild(a)}),e.querySelectorAll(".file-remove").forEach(n=>{n.addEventListener("click",o=>{if(p)return;const a=o.currentTarget,l=parseInt(a.dataset.index||"0");d.splice(l,1),m(),d.length===0&&w()})}),e.querySelectorAll(".upload-control-btn.pause").forEach(n=>{n.addEventListener("click",o=>{const l=o.currentTarget.closest(".file-item").dataset.filename;l&&typeof window.pauseUpload=="function"&&window.pauseUpload(l)})}),e.querySelectorAll(".upload-control-btn.resume").forEach(n=>{n.addEventListener("click",o=>{const l=o.currentTarget.closest(".file-item").dataset.filename;l&&typeof window.resumeUpload=="function"&&window.resumeUpload(l)})}),e.querySelectorAll(".upload-control-btn.cancel").forEach(n=>{n.addEventListener("click",o=>{const l=o.currentTarget.closest(".file-item").dataset.filename;l&&typeof window.cancelUpload=="function"&&window.cancelUpload(l)})})}function T(e){const t=e.split(".").pop()?.toLowerCase()||"";return{jpg:"🖼️",jpeg:"🖼️",png:"🖼️",gif:"🖼️",bmp:"🖼️",svg:"🖼️",webp:"🖼️",mp4:"🎬",avi:"🎬",mov:"🎬",wmv:"🎬",flv:"🎬",mkv:"🎬",webm:"🎬",mp3:"🎵",wav:"🎵",aac:"🎵",ogg:"🎵",flac:"🎵",m4a:"🎵",wma:"🎵",pdf:"📄",doc:"📝",docx:"📝",xls:"📊",xlsx:"📊",ppt:"📊",pptx:"📊",zip:"🗜️",rar:"🗜️",lzh:"🗜️","7z":"🗜️",tar:"🗜️",gz:"🗜️",html:"🌐",css:"🎨",js:"⚙️",json:"⚙️",xml:"⚙️",sql:"🗃️"}[t]||"📎"}function U(e){if(e===0)return"0 Bytes";const t=1024,s=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(1))+" "+s[i]}function M(){const e=r("#selectedFilesContainer");e&&(e.style.display="block",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.transition="all 0.3s ease",e.style.opacity="1",e.style.transform="translateY(0)"},10))}function w(){const e=r("#selectedFilesContainer");e&&(e.style.transition="all 0.3s ease",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.display="none"},300))}function h(){d=[],m(),w();const e=r("#multipleFileInput"),t=r("#folderInput");e&&(e.value=""),t&&(t.value="")}function k(){if(d.length===0){alert("ファイルが選択されていません。");return}if(p){alert("アップロード中です。しばらくお待ちください。");return}p=!0;const e=r("#errorContainer"),t=r("#uploadContainer");e&&(e.style.display="none"),t&&(t.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(i=>{i.style.display="block"}),b(0)}async function b(e){if(e>=d.length){p=!1;const n=r("#uploadContainer");n&&(n.style.display="none"),window.location.reload();return}const t=d[e],i=document.querySelectorAll(".file-item")[e],c=i.querySelector(".upload-progress-bar");try{const n=D();await I(t,n,c),c&&(c.style.width="100%"),i.style.backgroundColor="#d4edda",setTimeout(()=>{b(e+1)},500)}catch(n){z(n,t.name),p=!1;const a=r("#uploadContainer");a&&(a.style.display="none")}}async function I(e,t,s){return new Promise((i,c)=>{const n=new FormData;n.append("file",e);const o=t||D();n.append("comment",o.comment||""),n.append("dlkey",o.dlkey||""),n.append("delkey",o.delkey||""),n.append("replacekey",o.replacekey||""),o.maxDownloads&&o.maxDownloads>0&&n.append("max_downloads",o.maxDownloads.toString()),o.expiresDays&&o.expiresDays>0&&n.append("expires_days",o.expiresDays.toString());const a=new XMLHttpRequest;s&&a.upload&&a.upload.addEventListener("progress",l=>{if(l.lengthComputable){const f=Math.round(l.loaded/l.total*100);s.style.width=f+"%"}}),a.addEventListener("load",()=>{try{const l=JSON.parse(a.responseText);l.status==="ok"?i():c(l)}catch{c({status:"network_error",message:"レスポンスの解析に失敗しました"})}}),a.addEventListener("error",()=>{c({status:"network_error",message:"ネットワークエラーが発生しました"})}),a.open("POST","./app/api/upload.php"),a.send(n)})}function D(){const e=r("#commentInput"),t=r("#dleyInput"),s=r("#deleyInput"),i=r("#replaceKeyInput"),c=r("#maxDownloadsUploadInput"),n=r("#expiresDaysUploadInput");return{comment:e?.value||"",dlkey:t?.value||"",delkey:s?.value||"",replacekey:i?.value||"",maxDownloads:c&&parseInt(c.value)||void 0,expiresDays:n&&parseInt(n.value)||void 0}}function z(e,t){let s="";switch(e.status){case"filesize_over":s="ファイル容量が大きすぎます: "+t;break;case"extension_error":s="許可されていない拡張子です: "+t+" (拡張子: "+e.ext+")";break;case"comment_error":s="コメントの文字数が規定数を超えています。";break;case"dlkey_required":s="DLキーは必須入力です。";break;case"delkey_required":s="DELキーは必須入力です。";break;case"sqlwrite_error":s="データベースの書き込みに失敗しました: "+t;break;case"network_error":s=e.message+": "+t;break;default:s="アップロードに失敗しました: "+t;break}const i=r("#errorContainer"),c=i?.querySelector(".panel-body");c&&(c.textContent=s),i&&(i.style.display="block")}function q(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}window.selectedFiles=d;window.isUploading=p;window.handleFiles=u;window.uploadMultipleFiles=k;window.clearSelectedFiles=h;
