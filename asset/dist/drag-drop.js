import{r as L,i as x,$ as l,g as w,f as h}from"./errorHandling.js";import{a as g}from"./modal.js";let d=[],p=!1;L(()=>{console.log("Drag & Drop functionality initialized (TypeScript)"),x(),E()});function E(){const e=l("#dragDropArea"),t=l("#selectFilesBtn"),s=l("#selectFolderBtn"),r=l("#multipleFileInput"),c=l("#folderInput"),o=l("#clearFilesBtn");if(!e){console.warn("Drag drop area not found");return}e.addEventListener("dragover",B),e.addEventListener("dragenter",C),e.addEventListener("dragleave",S),e.addEventListener("drop",M),t&&t.addEventListener("click",()=>{p||r?.click()}),e.addEventListener("click",n=>{if(p)return;n.target.tagName!=="BUTTON"&&r?.click()}),s&&s.addEventListener("click",()=>{p||c?.click()}),r&&r.addEventListener("change",n=>{const a=n.target;a.files&&u(a.files)}),c&&c.addEventListener("change",n=>{const a=n.target;a.files&&u(a.files)}),o&&o.addEventListener("click",()=>{p||k()}),document.addEventListener("click",n=>{if(n.target.id==="uploadBtn"){if(n.preventDefault(),n.stopPropagation(),console.log("Upload button clicked, selectedFiles:",d.length),typeof window.enhancedFileUpload=="function")console.log("Using enhanced file upload"),window.enhancedFileUpload();else if(console.log("Using traditional upload"),d.length>0)I();else{const i=l("#multipleFileInput");i?.files&&i.files.length>0?F(i.files[0]):g("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")}return!1}})}function B(e){e.preventDefault(),e.stopPropagation(),w(e.currentTarget,"drag-over")}function C(e){e.preventDefault(),e.stopPropagation(),w(e.currentTarget,"drag-over")}function S(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget;t.contains(e.relatedTarget)||h(t,"drag-over")}function M(e){if(e.preventDefault(),e.stopPropagation(),h(e.currentTarget,"drag-over"),p)return;const t=e.dataTransfer?.files;t&&u(t)}function u(e){if(!(!e||e.length===0)){for(let t=0;t<e.length;t++){const s=e[t];d.some(c=>c.name===s.name&&c.size===s.size&&c.lastModified===s.lastModified)||d.push(s)}m(),z()}}function m(){const e=l("#selectedFilesList");if(!e)return;e.innerHTML="",d.forEach((o,n)=>{const a=document.createElement("div");a.className="file-item",a.dataset.filename=o.name;const i=T(o.name),f=o.name,v=U(o.size);a.innerHTML=`
      <div class="upload-method-indicator" style="display: none;"></div>
      <span class="file-icon">${i}</span>
      <div class="file-info">
        <span class="file-name">${_(f)}</span>
        <span class="file-size">${v}</span>
      </div>
      <div class="upload-controls">
        <button type="button" class="upload-control-btn pause" title="ä¸€æ™‚åœæ­¢" style="display: none;">
          <span class="glyphicon glyphicon-pause"></span>
        </button>
        <button type="button" class="upload-control-btn resume" title="å†é–‹" style="display: none;">
          <span class="glyphicon glyphicon-play"></span>
        </button>
        <button type="button" class="upload-control-btn cancel" title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«" style="display: none;">
          <span class="glyphicon glyphicon-stop"></span>
        </button>
      </div>
      <button type="button" class="file-remove" data-index="${n}">
        <span class="glyphicon glyphicon-remove"></span>
      </button>
      <div class="upload-progress" style="display: none;">
        <div class="upload-progress-bar"></div>
      </div>
      <div class="upload-status" style="display: none;"></div>
      <div class="detailed-progress" style="display: none;">
        <div class="progress-text">
          <span class="progress-percentage">0%</span>
          <span class="progress-size">0B / ${v}</span>
        </div>
        <div class="speed-info">é€Ÿåº¦: è¨ˆç®—ä¸­...</div>
      </div>
    `,e.appendChild(a)}),e.querySelectorAll(".file-remove").forEach(o=>{o.addEventListener("click",n=>{if(p)return;const a=n.currentTarget,i=parseInt(a.dataset.index||"0");d.splice(i,1),m(),d.length===0&&y()})}),e.querySelectorAll(".upload-control-btn.pause").forEach(o=>{o.addEventListener("click",n=>{const i=n.currentTarget.closest(".file-item").dataset.filename;i&&typeof window.pauseUpload=="function"&&window.pauseUpload(i)})}),e.querySelectorAll(".upload-control-btn.resume").forEach(o=>{o.addEventListener("click",n=>{const i=n.currentTarget.closest(".file-item").dataset.filename;i&&typeof window.resumeUpload=="function"&&window.resumeUpload(i)})}),e.querySelectorAll(".upload-control-btn.cancel").forEach(o=>{o.addEventListener("click",n=>{const i=n.currentTarget.closest(".file-item").dataset.filename;i&&typeof window.cancelUpload=="function"&&window.cancelUpload(i)})})}function T(e){const t=e.split(".").pop()?.toLowerCase()||"";return{jpg:"ğŸ–¼ï¸",jpeg:"ğŸ–¼ï¸",png:"ğŸ–¼ï¸",gif:"ğŸ–¼ï¸",bmp:"ğŸ–¼ï¸",svg:"ğŸ–¼ï¸",webp:"ğŸ–¼ï¸",mp4:"ğŸ¬",avi:"ğŸ¬",mov:"ğŸ¬",wmv:"ğŸ¬",flv:"ğŸ¬",mkv:"ğŸ¬",webm:"ğŸ¬",mp3:"ğŸµ",wav:"ğŸµ",aac:"ğŸµ",ogg:"ğŸµ",flac:"ğŸµ",m4a:"ğŸµ",wma:"ğŸµ",pdf:"ğŸ“„",doc:"ğŸ“",docx:"ğŸ“",xls:"ğŸ“Š",xlsx:"ğŸ“Š",ppt:"ğŸ“Š",pptx:"ğŸ“Š",zip:"ğŸ—œï¸",rar:"ğŸ—œï¸",lzh:"ğŸ—œï¸","7z":"ğŸ—œï¸",tar:"ğŸ—œï¸",gz:"ğŸ—œï¸",html:"ğŸŒ",css:"ğŸ¨",js:"âš™ï¸",json:"âš™ï¸",xml:"âš™ï¸",sql:"ğŸ—ƒï¸"}[t]||"ğŸ“"}function U(e){if(e===0)return"0 Bytes";const t=1024,s=["Bytes","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,r)).toFixed(1))+" "+s[r]}function z(){const e=l("#selectedFilesContainer");e&&(e.style.display="block",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.transition="all 0.3s ease",e.style.opacity="1",e.style.transform="translateY(0)"},10))}function y(){const e=l("#selectedFilesContainer");e&&(e.style.transition="all 0.3s ease",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.display="none"},300))}function k(){d=[],m(),y();const e=l("#multipleFileInput"),t=l("#folderInput");e&&(e.value=""),t&&(t.value="")}async function I(){if(d.length===0){await g("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");return}if(p){await g("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚");return}p=!0;const e=l("#errorContainer"),t=l("#uploadContainer");e&&(e.style.display="none"),t&&(t.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(r=>{r.style.display="block"}),b(0)}async function b(e){if(e>=d.length){p=!1,d.length=0;const o=l("#uploadContainer"),n=l("#selectedFilesList");o&&(o.style.display="none"),n&&(n.innerHTML="");const a=document.querySelector("#selectedFilesContainer .file-count");a&&(a.textContent="0"),y(),window.fileManagerInstance&&await window.fileManagerInstance.refreshFromServer(),window.folderManager&&await window.folderManager.refreshAll(),!window.fileManagerInstance&&!window.folderManager&&window.location.reload();return}const t=d[e],r=document.querySelectorAll(".file-item")[e],c=r.querySelector(".upload-progress-bar");try{const o=D();await F(t,o,c),c&&(c.style.width="100%"),r.style.backgroundColor="#d4edda",setTimeout(()=>{b(e+1)},500)}catch(o){q(o,t.name),p=!1;const a=l("#uploadContainer");a&&(a.style.display="none")}}async function F(e,t,s){return new Promise((r,c)=>{const o=new FormData;o.append("file",e);const n=t||D();o.append("comment",n.comment||""),o.append("dlkey",n.dlkey||""),o.append("delkey",n.delkey||""),o.append("replacekey",n.replacekey||""),n.maxDownloads&&n.maxDownloads>0&&o.append("max_downloads",n.maxDownloads.toString()),n.expiresDays&&n.expiresDays>0&&o.append("expires_days",n.expiresDays.toString());const a=new XMLHttpRequest;s&&a.upload&&a.upload.addEventListener("progress",i=>{if(i.lengthComputable){const f=Math.round(i.loaded/i.total*100);s.style.width=f+"%"}}),a.addEventListener("load",()=>{try{const i=JSON.parse(a.responseText);i.status==="ok"?r():c(i)}catch{c({status:"network_error",message:"ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ"})}}),a.addEventListener("error",()=>{c({status:"network_error",message:"ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"})}),a.open("POST","./app/api/upload.php"),a.send(o)})}function D(){const e=l("#commentInput"),t=l("#dleyInput"),s=l("#delkeyInput"),r=l("#replaceKeyInput"),c=l("#maxDownloadsUploadInput"),o=l("#expiresDaysUploadInput"),n=l("#folder-select");return{comment:e?.value||"",dlkey:t?.value||"",delkey:s?.value||"",replacekey:r?.value||"",maxDownloads:c&&parseInt(c.value)||void 0,expiresDays:o&&parseInt(o.value)||void 0,folderId:n?.value||void 0}}function q(e,t){let s="";switch(e.status){case"filesize_over":s="ãƒ•ã‚¡ã‚¤ãƒ«å®¹é‡ãŒå¤§ãã™ãã¾ã™: "+t;break;case"extension_error":s="è¨±å¯ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µå­ã§ã™: "+t+" (æ‹¡å¼µå­: "+e.ext+")";break;case"comment_error":s="ã‚³ãƒ¡ãƒ³ãƒˆã®æ–‡å­—æ•°ãŒè¦å®šæ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚";break;case"dlkey_required":s="DLã‚­ãƒ¼ã¯å¿…é ˆå…¥åŠ›ã§ã™ã€‚";break;case"delkey_required":s="DELã‚­ãƒ¼ã¯å¿…é ˆå…¥åŠ›ã§ã™ã€‚";break;case"sqlwrite_error":s="ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: "+t;break;case"network_error":s=e.message+": "+t;break;default:s="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: "+t;break}const r=l("#errorContainer"),c=r?.querySelector(".panel-body");c&&(c.textContent=s),r&&(r.style.display="block")}function _(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}window.selectedFiles=d;window.isUploading=p;window.handleFiles=u;window.uploadMultipleFiles=I;window.clearSelectedFiles=k;
