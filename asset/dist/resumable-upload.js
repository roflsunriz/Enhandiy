import{r as P,i as K,$ as b,f as m,g as x,b as N}from"./errorHandling.js";import{g as _}from"./http.js";import{a as F}from"./modal.js";const g={};let T=!1;P(()=>{console.log("Resumable Upload functionality initialized (TypeScript)"),K(),H(),b(".global-upload-status")||document.body.insertAdjacentHTML("beforeend",`
      <div class="global-upload-status">
        <h6>アップロード進行状況</h6>
        <div class="global-upload-progress">
          <div class="global-upload-progress-bar"></div>
        </div>
        <div class="global-upload-info"></div>
      </div>
    `),console.log("Resumable upload module loaded")});async function H(){if(typeof window.tus>"u"){console.warn("Tus.js library not loaded, falling back to traditional upload"),T=!1;return}try{const t=(await fetch("./app/api/tus-upload.php",{method:"OPTIONS",signal:AbortSignal.timeout(2e3)})).headers.get("Tus-Resumable");t?(T=!0,console.log("Resumable upload available (Tus "+t+")")):(console.warn("Tus.io server response invalid, falling back to traditional upload"),T=!1)}catch(e){console.warn("Tus.io server not available, falling back to traditional upload:",e),T=!1}}function B(e,t={}){return new Promise((o,n)=>{const{comment:l="",dlkey:s="",delkey:r="",replacekey:a="",maxDownloads:d=null,expiresDays:i=null,folderId:c=null}=t,C=window.config?.upload_method_priority||"resumable",p=window.config?.upload_fallback_enabled!==!1;if(C==="normal"){console.log("Using normal upload priority for:",e.name),q(e,t).then(o).catch(u=>{p&&T?(console.log("Fallback to resumable upload after normal failed:",e.name),w()):n(u)});return}if(!T){p?(console.log("Tus.io unavailable, using fallback for:",e.name),q(e,t).then(o).catch(n)):n(new Error("Resumable upload not available and fallback disabled"));return}w();function w(){if(!window.tus){n(new Error("Tus.js not available"));return}const u={filename:e.name,filetype:e.type||"application/octet-stream"},k=_();k?(u.csrf_token=k,console.log("CSRF Debug - Added to metadata:",u.csrf_token.substring(0,8)+"...")):console.error("CSRF Debug - Token not found or empty!"),l&&(u.comment=l),s&&(u.dlkey=s),r&&(u.delkey=r),d&&(u.max_downloads=d.toString()),i&&(u.expires_days=i.toString()),c&&(u.folder_id=c.toString()),a&&(u.replacekey=a.toString());const v=new window.tus.Upload(e,{endpoint:"./app/api/tus-upload.php",retryDelays:[0,1e3,3e3,5e3],metadata:u,chunkSize:512*1024,removeFingerprintOnSuccess:!0,resume:!1,onError:f=>{console.error("Tus upload failed:",f),delete g[e.name],p?(console.log("Falling back to traditional upload for:",e.name),q(e,t).then(o).catch(n)):n(f)},onProgress:(f,h)=>{const S=Math.round(f/h*100),I=Date.now(),y=g[e.name];if(y){y.lastTime||(y.lastTime=I,y.lastBytes=0);const D=(I-y.lastTime)/1e3,z=f-(y.lastBytes||0),O=D>0?z/D:0;y.lastTime=I,y.lastBytes=f,y.progress=S,A(e.name,S,f,h,"resumable",O)}},onSuccess:()=>{console.log("Resumable upload completed:",e.name),R(e.name),o()}});v.start(),g[e.name]={upload:v,file:e,options:t,progress:0}}})}async function q(e,t){console.log("Using fallback upload for:",e.name);const o=new FormData;o.append("file",e),o.append("comment",t.comment||"");const n=_();return n?(o.append("csrf_token",n),console.log("Fallback CSRF Debug - Added to formData")):console.error("Fallback CSRF Debug - Token not found or empty!"),o.append("dlkey",t.dlkey||""),o.append("delkey",t.delkey||""),o.append("replacekey",t.replacekey||""),t.maxDownloads&&o.append("max_downloads",t.maxDownloads.toString()),t.expiresDays&&o.append("expires_days",t.expiresDays.toString()),t.folderId&&o.append("folder_id",t.folderId.toString()),new Promise((l,s)=>{let a=Date.now(),d=0;const i=new XMLHttpRequest;i.upload&&i.upload.addEventListener("progress",c=>{if(c.lengthComputable){const C=Math.round(c.loaded/c.total*100),p=Date.now(),w=(p-a)/1e3,u=c.loaded-d,k=w>0?u/w:0;a=p,d=c.loaded,A(e.name,C,c.loaded,c.total,"fallback",k)}}),i.addEventListener("load",()=>{try{const c=JSON.parse(i.responseText);console.log("Fallback upload response:",c),c.status==="ok"||c.status==="success"?(console.log("Fallback upload completed:",e.name),R(e.name,"fallback"),l()):(console.error("Fallback upload failed with response:",c),M(c,e.name),s(new Error("Upload failed: "+c.status)))}catch{console.error("Failed to parse response:",i.responseText),s(new Error("Invalid response format"))}}),i.addEventListener("error",()=>{console.error("Fallback upload network error:",{status:i.status,statusText:i.statusText,responseText:i.responseText});const c={status:"network_error",message:"Network error: "+i.statusText};M(c,e.name),s(new Error("Network error: "+i.statusText))}),i.open("POST","./app/api/upload.php"),i.send(o)})}function A(e,t,o,n,l,s){const r=document.querySelectorAll(".file-item");let a=null;for(const d of r)if(d.dataset.filename===e){a=d;break}if(a){x(a,"uploading");const d=a.querySelector(".upload-progress"),i=a.querySelector(".upload-status"),c=a.querySelector(".detailed-progress");d&&(d.style.display="block"),i&&(i.style.display="block"),c&&(c.style.display="block");const C=a.querySelector(".upload-progress-bar");C&&(C.style.width=t+"%");const p=a.querySelector(".upload-method-indicator");if(p&&(m(p,"resumable"),m(p,"fallback"),m(p,"failed"),x(p,l),p.textContent=l==="resumable"?"再開可能":"通常",p.style.display="block"),l==="resumable"){const h=a.querySelector(".upload-control-btn.pause"),S=a.querySelector(".upload-control-btn.cancel");h&&(h.style.display="block"),S&&(S.style.display="block")}const w=U(o)+" / "+U(n),u=s?$(s):"計算中...";i&&(i.textContent=t+"% ("+w+")");const k=a.querySelector(".progress-percentage"),v=a.querySelector(".progress-size"),f=a.querySelector(".speed-info");if(k&&(k.textContent=t+"%"),v&&(v.textContent=w),f&&(f.textContent="速度: "+u),s&&s>0&&f){const h=(n-o)/s,S=j(h);f.textContent="速度: "+u+" | 残り: "+S}}E()}function R(e,t){const o=document.querySelectorAll(".file-item");let n=null;for(const l of o)if(l.dataset.filename===e){n=l;break}if(n){m(n,"uploading"),m(n,"paused"),x(n,"completed");const l=n.querySelector(".upload-progress-bar"),s=n.querySelector(".upload-status"),r=n.querySelectorAll(".upload-controls button"),a=n.querySelector(".detailed-progress");l&&(l.style.width="100%"),s&&(s.textContent="完了"),r.forEach(i=>i.style.display="none"),a&&(a.style.display="none");const d=n.querySelector(".file-info");d&&!d.querySelector(".upload-success-icon")&&d.insertAdjacentHTML("beforeend",`
        <span class="upload-success-icon" style="color: #5cb85c; margin-left: 10px;">
          <span class="glyphicon glyphicon-ok-circle"></span>
        </span>
      `)}delete g[e],E(),Object.keys(g).length===0&&setTimeout(async()=>{const l=b(".global-upload-status");l&&m(l,"active"),document.querySelectorAll(".file-item").forEach(a=>{a.parentNode&&a.parentNode.removeChild(a)});const r=document.getElementById("selectedFilesContainer");r&&(r.style.transition="all 0.3s ease",r.style.opacity="0",r.style.transform="translateY(-10px)",setTimeout(()=>{r.style.display="none"},300)),console.log("resumable-upload: アップロード完了後の更新処理開始");try{window.folderManager?(console.log("resumable-upload: FolderManager.refreshAll()を実行"),await window.folderManager.refreshAll()):window.fileManagerInstance?(console.log("resumable-upload: FileManager.refreshFromServer()を実行"),await window.fileManagerInstance.refreshFromServer()):(console.log("resumable-upload: FileManagerが見つからないため、ページをリロード"),window.location.reload()),console.log("resumable-upload: 更新処理完了")}catch(a){console.error("resumable-upload: 更新処理エラー:",a),window.location.reload()}},2e3)}function G(e){const t=g[e];if(t?.upload){t.upload.abort(),console.log("Upload paused:",e);const o=document.querySelectorAll(".file-item");for(const n of o){const l=n;if(l.dataset.filename===e){m(l,"uploading"),x(l,"paused");const s=l.querySelector(".upload-control-btn.pause"),r=l.querySelector(".upload-control-btn.resume"),a=l.querySelector(".upload-status");s&&(s.style.display="none"),r&&(r.style.display="block"),a&&(a.textContent="一時停止");break}}return!0}return!1}function J(e){const t=g[e];if(t?.upload){t.upload.start(),console.log("Upload resumed:",e);const o=document.querySelectorAll(".file-item");for(const n of o){const l=n;if(l.dataset.filename===e){m(l,"paused"),x(l,"uploading");const s=l.querySelector(".upload-control-btn.resume"),r=l.querySelector(".upload-control-btn.pause"),a=l.querySelector(".upload-status");s&&(s.style.display="none"),r&&(r.style.display="block"),a&&(a.textContent="再開中...");break}}return!0}return!1}function W(e){const t=g[e];if(t?.upload){t.upload.abort(),console.log("Upload cancelled:",e);const o=document.querySelectorAll(".file-item");for(const n of o){const l=n;if(l.dataset.filename===e){m(l,"uploading"),m(l,"paused"),x(l,"failed");const s=l.querySelectorAll(".upload-controls button"),r=l.querySelector(".upload-status"),a=l.querySelector(".upload-method-indicator");s.forEach(d=>d.style.display="none"),r&&(r.textContent="キャンセル済み"),a&&(m(a,"resumable"),x(a,"failed"));break}}return delete g[e],E(),!0}return!1}async function X(){console.log("Enhanced file upload called");const e=document.getElementById("replaceKeyInput");if(!e){await F("差し替えキー入力フィールドが見つかりません。");return}const t=e.value;if(!t||t.trim()===""){await F("差し替えキーの入力は必須です。");return}const o=document.getElementById("multipleFileInput"),n=!!o,l=o?.files?.length||0,s=window.selectedFiles?.length||0;if(console.log("Debug info - fileInputExists:",n,"fileInputHasFiles:",l,"selectedFilesLength:",s),o?.files&&o.files.length>0){const a=o.files[0];console.log("Single file upload:",a.name);const d=L();B(a,d);return}const r=window.selectedFiles;if(r&&r.length>0){console.log("Multiple files upload:",r.length,"files"),Y(r);return}console.warn("No files selected for upload"),await F("ファイルが選択されていません。ファイルを選択してからアップロードボタンを押してください。")}function Y(e){if(e.length===0)return;window.isUploading=!0;const t=b("#errorContainer"),o=b("#uploadContainer");t&&(t.style.display="none"),o&&(o.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(a=>a.style.display="block");const l=L();let s=0;const r=e.length;e.forEach((a,d)=>{setTimeout(()=>{B(a,l).then(()=>{s++,s===r&&(window.isUploading=!1,o&&(o.style.display="none"))}).catch(i=>{console.error("Upload failed for",a.name,i),s++,s===r&&(window.isUploading=!1,o&&(o.style.display="none"))})},d*100)})}function L(){const e=document.getElementById("commentInput"),t=document.getElementById("dleyInput"),o=document.getElementById("delkeyInput"),n=document.getElementById("replaceKeyInput"),l=document.getElementById("maxDownloadsUploadInput"),s=document.getElementById("expiresDaysUploadInput"),r=document.getElementById("folder-select");return{comment:e?.value||"",dlkey:t?.value||"",delkey:o?.value||"",replacekey:n?.value||"",maxDownloads:l&&parseInt(l.value)||void 0,expiresDays:s&&parseInt(s.value)||void 0,folderId:r?.value||void 0}}function E(){const e=Object.keys(g).length,t=b(".global-upload-status");t&&(m(t,"active"),t.style.display="none");const o=b("#progressContainer"),n=b("#progressBar"),l=b("#progressText"),s=b("#uploadStatus");if(e===0){o&&(o.style.display="none");return}let r=0,a=0;Object.values(g).forEach(i=>{i.progress!==void 0&&(r+=i.progress),i.completed&&a++});const d=Math.round(r/e);o&&(o.style.display="block"),n&&(n.style.width=d+"%"),l&&(l.textContent=d+"%"),s&&(s.textContent="完了: "+a+"/"+e)}function U(e){if(e===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,n)).toFixed(1))+" "+o[n]}function $(e){return e<1024?e.toFixed(1)+" B/s":e<1024*1024?(e/1024).toFixed(1)+" KB/s":e<1024*1024*1024?(e/(1024*1024)).toFixed(1)+" MB/s":(e/(1024*1024*1024)).toFixed(1)+" GB/s"}function j(e){return e<60?Math.round(e)+"秒":e<3600?Math.round(e/60)+"分":Math.round(e/3600)+"時間"}function M(e,t){let o="";switch(e.status){case"filesize_over":o="ファイル容量が大きすぎます: "+t;break;case"extension_error":o="許可されていない拡張子です: "+t+" (拡張子: "+e.ext+")";break;case"comment_error":o="コメントの文字数が規定数を超えています。";break;case"dlkey_required":o="DLキーは必須入力です。";break;case"delkey_required":o="DELキーは必須入力です。";break;case"sqlwrite_error":o="データベースの書き込みに失敗しました: "+t;break;case"network_error":o=e.message+": "+t;break;default:o="アップロードに失敗しました: "+t;break}N(o)}window.enhancedFileUpload=X;window.pauseUpload=G;window.resumeUpload=J;window.cancelUpload=W;window.uploadFileResumable=B;
