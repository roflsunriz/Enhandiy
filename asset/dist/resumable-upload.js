import{r as K,i as N,$ as b,f as m,g as x,c as H}from"./errorHandling.js";import{g as A}from"./http.js";import{a as q}from"./modal.js";const y={};let T=!1;K(()=>{N(),G(),b(".global-upload-status")||document.body.insertAdjacentHTML("beforeend",`
      <div class="global-upload-status">
        <h6>アップロード進行状況</h6>
        <div class="global-upload-progress">
          <div class="global-upload-progress-bar"></div>
        </div>
        <div class="global-upload-info"></div>
      </div>
    `)});async function G(){if(typeof window.tus>"u"){console.warn("Tus.js library not loaded, falling back to traditional upload"),T=!1;return}try{(await fetch("./app/api/tus-upload.php",{method:"OPTIONS",signal:AbortSignal.timeout(2e3)})).headers.get("Tus-Resumable")?T=!0:(console.warn("Tus.io server response invalid, falling back to traditional upload"),T=!1)}catch(e){console.warn("Tus.io server not available, falling back to traditional upload:",e),T=!1}}function E(e,o={}){return new Promise((t,s)=>{const{comment:a="",dlkey:r="",delkey:l="",replacekey:n="",maxDownloads:d=null,expiresDays:i=null,folderId:c=null}=o,C=window.config?.upload_method_priority||"resumable",p=window.config?.upload_fallback_enabled!==!1;if(C==="normal"){B(e,o).then(t).catch(u=>{p&&T?w():s(u)});return}if(!T){p?B(e,o).then(t).catch(s):s(new Error("Resumable upload not available and fallback disabled"));return}w();function w(){if(!window.tus){s(new Error("Tus.js not available"));return}const u={filename:e.name,filetype:e.type||"application/octet-stream"},k=A();k?u.csrf_token=k:console.error("CSRF Debug - Token not found or empty!"),a&&(u.comment=a),r&&(u.dlkey=r),l&&(u.delkey=l),d&&(u.max_downloads=d.toString()),i&&(u.expires_days=i.toString()),c&&(u.folder_id=c.toString()),n&&(u.replacekey=n.toString());const v=new window.tus.Upload(e,{endpoint:"./app/api/tus-upload.php",retryDelays:[0,1e3,3e3,5e3],metadata:u,chunkSize:512*1024,removeFingerprintOnSuccess:!0,resume:!1,onError:f=>{console.error("Tus upload failed:",f),delete y[e.name],p?B(e,o).then(t).catch(s):s(f)},onProgress:(f,h)=>{const S=Math.round(f/h*100),I=Date.now(),g=y[e.name];if(g){g.lastTime||(g.lastTime=I,g.lastBytes=0);const U=(I-g.lastTime)/1e3,z=f-(g.lastBytes||0),P=U>0?z/U:0;g.lastTime=I,g.lastBytes=f,g.progress=S,R(e.name,S,f,h,"resumable",P)}},onSuccess:()=>{L(e.name),t()}});v.start(),y[e.name]={upload:v,file:e,options:o,progress:0}}})}async function B(e,o){const t=new FormData;t.append("file",e),t.append("comment",o.comment||"");const s=A();return s?t.append("csrf_token",s):console.error("Fallback CSRF Debug - Token not found or empty!"),t.append("dlkey",o.dlkey||""),t.append("delkey",o.delkey||""),t.append("replacekey",o.replacekey||""),o.maxDownloads&&t.append("max_downloads",o.maxDownloads.toString()),o.expiresDays&&t.append("expires_days",o.expiresDays.toString()),o.folderId&&t.append("folder_id",o.folderId.toString()),new Promise((a,r)=>{let n=Date.now(),d=0;const i=new XMLHttpRequest;i.upload&&i.upload.addEventListener("progress",c=>{if(c.lengthComputable){const C=Math.round(c.loaded/c.total*100),p=Date.now(),w=(p-n)/1e3,u=c.loaded-d,k=w>0?u/w:0;n=p,d=c.loaded,R(e.name,C,c.loaded,c.total,"fallback",k)}}),i.addEventListener("load",()=>{try{const c=JSON.parse(i.responseText);c.status==="ok"||c.status==="success"?(L(e.name,"fallback"),a()):(console.error("Fallback upload failed with response:",c),_(c,e.name),r(new Error("Upload failed: "+c.status)))}catch{console.error("Failed to parse response:",i.responseText),r(new Error("Invalid response format"))}}),i.addEventListener("error",()=>{console.error("Fallback upload network error:",{status:i.status,statusText:i.statusText,responseText:i.responseText});const c={status:"network_error",message:"Network error: "+i.statusText};_(c,e.name),r(new Error("Network error: "+i.statusText))}),i.open("POST","./app/api/upload.php"),i.send(t)})}function R(e,o,t,s,a,r){const l=document.querySelectorAll(".file-item");let n=null;for(const d of l)if(d.dataset.filename===e){n=d;break}if(n){x(n,"uploading");const d=n.querySelector(".upload-progress"),i=n.querySelector(".upload-status"),c=n.querySelector(".detailed-progress");d&&(d.style.display="block"),i&&(i.style.display="block"),c&&(c.style.display="block");const C=n.querySelector(".upload-progress-bar");C&&(C.style.width=o+"%");const p=n.querySelector(".upload-method-indicator");if(p&&(m(p,"resumable"),m(p,"fallback"),m(p,"failed"),x(p,a),p.textContent=a==="resumable"?"再開可能":"通常",p.style.display="block"),a==="resumable"){const h=n.querySelector(".upload-control-btn.pause"),S=n.querySelector(".upload-control-btn.cancel");h&&(h.style.display="block"),S&&(S.style.display="block")}const w=M(t)+" / "+M(s),u=r?$(r):"計算中...";i&&(i.textContent=o+"% ("+w+")");const k=n.querySelector(".progress-percentage"),v=n.querySelector(".progress-size"),f=n.querySelector(".speed-info");if(k&&(k.textContent=o+"%"),v&&(v.textContent=w),f&&(f.textContent="速度: "+u),r&&r>0&&f){const h=(s-t)/r,S=j(h);f.textContent="速度: "+u+" | 残り: "+S}}D()}function L(e,o){const t=document.querySelectorAll(".file-item");let s=null;for(const a of t)if(a.dataset.filename===e){s=a;break}if(s){m(s,"uploading"),m(s,"paused"),x(s,"completed");const a=s.querySelector(".upload-progress-bar"),r=s.querySelector(".upload-status"),l=s.querySelectorAll(".upload-controls button"),n=s.querySelector(".detailed-progress");a&&(a.style.width="100%"),r&&(r.textContent="完了"),l.forEach(i=>i.style.display="none"),n&&(n.style.display="none");const d=s.querySelector(".file-info");d&&!d.querySelector(".upload-success-icon")&&d.insertAdjacentHTML("beforeend",`
        <span class="upload-success-icon" style="color: #5cb85c; margin-left: 10px;">
          <span class="glyphicon glyphicon-ok-circle"></span>
        </span>
      `)}delete y[e],D(),Object.keys(y).length===0&&setTimeout(async()=>{const a=b(".global-upload-status");a&&m(a,"active"),document.querySelectorAll(".file-item").forEach(n=>{n.parentNode&&n.parentNode.removeChild(n)});const l=document.getElementById("selectedFilesContainer");l&&(l.style.transition="all 0.3s ease",l.style.opacity="0",l.style.transform="translateY(-10px)",setTimeout(()=>{l.style.display="none"},300));try{window.folderManager?await window.folderManager.refreshAll():window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload()}catch(n){console.error("resumable-upload: 更新処理エラー:",n),window.location.reload()}},2e3)}function J(e){const o=y[e];if(o?.upload){o.upload.abort();const t=document.querySelectorAll(".file-item");for(const s of t){const a=s;if(a.dataset.filename===e){m(a,"uploading"),x(a,"paused");const r=a.querySelector(".upload-control-btn.pause"),l=a.querySelector(".upload-control-btn.resume"),n=a.querySelector(".upload-status");r&&(r.style.display="none"),l&&(l.style.display="block"),n&&(n.textContent="一時停止");break}}return!0}return!1}function W(e){const o=y[e];if(o?.upload){o.upload.start();const t=document.querySelectorAll(".file-item");for(const s of t){const a=s;if(a.dataset.filename===e){m(a,"paused"),x(a,"uploading");const r=a.querySelector(".upload-control-btn.resume"),l=a.querySelector(".upload-control-btn.pause"),n=a.querySelector(".upload-status");r&&(r.style.display="none"),l&&(l.style.display="block"),n&&(n.textContent="再開中...");break}}return!0}return!1}function X(e){const o=y[e];if(o?.upload){o.upload.abort();const t=document.querySelectorAll(".file-item");for(const s of t){const a=s;if(a.dataset.filename===e){m(a,"uploading"),m(a,"paused"),x(a,"failed");const r=a.querySelectorAll(".upload-controls button"),l=a.querySelector(".upload-status"),n=a.querySelector(".upload-method-indicator");r.forEach(d=>d.style.display="none"),l&&(l.textContent="キャンセル済み"),n&&(m(n,"resumable"),x(n,"failed"));break}}return delete y[e],D(),!0}return!1}async function Y(){const e=document.getElementById("replaceKeyInput");if(!e){await q("差し替えキー入力フィールドが見つかりません。");return}const o=e.value;if(!o||o.trim()===""){await q("差し替えキーの入力は必須です。");return}const t=document.getElementById("multipleFileInput"),s=window.selectedFiles;if(s&&s.length>0){F(s);return}if(t?.files&&t.files.length>0){const a=Array.from(t.files);if(a.length===1){const r=O();E(a[0],r)}else F(a);return}console.warn("No files selected for upload"),await q("ファイルが選択されていません。ファイルを選択してからアップロードボタンを押してください。")}function F(e){if(e.length===0)return;window.isUploading=!0;const o=b("#errorContainer"),t=b("#uploadContainer");o&&(o.style.display="none"),t&&(t.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(n=>n.style.display="block");const a=O();let r=0;const l=e.length;e.forEach((n,d)=>{setTimeout(()=>{E(n,a).then(()=>{r++,r===l&&(window.isUploading=!1,t&&(t.style.display="none"))}).catch(i=>{console.error("Upload failed for",n.name,i),r++,r===l&&(window.isUploading=!1,t&&(t.style.display="none"))})},d*100)})}function O(){const e=document.getElementById("commentInput"),o=document.getElementById("dleyInput"),t=document.getElementById("delkeyInput"),s=document.getElementById("replaceKeyInput"),a=document.getElementById("maxDownloadsUploadInput"),r=document.getElementById("expiresDaysUploadInput"),l=document.getElementById("folder-select");return{comment:e?.value||"",dlkey:o?.value||"",delkey:t?.value||"",replacekey:s?.value||"",maxDownloads:a&&parseInt(a.value)||void 0,expiresDays:r&&parseInt(r.value)||void 0,folderId:l?.value||void 0}}function D(){const e=Object.keys(y).length,o=b(".global-upload-status");o&&(m(o,"active"),o.style.display="none");const t=b("#progressContainer"),s=b("#progressBar"),a=b("#progressText"),r=b("#uploadStatus");if(e===0){t&&(t.style.display="none");return}let l=0,n=0;Object.values(y).forEach(i=>{i.progress!==void 0&&(l+=i.progress),i.completed&&n++});const d=Math.round(l/e);t&&(t.style.display="block"),s&&(s.style.width=d+"%"),a&&(a.textContent=d+"%"),r&&(r.textContent="完了: "+n+"/"+e)}function M(e){if(e===0)return"0 Bytes";const o=1024,t=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(o));return parseFloat((e/Math.pow(o,s)).toFixed(1))+" "+t[s]}function $(e){return e<1024?e.toFixed(1)+" B/s":e<1024*1024?(e/1024).toFixed(1)+" KB/s":e<1024*1024*1024?(e/(1024*1024)).toFixed(1)+" MB/s":(e/(1024*1024*1024)).toFixed(1)+" GB/s"}function j(e){return e<60?Math.round(e)+"秒":e<3600?Math.round(e/60)+"分":Math.round(e/3600)+"時間"}function _(e,o){let t="";switch(e.status){case"filesize_over":t="ファイル容量が大きすぎます: "+o;break;case"extension_error":t="許可されていない拡張子です: "+o+" (拡張子: "+e.ext+")";break;case"comment_error":t="コメントの文字数が規定数を超えています。";break;case"dlkey_required":t="DLキーは必須入力です。";break;case"delkey_required":t="DELキーは必須入力です。";break;case"sqlwrite_error":t="データベースの書き込みに失敗しました: "+o;break;case"network_error":t=e.message+": "+o;break;default:t="アップロードに失敗しました: "+o;break}H(t)}window.enhancedFileUpload=Y;window.pauseUpload=J;window.resumeUpload=W;window.cancelUpload=X;window.uploadFileResumable=E;
