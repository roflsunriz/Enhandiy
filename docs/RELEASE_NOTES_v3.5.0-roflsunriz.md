# phpUploader v3.5.0-roflsunriz リリースノート

## 🔐 セキュリティ強化 & 📝 履歴機能拡張

この重要なアップデートでは、データベースセキュリティの大幅な強化とファイル操作履歴の記録範囲拡張を実現しました。

## 🛡️ データベースセキュリティ強化

### TUSアップロードキーの暗号化

**🔧 重要なセキュリティ改善**
- `tus_uploads`テーブルに保存されていた**平文キーを暗号化**して保存するように改善
- 断続的アップロード（TUS/resumable upload）におけるセキュリティリスクを大幅に軽減
- データベース直接アクセスされた場合でも、アップロードキーが保護される仕組みを実現

**セキュリティ効果**
- ✅ データベースダンプからのキー流出リスクを排除
- ✅ 内部関係者によるキー悪用の防止
- ✅ より堅牢な断続的アップロードシステムの実現

## 📝 ファイル操作履歴の強化

### 操作記録の範囲拡張

**🔍 履歴記録の大幅改善**
- これまでRESTful APIでのファイル操作のみ記録していた`file_history`テーブルを拡張
- **コメント編集API**での変更も履歴に記録
- **ファイル差し替えAPI**での変更も履歴に記録
- より包括的なファイル操作監査が可能に

**追加された記録対象**
- ✅ コメント編集操作 (`edit-comment.php`)
- ✅ ファイル差し替え操作 (`replace-file.php`)
- ✅ 既存のRESTful API操作（継続）

**監査・トレーサビリティの向上**
- 「誰が」「いつ」「何を」変更したかの完全な追跡が可能
- セキュリティインシデント発生時の調査能力向上
- コンプライアンス要件への対応強化

## 🎨 UI/UX改善

### アップロード体験の改善

**📋 アップロードリストの調整**
- ファイルアップロードリストのUIを調整し、より見やすく改善
- ユーザビリティの向上

## 🐛 バグ修正

### 動的更新の部分修正

**⚡ 個別削除時の動的更新修正**
- 個別ファイル削除時にファイルリストが更新されない問題を修正
- より快適なファイル管理体験を実現

**📌 既知の制限**
- 一括削除とファイル階層移動時の動的更新は未修正（今後のバージョンで対応予定）

## 📋 技術的詳細

**主な影響を受けるコンポーネント**
- `tus_uploads`テーブル - 暗号化キー保存
- `file_history`テーブル - 記録対象拡張  
- `edit-comment.php` - 履歴記録追加
- `replace-file.php` - 履歴記録追加
- アップロードUI - リスト表示改善

## 🎯 対象ユーザー

この更新により、以下の方にメリットがあります：

**🏢 企業・組織ユーザー**
- より厳格なセキュリティ要件への対応
- 包括的な操作監査ログの取得
- コンプライアンス対応の強化

**🔒 セキュリティ重視ユーザー**
- データベースレベルでのセキュリティ強化
- 操作履歴の完全性向上

**👥 マルチユーザー環境**
- より詳細な操作追跡
- 責任の所在明確化

## 🚀 アップグレード方法

1. **バックアップ作成**（重要）
   ```bash
   # データベースのバックアップを作成
   cp data/database.db data/database_backup_v3.4.0.db
   ```

2. **最新版をデプロイ**
   - 最新のコードをデプロイ

3. **動作確認**
   - TUSアップロードが正常に動作することを確認
   - ファイル操作履歴が適切に記録されることを確認

## ⚠️ 重要な注意事項

**データベース互換性**
- 既存のデータは影響を受けません
- 新規アップロードから暗号化が適用されます
- 既存のTUSキーは次回アップロード時に暗号化されます

**履歴機能**
- v3.5.0以降の操作のみ拡張された履歴記録の対象となります
- 既存の履歴データは保持されます

---

**リリース日**: 2025年8月7日  
**バージョン**: v3.5.0-roflsunriz  
**リリースタイプ**: セキュリティ強化・機能拡張  

このリリースにより、phpUploaderはより安全で追跡可能なファイル管理システムに進化しました。

ご利用いただき、ありがとうございます！ 🔐📝