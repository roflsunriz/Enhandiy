import{r as g,i as y}from"./error-handling.js";import{a as f}from"./api-client.js";import{p as F}from"./http.js";import{c as u,a as i,b as w}from"./modal.js";import"./bootstrap.js";class v{currentFolderId=null;constructor(){this.init()}init(){const r=new URLSearchParams(window.location.search);this.currentFolderId=r.get("folder")||null,this.setupEventListeners(),this.loadFolderOptions()}setupEventListeners(){this.bindCreateFolderButton(),document.addEventListener("click",r=>{const t=r.target;if(t.classList.contains("rename-folder")){r.preventDefault();const e=t.dataset.folderId;e&&this.showRenameFolderDialog(e)}if(t.classList.contains("move-folder")){r.preventDefault();const e=t.dataset.folderId;e&&this.showMoveFolderDialog(e)}if(t.classList.contains("delete-folder")){r.preventDefault();const e=t.dataset.folderId;e&&this.showDeleteFolderDialog(e)}})}bindCreateFolderButton(){const r=document.getElementById("create-folder-btn");r?r.addEventListener("click",()=>this.showCreateFolderDialog()):setTimeout(()=>this.bindCreateFolderButton(),500)}async loadFolderOptions(){try{const r=await f.getFolders();if(!r){console.error("ãƒ•ã‚©ãƒ«ãƒ€APIå¿œç­”ãŒ null ã¾ãŸã¯ undefined ã§ã™");return}if(!r.success){console.error("ãƒ•ã‚©ãƒ«ãƒ€APIå¿œç­”ã§ã‚¨ãƒ©ãƒ¼:",r.error||"Unknown error");return}const t=r.data?.folders||[];if(!Array.isArray(t)){console.error("ãƒ•ã‚©ãƒ«ãƒ€ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:",typeof t);return}this.updateFolderSelect(t)}catch(r){console.error("ãƒ•ã‚©ãƒ«ãƒ€èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",r)}}async refreshAll(){try{await this.loadFolderOptions(),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():console.warn("FolderManager.refreshAll: FileManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),await this.refreshFolderNavigation()}catch(r){console.error("ãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã®æ›´æ–°ã«å¤±æ•—:",r)}}async refreshFolderNavigation(){try{const r=this.currentFolderId,t=r?`/api/refresh-files.php?folder=${encodeURIComponent(r)}`:"/api/refresh-files.php",e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const o=await e.json();o.success?(this.updateBreadcrumb(o.breadcrumb||[]),this.updateFolderDisplay(o.folders||[])):console.error("ãƒ•ã‚©ãƒ«ãƒ€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:",o)}catch(r){console.error("ãƒ•ã‚©ãƒ«ãƒ€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:",r)}}updateBreadcrumb(r){const t=document.querySelector(".breadcrumb");if(t){let e='<li><a href="?folder=" class="breadcrumb-link">ğŸ  ãƒ«ãƒ¼ãƒˆ</a></li>';r.forEach((o,s)=>{s+1===r.length?e+=`<li class="active">${this.escapeHtml(o.name)}</li>`:e+=`
            <li>
              <a href="?folder=${o.id}" class="breadcrumb-link">
                ${this.escapeHtml(o.name)}
              </a>
            </li>
          `}),t.innerHTML=e}}updateFolderDisplay(r){const t=document.getElementById("folder-grid");if(t){const e=this.getChildFolders(r,this.currentFolderId);if(e.length===0){t.innerHTML="";const o=t.parentElement;if(o&&!o.querySelector(".text-center.text-muted")){const n=document.createElement("div");n.className="text-center text-muted",n.style.padding="20px",n.innerHTML=`
              <span class="glyphicon glyphicon-folder-open" 
                    style="font-size: 2em; margin-bottom: 10px; display: block;"></span>
              ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Šã¾ã›ã‚“
            `,o.appendChild(n)}}else{const o=t.parentElement;if(o){const n=o.querySelector(".text-center.text-muted");n&&n.remove()}let s="";e.forEach(n=>{s+=`
            <div class="col-sm-3 col-xs-6" style="margin-bottom: 15px;" data-folder-id="${n.id}">
              <div class="folder-item-wrapper" style="position: relative;">
                <a href="?folder=${n.id}" class="folder-item">
                  <span class="folder-icon">ğŸ“</span>
                  <span class="folder-name">${this.escapeHtml(n.name)}</span>
                </a>
                <div class="folder-menu" style="position: absolute; top: 5px; right: 5px; opacity: 0; transition: opacity 0.2s;">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false"
                            style="padding: 2px 6px; border-radius: 50%; width: 24px; height: 24px; font-size: 10px;">
                      â‹®
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" style="min-width: 120px;">
                      <li>
                        <a class="dropdown-item rename-folder" href="#" data-folder-id="${n.id}">
                          âœï¸ åå‰å¤‰æ›´
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item move-folder" href="#" data-folder-id="${n.id}">
                          ğŸ“ ç§»å‹•
                        </a>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="dropdown-item delete-folder" href="#" data-folder-id="${n.id}" style="color: #d9534f;">
                          ğŸ—‘ å‰Šé™¤
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          `}),t.innerHTML=s}}}getChildFolders(r,t){const e=t?parseInt(t):null;return r.filter(o=>(o.parent_id??null)===e)}escapeHtml(r){const t=document.createElement("div");return t.textContent=r,t.innerHTML}updateFolderSelect(r){const t=document.getElementById("folder-select");if(!t){setTimeout(()=>{document.getElementById("folder-select")&&this.updateFolderSelect(r)},500);return}const e=t.value;t.innerHTML='<option value="">ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€</option>';const o=(s,n=0)=>{if(!Array.isArray(s)){console.error("addOptions: folders ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:",s);return}s.forEach(a=>{if(!a||typeof a.id>"u"||typeof a.name>"u"){console.error("ç„¡åŠ¹ãªãƒ•ã‚©ãƒ«ãƒ€ãƒ‡ãƒ¼ã‚¿:",a);return}const d=document.createElement("option");d.value=String(a.id),d.textContent="ã€€".repeat(n)+a.name,t.appendChild(d);const l=a;"children"in a&&l.children&&Array.isArray(l.children)&&l.children.length>0&&o(l.children,n+1)})};o(r),t.value=e}async showCreateFolderDialog(){const r=await u("æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");!r||!r.trim()||this.createFolder(r.trim(),this.currentFolderId)}async createFolder(r,t=null){try{await f.createFolder(r,t||void 0),i("ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ: "+r).catch(e=>{console.warn("ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:",e)}),await this.refreshAll(),setTimeout(async()=>{await this.refreshAll()},1e3)}catch(e){console.error("ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã‚¨ãƒ©ãƒ¼:",e);const o=e instanceof Error?e.message:"ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ";await i("ã‚¨ãƒ©ãƒ¼: "+o)}}async showRenameFolderDialog(r){const t=document.querySelector(`[data-folder-id="${r}"] .folder-item`),e=t?t.textContent?.trim().replace("ğŸ“","").trim():"",o=await u("æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",e);!o||!o.trim()||o.trim()===e||this.renameFolder(r,o.trim())}async renameFolder(r,t){try{const e=await f.updateFolder(r,t);if(e.success)i("ãƒ•ã‚©ãƒ«ãƒ€åã‚’å¤‰æ›´ã—ã¾ã—ãŸ: "+t).catch(o=>{console.warn("ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:",o)}),await this.refreshAll(),setTimeout(async()=>{await this.refreshAll()},500);else throw new Error(e.error||"ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ")}catch(e){console.error("ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´ã‚¨ãƒ©ãƒ¼:",e);const o=e instanceof Error?e.message:"ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ";await i("ã‚¨ãƒ©ãƒ¼: "+o)}}async showMoveFolderDialog(r){try{const e=(await f.getFolders()).data?.folders||[],o=["ç§»å‹•å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„:","","0: ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆæœ€ä¸Šä½ï¼‰"],s=(d,l=0)=>{d.forEach(c=>{if(String(c.id)!==String(r)){const m="ã€€".repeat(l+1);o.push(`${m}${c.id}: ${c.name}`)}const p=c;"children"in c&&p.children&&p.children.length>0&&s(p.children,l+1)})};s(e),o.push(""),o.push("ç§»å‹•å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ0ã§ãƒ«ãƒ¼ãƒˆï¼‰:");const n=await u(o.join(`
`));if(n===null)return;const a=n==="0"?null:n;this.moveFolder(r,a)}catch(t){console.error("ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼:",t);const e=t instanceof Error?t.message:"ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ";await i("ã‚¨ãƒ©ãƒ¼: "+e)}}async moveFolder(r,t){try{const e=await f.moveFolder(r,t);if(e.success)i("ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç§»å‹•ã—ã¾ã—ãŸ").catch(o=>{console.warn("ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:",o)}),await this.refreshAll(),setTimeout(async()=>{await this.refreshAll()},500);else throw new Error(e.error||"ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ")}catch(e){console.error("ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ã‚¨ãƒ©ãƒ¼:",e);const o=e instanceof Error?e.message:"ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ";await i("ã‚¨ãƒ©ãƒ¼: "+o)}}async showDeleteFolderDialog(r){const t=document.querySelector(`[data-folder-id="${r}"] .folder-item`),e=t?t.textContent?.trim().replace("ğŸ“","").trim():"ãƒ•ã‚©ãƒ«ãƒ€";try{const s=(await f.getFolderFileCount(r)).data?.count||0,n=0;if(s===0&&n===0)await w(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${e}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)&&this.deleteFolder(r,!1);else{let a=`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${e}ã€ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š
`;s>0&&(a+=`ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«: ${s}å€‹
`),n>0,a+=`
å‰Šé™¤æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š
`,a+=`ã€ŒOKã€= ä¸­èº«ã‚’ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¦å‰Šé™¤
`,a+="ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€= å‰Šé™¤ã‚’ä¸­æ­¢",await w(a)&&this.deleteFolder(r,!0)}}catch(o){console.error("ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤ç¢ºèªã‚¨ãƒ©ãƒ¼:",o);const s=o instanceof Error?o.message:"ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";await i("ã‚¨ãƒ©ãƒ¼: "+s)}}async deleteFolder(r,t=!1){try{const e=await f.deleteFolder(r);if(e.success)i("ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ").catch(o=>{console.warn("ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:",o)}),await this.refreshAll(),setTimeout(async()=>{await this.refreshAll()},500);else throw new Error(e.error||"ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ")}catch(e){console.error("ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",e);const o=e instanceof Error?e.message:"ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ";await i("ã‚¨ãƒ©ãƒ¼: "+o)}}}async function E(h){const r=window.config;if(!r||!r.folders_enabled){await i("ãƒ•ã‚©ãƒ«ãƒ€æ©Ÿèƒ½ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");return}try{const e=(await f.getFolders()).data?.folders||[],o=["ãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»å‹•å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„:","","0: ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆæœ€ä¸Šä½ï¼‰"],s=(d,l=0)=>{d.forEach(c=>{const p="ã€€".repeat(l+1);o.push(`${p}${c.id}: ${c.name}`);const m=c;"children"in c&&m.children&&m.children.length>0&&s(m.children,l+1)})};s(e),o.push(""),o.push("ç§»å‹•å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ0ã§ãƒ«ãƒ¼ãƒˆï¼‰:");const n=await u(o.join(`
`));if(n===null)return;await F("/api/move-file.php",{file_id:h,folder_id:n==="0"?null:n}),setTimeout(async()=>{try{window.folderManager?await window.folderManager.refreshAll():window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload()}catch(d){console.error("ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•: æ›´æ–°å‡¦ç†ã‚¨ãƒ©ãƒ¼:",d),window.location.reload()}},1e3),await i("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã—ãŸ")}catch(t){console.error("ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ã‚¨ãƒ©ãƒ¼:",t);const e=t instanceof Error?t.message:"ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ";await i("ã‚¨ãƒ©ãƒ¼: "+e)}}g(()=>{y();const h=window.config;if(h&&h.folders_enabled){const r=new v;window.folderManager=r}});window.moveFile=E;
