import{r as N,i as H,$ as w,d as m,e as C,b as G}from"./error-handling.js";import{g as R}from"./http.js";import{a as x}from"./modal.js";import{i as q}from"./password-strength.js";import"./bootstrap.js";const y={};let v=!1;N(()=>{H(),W(),w(".global-upload-status")||document.body.insertAdjacentHTML("beforeend",`
      <div class="global-upload-status">
        <h6>アップロード進行状況</h6>
        <div class="global-upload-progress">
          <div class="global-upload-progress-bar"></div>
        </div>
        <div class="global-upload-info"></div>
      </div>
    `)});async function W(){if(typeof window.tus>"u"){console.warn("Tus.js library not loaded, falling back to traditional upload"),v=!1;return}try{(await fetch("/api/tus-upload.php",{method:"OPTIONS",signal:AbortSignal.timeout(2e3)})).headers.get("Tus-Resumable")?v=!0:(console.warn("Tus.io server response invalid, falling back to traditional upload"),v=!1)}catch(e){console.warn("Tus.io server not available, falling back to traditional upload:",e),v=!1}}function D(e,s={}){return new Promise((t,n)=>{const{comment:o="",dlkey:a="",delkey:i="",replacekey:r="",maxDownloads:c=null,expiresDays:l=null,folderId:d=null}=s,T=window.config?.upload_method_priority||"resumable",p=window.config?.upload_fallback_enabled!==!1;if(T==="normal"){B(e,s).then(t).catch(u=>{p&&v?b():n(u)});return}if(!v){p?B(e,s).then(t).catch(n):n(new Error("Resumable upload not available and fallback disabled"));return}b();function b(){if(!window.tus){n(new Error("Tus.js not available"));return}const u={filename:e.name,filetype:e.type||"application/octet-stream"},h=R();h?u.csrf_token=h:console.error("CSRF Debug - Token not found or empty!"),o&&(u.comment=o),a&&(u.dlkey=a),i&&(u.delkey=i),c&&(u.max_downloads=c.toString()),l&&(u.expires_days=l.toString()),d&&(u.folder_id=d.toString()),r&&(u.replacekey=r.toString());const I=new window.tus.Upload(e,{endpoint:"/api/tus-upload.php",retryDelays:[0,1e3,3e3,5e3],metadata:u,chunkSize:512*1024,removeFingerprintOnSuccess:!0,resume:!1,onError:f=>{console.error("Tus upload failed:",f),delete y[e.name],p?B(e,s).then(t).catch(n):n(f)},onProgress:(f,k)=>{const S=Math.round(f/k*100),E=Date.now(),g=y[e.name];if(g){g.lastTime||(g.lastTime=E,g.lastBytes=0);const F=(E-g.lastTime)/1e3,z=f-(g.lastBytes||0),K=F>0?z/F:0;g.lastTime=E,g.lastBytes=f,g.progress=S,L(e.name,S,f,k,"resumable",K)}},onSuccess:()=>{O(e.name),t()}});I.start(),y[e.name]={upload:I,file:e,options:s,progress:0}}})}async function B(e,s){const t=new FormData;t.append("file",e),t.append("comment",s.comment||"");const n=R();return n?t.append("csrf_token",n):console.error("Fallback CSRF Debug - Token not found or empty!"),t.append("dlkey",s.dlkey||""),t.append("delkey",s.delkey||""),t.append("replacekey",s.replacekey||""),s.maxDownloads&&t.append("max_downloads",s.maxDownloads.toString()),s.expiresDays&&t.append("expires_days",s.expiresDays.toString()),s.folderId&&t.append("folder_id",s.folderId.toString()),new Promise((o,a)=>{let r=Date.now(),c=0;const l=new XMLHttpRequest;l.upload&&l.upload.addEventListener("progress",d=>{if(d.lengthComputable){const T=Math.round(d.loaded/d.total*100),p=Date.now(),b=(p-r)/1e3,u=d.loaded-c,h=b>0?u/b:0;r=p,c=d.loaded,L(e.name,T,d.loaded,d.total,"fallback",h)}}),l.addEventListener("load",()=>{try{const d=JSON.parse(l.responseText);d.status==="ok"||d.status==="success"?(O(e.name,"fallback"),o()):(console.error("Fallback upload failed with response:",d),A(d,e.name),a(new Error("Upload failed: "+d.status)))}catch{console.error("Failed to parse response:",l.responseText),a(new Error("Invalid response format"))}}),l.addEventListener("error",()=>{console.error("Fallback upload network error:",{status:l.status,statusText:l.statusText,responseText:l.responseText});const d={status:"network_error",message:"Network error: "+l.statusText};A(d,e.name),a(new Error("Network error: "+l.statusText))}),l.open("POST","/api/upload.php"),l.send(t)})}function L(e,s,t,n,o,a){const i=document.querySelectorAll(".file-item");let r=null;for(const c of i)if(c.dataset.filename===e){r=c;break}if(r){C(r,"uploading");const c=r.querySelector(".upload-progress"),l=r.querySelector(".upload-status"),d=r.querySelector(".detailed-progress");c&&(c.style.display="block"),l&&(l.style.display="block"),d&&(d.style.display="block");const T=r.querySelector(".upload-progress-bar");T&&(T.style.width=s+"%");const p=r.querySelector(".upload-method-indicator");if(p&&(m(p,"resumable"),m(p,"fallback"),m(p,"failed"),C(p,o),p.textContent=o==="resumable"?"再開可能":"通常",p.style.display="block"),o==="resumable"){const k=r.querySelector(".upload-control-btn.pause"),S=r.querySelector(".upload-control-btn.cancel");k&&(k.style.display="block"),S&&(S.style.display="block")}const b=M(t)+" / "+M(n),u=a?j(a):"計算中...";l&&(l.textContent=s+"% ("+b+")");const h=r.querySelector(".progress-percentage"),I=r.querySelector(".progress-size"),f=r.querySelector(".speed-info");if(h&&(h.textContent=s+"%"),I&&(I.textContent=b),f&&(f.textContent="速度: "+u),a&&a>0&&f){const k=(n-t)/a,S=Q(k);f.textContent="速度: "+u+" | 残り: "+S}}U()}function O(e,s){const t=document.querySelectorAll(".file-item");let n=null;for(const o of t)if(o.dataset.filename===e){n=o;break}if(n){m(n,"uploading"),m(n,"paused"),C(n,"completed");const o=n.querySelector(".upload-progress-bar"),a=n.querySelector(".upload-status"),i=n.querySelectorAll(".upload-controls button"),r=n.querySelector(".detailed-progress");o&&(o.style.width="100%"),a&&(a.textContent="完了"),i.forEach(l=>l.style.display="none"),r&&(r.style.display="none");const c=n.querySelector(".file-info");c&&!c.querySelector(".upload-success-icon")&&c.insertAdjacentHTML("beforeend",`
        <span class="upload-success-icon" style="color: #5cb85c; margin-left: 10px;">
          <span class="glyphicon glyphicon-ok-circle"></span>
        </span>
      `)}delete y[e],U(),Object.keys(y).length===0&&setTimeout(async()=>{const o=w(".global-upload-status");o&&m(o,"active"),document.querySelectorAll(".file-item").forEach(r=>{r.parentNode&&r.parentNode.removeChild(r)});const i=document.getElementById("selectedFilesContainer");i&&(i.style.transition="all 0.3s ease",i.style.opacity="0",i.style.transform="translateY(-10px)",setTimeout(()=>{i.style.display="none"},300));try{window.folderManager?await window.folderManager.refreshAll():window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload()}catch(r){console.error("resumable-upload: 更新処理エラー:",r),window.location.reload()}},2e3)}function J(e){const s=y[e];if(s?.upload){s.upload.abort();const t=document.querySelectorAll(".file-item");for(const n of t){const o=n;if(o.dataset.filename===e){m(o,"uploading"),C(o,"paused");const a=o.querySelector(".upload-control-btn.pause"),i=o.querySelector(".upload-control-btn.resume"),r=o.querySelector(".upload-status");a&&(a.style.display="none"),i&&(i.style.display="block"),r&&(r.textContent="一時停止");break}}return!0}return!1}function X(e){const s=y[e];if(s?.upload){s.upload.start();const t=document.querySelectorAll(".file-item");for(const n of t){const o=n;if(o.dataset.filename===e){m(o,"paused"),C(o,"uploading");const a=o.querySelector(".upload-control-btn.resume"),i=o.querySelector(".upload-control-btn.pause"),r=o.querySelector(".upload-status");a&&(a.style.display="none"),i&&(i.style.display="block"),r&&(r.textContent="再開中...");break}}return!0}return!1}function Y(e){const s=y[e];if(s?.upload){s.upload.abort();const t=document.querySelectorAll(".file-item");for(const n of t){const o=n;if(o.dataset.filename===e){m(o,"uploading"),m(o,"paused"),C(o,"failed");const a=o.querySelectorAll(".upload-controls button"),i=o.querySelector(".upload-status"),r=o.querySelector(".upload-method-indicator");a.forEach(c=>c.style.display="none"),i&&(i.textContent="キャンセル済み"),r&&(m(r,"resumable"),C(r,"failed"));break}}return delete y[e],U(),!0}return!1}async function $(){const e=document.getElementById("replaceKeyInput");if(!e){await x("差し替えキー入力フィールドが見つかりません。");return}const s=e.value;if(!s||s.trim()===""){await x("差し替えキーの入力は必須です。");return}const t=document.getElementById("multipleFileInput"),n=window.selectedFiles;if(n&&n.length>0){try{await _(n)}catch(o){if(o instanceof Error&&o.message.includes("キーが弱すぎます"))await x(o.message);else throw o}return}if(t?.files&&t.files.length>0){const o=Array.from(t.files);if(o.length===1)try{const a=P();D(o[0],a)}catch(a){if(a instanceof Error&&a.message.includes("キーが弱すぎます"))await x(a.message);else throw a}else try{await _(o)}catch(a){if(a instanceof Error&&a.message.includes("キーが弱すぎます"))await x(a.message);else throw a}return}console.warn("No files selected for upload"),await x("ファイルが選択されていません。ファイルを選択してからアップロードボタンを押してください。")}async function _(e){if(e.length===0)return;window.isUploading=!0;const s=w("#errorContainer"),t=w("#uploadContainer");s&&(s.style.display="none"),t&&(t.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(r=>r.style.display="block");let o;try{o=P()}catch(r){if(r instanceof Error&&r.message.includes("キーが弱すぎます")){await x(r.message),window.isUploading=!1,t&&(t.style.display="none");return}else throw r}let a=0;const i=e.length;e.forEach((r,c)=>{setTimeout(()=>{D(r,o).then(()=>{a++,a===i&&(window.isUploading=!1,t&&(t.style.display="none"))}).catch(l=>{console.error("Upload failed for",r.name,l),a++,a===i&&(window.isUploading=!1,t&&(t.style.display="none"))})},c*100)})}function P(){const e=document.getElementById("commentInput"),s=document.getElementById("dleyInput"),t=document.getElementById("delkeyInput"),n=document.getElementById("replaceKeyInput"),o=document.getElementById("maxDownloadsUploadInput"),a=document.getElementById("expiresDaysUploadInput"),i=document.getElementById("folder-select"),r=s?.value||"",c=t?.value||"",l=n?.value||"";if(r&&q(r))throw new Error("DLキーが弱すぎます。より複雑なキーを設定してください。");if(c&&q(c))throw new Error("削除キーが弱すぎます。より複雑なキーを設定してください。");if(l&&q(l))throw new Error("差し替えキーが弱すぎます。より複雑なキーを設定してください。");return{comment:e?.value||"",dlkey:r,delkey:c,replacekey:l,maxDownloads:o&&parseInt(o.value)||void 0,expiresDays:a&&parseInt(a.value)||void 0,folderId:i?.value||void 0}}function U(){const e=Object.keys(y).length,s=w(".global-upload-status");s&&(m(s,"active"),s.style.display="none");const t=w("#progressContainer"),n=w("#progressBar"),o=w("#progressText"),a=w("#uploadStatus");if(e===0){t&&(t.style.display="none");return}let i=0,r=0;Object.values(y).forEach(l=>{l.progress!==void 0&&(i+=l.progress),l.completed&&r++});const c=Math.round(i/e);t&&(t.style.display="block"),n&&(n.style.width=c+"%"),o&&(o.textContent=c+"%"),a&&(a.textContent="完了: "+r+"/"+e)}function M(e){if(e===0)return"0 Bytes";const s=1024,t=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(s));return parseFloat((e/Math.pow(s,n)).toFixed(1))+" "+t[n]}function j(e){return e<1024?e.toFixed(1)+" B/s":e<1024*1024?(e/1024).toFixed(1)+" KB/s":e<1024*1024*1024?(e/(1024*1024)).toFixed(1)+" MB/s":(e/(1024*1024*1024)).toFixed(1)+" GB/s"}function Q(e){return e<60?Math.round(e)+"秒":e<3600?Math.round(e/60)+"分":Math.round(e/3600)+"時間"}function A(e,s){let t="";switch(e.error_code?e.error_code:e.status){case"filesize_over":t="ファイル容量が大きすぎます: "+s;break;case"extension_error":t="許可されていない拡張子です: "+s+" (拡張子: "+e.ext+")";break;case"comment_error":t="コメントの文字数が規定数を超えています。";break;case"dlkey_required":t="DLキーは必須入力です。";break;case"delkey_required":t="DELキーは必須入力です。";break;case"sqlwrite_error":t="データベースの書き込みに失敗しました: "+s;break;case"network_error":t=e.message+": "+s;break;default:t="アップロードに失敗しました: "+s;break}G(t)}window.enhancedFileUpload=$;window.pauseUpload=J;window.resumeUpload=X;window.cancelUpload=Y;window.uploadFileResumable=D;
