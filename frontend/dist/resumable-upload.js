import{r as N,i as G,$ as b,d as m,e as T,b as W}from"./error-handling.js";import{g as R}from"./http.js";import{a as v}from"./modal.js";import{h as j,a as J}from"./bootstrap.js";import{i as q}from"./password-strength.js";const y={};let I=!1,E=!1;N(()=>{G(),X(),b(".global-upload-status")||document.body.insertAdjacentHTML("beforeend",`
      <div class="global-upload-status">
        <h6>アップロード進行状況</h6>
        <div class="global-upload-progress">
          <div class="global-upload-progress-bar"></div>
        </div>
        <div class="global-upload-info"></div>
      </div>
    `),document.getElementById("uploadErrorToast")||document.body.insertAdjacentHTML("beforeend",`
      <div id="uploadErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1060;">
        <div class="d-flex">
          <div class="toast-body">アップロードに失敗しました。</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`)});async function X(){if(typeof window.tus>"u"){console.warn("Tus.js library not loaded, falling back to traditional upload"),I=!1;return}try{(await fetch("/api/tus-upload.php",{method:"OPTIONS",signal:AbortSignal.timeout(2e3)})).headers.get("Tus-Resumable")?I=!0:(console.warn("Tus.io server response invalid, falling back to traditional upload"),I=!1)}catch(e){console.warn("Tus.io server not available, falling back to traditional upload:",e),I=!1}}function D(e,r={}){return new Promise((t,n)=>{const{comment:s="",dlkey:a="",delkey:i="",replacekey:o="",maxDownloads:d=null,expiresDays:l=null,folderId:c=null}=r,g=window.config?.upload_method_priority||"resumable",p=window.config?.upload_fallback_enabled!==!1;if(g==="normal"){F(e,r).then(t).catch(u=>{p&&I?h():n(u)});return}if(!I){p?F(e,r).then(t).catch(n):n(new Error("Resumable upload not available and fallback disabled"));return}h();function h(){if(!window.tus){n(new Error("Tus.js not available"));return}const u={filename:e.name,filetype:e.type||"application/octet-stream"},k=R();k?u.csrf_token=k:console.error("CSRF Debug - Token not found or empty!"),s&&(u.comment=s),a&&(u.dlkey=a),i&&(u.delkey=i),d&&(u.max_downloads=d.toString()),l&&(u.expires_days=l.toString()),c&&(u.folder_id=c.toString()),o&&(u.replacekey=o.toString());const C=new window.tus.Upload(e,{endpoint:"/api/tus-upload.php",retryDelays:[0,1e3,3e3,5e3],metadata:u,chunkSize:512*1024,removeFingerprintOnSuccess:!0,resume:!1,onError:f=>{console.error("Tus upload failed:",f),delete y[e.name],E=!0,p?F(e,r).then(t).catch(n):n(f)},onProgress:(f,x)=>{const S=Math.round(f/x*100),B=Date.now(),w=y[e.name];if(w){w.lastTime||(w.lastTime=B,w.lastBytes=0);const M=(B-w.lastTime)/1e3,P=f-(w.lastBytes||0),K=M>0?P/M:0;w.lastTime=B,w.lastBytes=f,w.progress=S,z(e.name,S,f,x,"resumable",K)}},onSuccess:()=>{H(e.name),t()}});C.start(),y[e.name]={upload:C,file:e,options:r,progress:0}}})}async function F(e,r){const t=new FormData;t.append("file",e),t.append("comment",r.comment||"");const n=R();return n?t.append("csrf_token",n):console.error("Fallback CSRF Debug - Token not found or empty!"),t.append("dlkey",r.dlkey||""),t.append("delkey",r.delkey||""),t.append("replacekey",r.replacekey||""),r.maxDownloads&&t.append("max_downloads",r.maxDownloads.toString()),r.expiresDays&&t.append("expires_days",r.expiresDays.toString()),r.folderId&&t.append("folder_id",r.folderId.toString()),new Promise((s,a)=>{let o=Date.now(),d=0;const l=new XMLHttpRequest;l.upload&&l.upload.addEventListener("progress",c=>{if(c.lengthComputable){const g=Math.round(c.loaded/c.total*100),p=Date.now(),h=(p-o)/1e3,u=c.loaded-d,k=h>0?u/h:0;o=p,d=c.loaded,z(e.name,g,c.loaded,c.total,"fallback",k)}}),l.addEventListener("load",()=>{try{const c=JSON.parse(l.responseText);c.status==="ok"||c.status==="success"?(H(e.name,"fallback"),s()):(console.error("Fallback upload failed with response:",c),L(c,e.name),E=!0,a(new Error("Upload failed: "+c.status)))}catch{console.error("Failed to parse response:",l.responseText),E=!0,a(new Error("Invalid response format"))}}),l.addEventListener("error",()=>{console.error("Fallback upload network error:",{status:l.status,statusText:l.statusText,responseText:l.responseText});const c={status:"network_error",message:"Network error: "+l.statusText};L(c,e.name),E=!0,a(new Error("Network error: "+l.statusText))}),l.open("POST","/api/upload.php"),l.send(t)})}function z(e,r,t,n,s,a){const i=document.querySelectorAll(".file-item");let o=null;for(const d of i)if(d.dataset.filename===e){o=d;break}if(o){T(o,"uploading");const d=o.querySelector(".upload-progress"),l=o.querySelector(".upload-status"),c=o.querySelector(".detailed-progress");d&&(d.style.display="block"),l&&(l.style.display="block"),c&&(c.style.display="block");const g=o.querySelector(".upload-progress-bar");g&&(g.style.width=r+"%");const p=o.querySelector(".upload-method-indicator");if(p&&(m(p,"resumable"),m(p,"fallback"),m(p,"failed"),T(p,s),p.textContent=s==="resumable"?"再開可能":"通常",p.style.display="block"),s==="resumable"){const x=o.querySelector(".upload-control-btn.pause"),S=o.querySelector(".upload-control-btn.cancel");x&&(x.style.display="block"),S&&(S.style.display="block")}const h=A(t)+" / "+A(n),u=a?Z(a):"計算中...";l&&(l.textContent=r+"% ("+h+")");const k=o.querySelector(".progress-percentage"),C=o.querySelector(".progress-size"),f=o.querySelector(".speed-info");if(k&&(k.textContent=r+"%"),C&&(C.textContent=h),f&&(f.textContent="速度: "+u),a&&a>0&&f){const x=(n-t)/a,S=ee(x);f.textContent="速度: "+u+" | 残り: "+S}}U()}function H(e,r){const t=document.querySelectorAll(".file-item");let n=null;for(const s of t)if(s.dataset.filename===e){n=s;break}if(n){m(n,"uploading"),m(n,"paused"),T(n,"completed");const s=n.querySelector(".upload-progress-bar"),a=n.querySelector(".upload-status"),i=n.querySelectorAll(".upload-controls button"),o=n.querySelector(".detailed-progress");s&&(s.style.width="100%"),a&&(a.textContent="完了"),i.forEach(l=>l.style.display="none"),o&&(o.style.display="none");const d=n.querySelector(".file-info");d&&!d.querySelector(".upload-success-icon")&&d.insertAdjacentHTML("beforeend",`
        <span class="upload-success-icon" style="color: #5cb85c; margin-left: 10px;">
          <span class="glyphicon glyphicon-ok-circle"></span>
        </span>
      `)}delete y[e],U(),Object.keys(y).length===0&&(E?J("uploadErrorToast"):j("uploadModal"),setTimeout(async()=>{const s=b(".global-upload-status");s&&m(s,"active"),document.querySelectorAll(".file-item").forEach(o=>{o.parentNode&&o.parentNode.removeChild(o)});try{const o=window;Array.isArray(o.selectedFiles)&&(o.selectedFiles.length=0);const d=document.getElementById("selectedFilesList");d&&(d.innerHTML="");const l=document.getElementById("multipleFileInput"),c=document.getElementById("folderInput");l&&(l.value=""),c&&(c.value="");const g=document.querySelector("#selectedFilesContainer .file-count");g&&(g.textContent="0")}catch{}const i=document.getElementById("selectedFilesContainer");i&&(i.style.transition="all 0.3s ease",i.style.opacity="0",i.style.transform="translateY(-10px)",setTimeout(()=>{i.style.display="none"},300));try{window.folderManager?await window.folderManager.refreshAll():window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload()}catch(o){console.error("resumable-upload: 更新処理エラー:",o),window.location.reload()}},2e3))}function Y(e){const r=y[e];if(r?.upload){r.upload.abort();const t=document.querySelectorAll(".file-item");for(const n of t){const s=n;if(s.dataset.filename===e){m(s,"uploading"),T(s,"paused");const a=s.querySelector(".upload-control-btn.pause"),i=s.querySelector(".upload-control-btn.resume"),o=s.querySelector(".upload-status");a&&(a.style.display="none"),i&&(i.style.display="block"),o&&(o.textContent="一時停止");break}}return!0}return!1}function $(e){const r=y[e];if(r?.upload){r.upload.start();const t=document.querySelectorAll(".file-item");for(const n of t){const s=n;if(s.dataset.filename===e){m(s,"paused"),T(s,"uploading");const a=s.querySelector(".upload-control-btn.resume"),i=s.querySelector(".upload-control-btn.pause"),o=s.querySelector(".upload-status");a&&(a.style.display="none"),i&&(i.style.display="block"),o&&(o.textContent="再開中...");break}}return!0}return!1}function Q(e){const r=y[e];if(r?.upload){r.upload.abort();const t=document.querySelectorAll(".file-item");for(const n of t){const s=n;if(s.dataset.filename===e){m(s,"uploading"),m(s,"paused"),T(s,"failed");const a=s.querySelectorAll(".upload-controls button"),i=s.querySelector(".upload-status"),o=s.querySelector(".upload-method-indicator");a.forEach(d=>d.style.display="none"),i&&(i.textContent="キャンセル済み"),o&&(m(o,"resumable"),T(o,"failed"));break}}return delete y[e],U(),!0}return!1}async function V(){const e=document.getElementById("replaceKeyInput");if(!e){await v("差し替えキー入力フィールドが見つかりません。");return}const r=e.value;if(!r||r.trim()===""){await v("差し替えキーの入力は必須です。");return}const t=document.getElementById("multipleFileInput"),n=window.selectedFiles;if(n&&n.length>0){try{await _(n)}catch(s){if(s instanceof Error&&s.message.includes("キーが弱すぎます"))await v(s.message);else throw s}return}if(t?.files&&t.files.length>0){const s=Array.from(t.files);if(s.length===1)try{const a=O();D(s[0],a)}catch(a){if(a instanceof Error&&a.message.includes("キーが弱すぎます"))await v(a.message);else throw a}else try{await _(s)}catch(a){if(a instanceof Error&&a.message.includes("キーが弱すぎます"))await v(a.message);else throw a}return}console.warn("No files selected for upload"),await v("ファイルが選択されていません。ファイルを選択してからアップロードボタンを押してください。")}async function _(e){if(e.length===0)return;window.isUploading=!0;const r=b("#errorContainer"),t=b("#uploadContainer");r&&(r.style.display="none"),t&&(t.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(o=>o.style.display="block");let s;try{s=O()}catch(o){if(o instanceof Error&&o.message.includes("キーが弱すぎます")){await v(o.message),window.isUploading=!1,t&&(t.style.display="none");return}else throw o}let a=0;const i=e.length;e.forEach((o,d)=>{setTimeout(()=>{D(o,s).then(()=>{a++,a===i&&(window.isUploading=!1,t&&(t.style.display="none"))}).catch(l=>{console.error("Upload failed for",o.name,l),a++,a===i&&(window.isUploading=!1,t&&(t.style.display="none"))})},d*100)})}function O(){const e=document.getElementById("commentInput"),r=document.getElementById("dleyInput"),t=document.getElementById("delkeyInput"),n=document.getElementById("replaceKeyInput"),s=document.getElementById("maxDownloadsUploadInput"),a=document.getElementById("expiresDaysUploadInput"),i=document.getElementById("folder-select"),o=r?.value||"",d=t?.value||"",l=n?.value||"";if(o&&q(o))throw new Error("DLキーが弱すぎます。より複雑なキーを設定してください。");if(d&&q(d))throw new Error("削除キーが弱すぎます。より複雑なキーを設定してください。");if(l&&q(l))throw new Error("差し替えキーが弱すぎます。より複雑なキーを設定してください。");return{comment:e?.value||"",dlkey:o,delkey:d,replacekey:l,maxDownloads:s&&parseInt(s.value)||void 0,expiresDays:a&&parseInt(a.value)||void 0,folderId:i?.value||void 0}}function U(){const e=Object.keys(y).length,r=b(".global-upload-status");r&&(m(r,"active"),r.style.display="none");const t=b("#progressContainer"),n=b("#progressBar"),s=b("#progressText"),a=b("#uploadStatus");if(e===0){t&&(t.style.display="none");return}let i=0,o=0;Object.values(y).forEach(l=>{l.progress!==void 0&&(i+=l.progress),l.completed&&o++});const d=Math.round(i/e);t&&(t.style.display="block"),n&&(n.style.width=d+"%"),s&&(s.textContent=d+"%"),a&&(a.textContent="完了: "+o+"/"+e)}function A(e){if(e===0)return"0 Bytes";const r=1024,t=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(r));return parseFloat((e/Math.pow(r,n)).toFixed(1))+" "+t[n]}function Z(e){return e<1024?e.toFixed(1)+" B/s":e<1024*1024?(e/1024).toFixed(1)+" KB/s":e<1024*1024*1024?(e/(1024*1024)).toFixed(1)+" MB/s":(e/(1024*1024*1024)).toFixed(1)+" GB/s"}function ee(e){return e<60?Math.round(e)+"秒":e<3600?Math.round(e/60)+"分":Math.round(e/3600)+"時間"}function L(e,r){let t="";switch(e.error_code?e.error_code:e.status){case"filesize_over":t="ファイル容量が大きすぎます: "+r;break;case"extension_error":t="許可されていない拡張子です: "+r+" (拡張子: "+e.ext+")";break;case"comment_error":t="コメントの文字数が規定数を超えています。";break;case"dlkey_required":t="DLキーは必須入力です。";break;case"delkey_required":t="DELキーは必須入力です。";break;case"sqlwrite_error":t="データベースの書き込みに失敗しました: "+r;break;case"network_error":t=e.message+": "+r;break;default:t="アップロードに失敗しました: "+r;break}W(t)}window.enhancedFileUpload=V;window.pauseUpload=Y;window.resumeUpload=$;window.cancelUpload=Q;window.uploadFileResumable=D;
