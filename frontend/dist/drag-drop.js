import{r as L,i as B,$ as c,e as h,d as I}from"./error-handling.js";import{s as f}from"./modal.js";import{i as y}from"./password-strength.js";import"./bootstrap.js";let d=[],p=!1;L(()=>{B(),x()});function x(){const e=c("#dragDropArea"),t=c("#selectFilesBtn"),r=c("#selectFolderBtn"),i=c("#multipleFileInput"),l=c("#folderInput"),n=c("#clearFilesBtn");if(!e){console.warn("Drag drop area not found");return}e.addEventListener("dragover",C),e.addEventListener("dragenter",M),e.addEventListener("dragleave",S),e.addEventListener("drop",T),t&&t.addEventListener("click",()=>{p||i?.click()}),e.addEventListener("click",o=>{if(p)return;o.target.tagName!=="BUTTON"&&i?.click()}),r&&r.addEventListener("click",()=>{p||l?.click()}),i&&i.addEventListener("change",o=>{const s=o.target;s.files&&m(s.files)}),l&&l.addEventListener("change",o=>{const s=o.target;s.files&&m(s.files)}),n&&n.addEventListener("click",()=>{p||k()}),document.addEventListener("click",o=>{if(o.target.id==="uploadBtn"){if(o.preventDefault(),o.stopPropagation(),typeof window.enhancedFileUpload=="function")window.enhancedFileUpload();else if(d.length>0)E();else{const a=c("#multipleFileInput");a?.files&&a.files.length>0?F(a.files[0]):f("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")}return!1}})}function C(e){e.preventDefault(),e.stopPropagation(),h(e.currentTarget,"drag-over")}function M(e){e.preventDefault(),e.stopPropagation(),h(e.currentTarget,"drag-over")}function S(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget;t.contains(e.relatedTarget)||I(t,"drag-over")}function T(e){if(e.preventDefault(),e.stopPropagation(),I(e.currentTarget,"drag-over"),p)return;const t=e.dataTransfer?.files;t&&m(t)}function m(e){if(!(!e||e.length===0)){for(let t=0;t<e.length;t++){const r=e[t];d.some(l=>l.name===r.name&&l.size===r.size&&l.lastModified===r.lastModified)||d.push(r)}g(),U()}}function g(){const e=c("#selectedFilesList");if(!e)return;e.innerHTML="",d.forEach((n,o)=>{const s=document.createElement("div");s.className="file-item",s.dataset.filename=n.name;const a=q(n.name),u=n.name,w=z(n.size);s.innerHTML=`
      <div class="upload-method-indicator" style="display: none;"></div>
      <span class="file-icon">${a}</span>
      <div class="file-info">
        <span class="file-name">${A(u)}</span>
        <span class="file-size">${w}</span>
      </div>
      <div class="upload-controls">
        <button type="button" class="upload-control-btn pause" title="ä¸€æ™‚åœæ­¢" style="display: none;">
          <span class="glyphicon glyphicon-pause"></span>
        </button>
        <button type="button" class="upload-control-btn resume" title="å†é–‹" style="display: none;">
          <span class="glyphicon glyphicon-play"></span>
        </button>
        <button type="button" class="upload-control-btn cancel" title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«" style="display: none;">
          <span class="glyphicon glyphicon-stop"></span>
        </button>
      </div>
      <button type="button" class="file-remove" data-index="${o}">
        <span class="glyphicon glyphicon-remove"></span>
      </button>
      <div class="upload-progress" style="display: none;">
        <div class="upload-progress-bar"></div>
      </div>
      <div class="upload-status" style="display: none;"></div>
      <div class="detailed-progress" style="display: none;">
        <div class="progress-text">
          <span class="progress-percentage">0%</span>
          <span class="progress-size">0B / ${w}</span>
        </div>
        <div class="speed-info">é€Ÿåº¦: è¨ˆç®—ä¸­...</div>
      </div>
    `,e.appendChild(s)}),e.querySelectorAll(".file-remove").forEach(n=>{n.addEventListener("click",o=>{if(p)return;const s=o.currentTarget,a=parseInt(s.dataset.index||"0");d.splice(a,1),g(),d.length===0&&v()})}),e.querySelectorAll(".upload-control-btn.pause").forEach(n=>{n.addEventListener("click",o=>{const a=o.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.pauseUpload=="function"&&window.pauseUpload(a)})}),e.querySelectorAll(".upload-control-btn.resume").forEach(n=>{n.addEventListener("click",o=>{const a=o.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.resumeUpload=="function"&&window.resumeUpload(a)})}),e.querySelectorAll(".upload-control-btn.cancel").forEach(n=>{n.addEventListener("click",o=>{const a=o.currentTarget.closest(".file-item").dataset.filename;a&&typeof window.cancelUpload=="function"&&window.cancelUpload(a)})})}function q(e){const t=e.split(".").pop()?.toLowerCase()||"";return{jpg:"ğŸ–¼ï¸",jpeg:"ğŸ–¼ï¸",png:"ğŸ–¼ï¸",gif:"ğŸ–¼ï¸",bmp:"ğŸ–¼ï¸",svg:"ğŸ–¼ï¸",webp:"ğŸ–¼ï¸",mp4:"ğŸ¬",avi:"ğŸ¬",mov:"ğŸ¬",wmv:"ğŸ¬",flv:"ğŸ¬",mkv:"ğŸ¬",webm:"ğŸ¬",mp3:"ğŸµ",wav:"ğŸµ",aac:"ğŸµ",ogg:"ğŸµ",flac:"ğŸµ",m4a:"ğŸµ",wma:"ğŸµ",pdf:"ğŸ“„",doc:"ğŸ“",docx:"ğŸ“",xls:"ğŸ“Š",xlsx:"ğŸ“Š",ppt:"ğŸ“Š",pptx:"ğŸ“Š",zip:"ğŸ—œï¸",rar:"ğŸ—œï¸",lzh:"ğŸ—œï¸","7z":"ğŸ—œï¸",tar:"ğŸ—œï¸",gz:"ğŸ—œï¸",html:"ğŸŒ",css:"ğŸ¨",js:"âš™ï¸",json:"âš™ï¸",xml:"âš™ï¸",sql:"ğŸ—ƒï¸"}[t]||"ğŸ“"}function z(e){if(e===0)return"0 Bytes";const t=1024,r=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(1))+" "+r[i]}function U(){const e=c("#selectedFilesContainer");e&&(e.style.display="block",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.transition="all 0.3s ease",e.style.opacity="1",e.style.transform="translateY(0)"},10))}function v(){const e=c("#selectedFilesContainer");e&&(e.style.transition="all 0.3s ease",e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{e.style.display="none"},300))}function k(){d=[],g(),v();const e=c("#multipleFileInput"),t=c("#folderInput");e&&(e.value=""),t&&(t.value="")}async function E(){if(d.length===0){await f("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");return}if(p){await f("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚");return}p=!0;const e=c("#errorContainer"),t=c("#uploadContainer");e&&(e.style.display="none"),t&&(t.style.display="block"),document.querySelectorAll(".file-item .upload-progress").forEach(i=>{i.style.display="block"}),b(0)}async function b(e){if(e>=d.length){p=!1,d.length=0;const n=c("#uploadContainer"),o=c("#selectedFilesList");n&&(n.style.display="none"),o&&(o.innerHTML="");const s=document.querySelector("#selectedFilesContainer .file-count");s&&(s.textContent="0"),v(),window.fileManagerInstance&&await window.fileManagerInstance.refreshFromServer(),window.folderManager&&await window.folderManager.refreshAll(),!window.fileManagerInstance&&!window.folderManager&&window.location.reload();return}const t=d[e],i=document.querySelectorAll(".file-item")[e],l=i.querySelector(".upload-progress-bar");try{const n=D();await F(t,n,l),l&&(l.style.width="100%"),i.style.backgroundColor="#d4edda",setTimeout(()=>{b(e+1)},500)}catch(n){n instanceof Error&&n.message.includes("ã‚­ãƒ¼ãŒå¼±ã™ãã¾ã™")?await f(n.message):_(n,t.name),p=!1;const o=c("#uploadContainer");o&&(o.style.display="none")}}async function F(e,t,r){return new Promise((i,l)=>{const n=new FormData;n.append("file",e);let o;try{o=t||D()}catch(a){if(a instanceof Error&&a.message.includes("ã‚­ãƒ¼ãŒå¼±ã™ãã¾ã™")){l(a);return}else throw a}n.append("comment",o.comment||""),n.append("dlkey",o.dlkey||""),n.append("delkey",o.delkey||""),n.append("replacekey",o.replacekey||""),o.maxDownloads&&o.maxDownloads>0&&n.append("max_downloads",o.maxDownloads.toString()),o.expiresDays&&o.expiresDays>0&&n.append("expires_days",o.expiresDays.toString());const s=new XMLHttpRequest;r&&s.upload&&s.upload.addEventListener("progress",a=>{if(a.lengthComputable){const u=Math.round(a.loaded/a.total*100);r.style.width=u+"%"}}),s.addEventListener("load",()=>{try{const a=JSON.parse(s.responseText);a.status==="ok"?i():l(a)}catch{l({status:"network_error",message:"ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ"})}}),s.addEventListener("error",()=>{l({status:"network_error",message:"ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"})}),s.open("POST","/api/upload.php"),s.send(n)})}function D(){const e=document.getElementById("commentInput"),t=document.getElementById("dlkeyInput"),r=document.getElementById("delkeyInput"),i=document.getElementById("replaceKeyInput"),l=document.getElementById("maxDownloadsUploadInput"),n=document.getElementById("expiresDaysUploadInput"),o=document.getElementById("folder-select"),s=t?.value||"",a=r?.value||"",u=i?.value||"";if(s&&y(s))throw new Error("DLã‚­ãƒ¼ãŒå¼±ã™ãã¾ã™ã€‚ã‚ˆã‚Šè¤‡é›‘ãªã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");if(a&&y(a))throw new Error("å‰Šé™¤ã‚­ãƒ¼ãŒå¼±ã™ãã¾ã™ã€‚ã‚ˆã‚Šè¤‡é›‘ãªã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");if(u&&y(u))throw new Error("å·®ã—æ›¿ãˆã‚­ãƒ¼ãŒå¼±ã™ãã¾ã™ã€‚ã‚ˆã‚Šè¤‡é›‘ãªã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");return{comment:e?.value||"",dlkey:s,delkey:a,replacekey:u,maxDownloads:l&&parseInt(l.value)||void 0,expiresDays:n&&parseInt(n.value)||void 0,folderId:o?.value||void 0}}function _(e,t){let r="";switch(e.error_code?e.error_code:e.status){case"filesize_over":r="ãƒ•ã‚¡ã‚¤ãƒ«å®¹é‡ãŒå¤§ãã™ãã¾ã™: "+t;break;case"extension_error":r="è¨±å¯ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µå­ã§ã™: "+t+" (æ‹¡å¼µå­: "+e.ext+")";break;case"comment_error":r="ã‚³ãƒ¡ãƒ³ãƒˆã®æ–‡å­—æ•°ãŒè¦å®šæ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚";break;case"dlkey_required":r="DLã‚­ãƒ¼ã¯å¿…é ˆå…¥åŠ›ã§ã™ã€‚";break;case"delkey_required":r="DELã‚­ãƒ¼ã¯å¿…é ˆå…¥åŠ›ã§ã™ã€‚";break;case"sqlwrite_error":r="ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: "+t;break;case"network_error":r=e.message+": "+t;break;default:r="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: "+t;break}const l=c("#errorContainer"),n=l?.querySelector(".panel-body");n&&(n.textContent=r),l&&(l.style.display="block")}function A(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}window.selectedFiles=d;window.isUploading=p;window.handleFiles=m;window.uploadMultipleFiles=E;window.clearSelectedFiles=k;
