import{r as D,i as M,$ as e,b as p,c as h,a as y,d as u,e as m}from"./error-handling.js";import{g as k,p as v,a as C}from"./http.js";import{h as F,s as w}from"./bootstrap.js";let f=null;D(()=>{M(),_()});function _(){const n=e("#saveCommentBtn");n&&n.addEventListener("click",N);const o=e("#replaceFileBtn");o&&o.addEventListener("click",R),document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(d=>{d.addEventListener("shown.bs.tab",U)});const t=e("#generateShareLinkBtn");t&&t.addEventListener("click",H);const a=e("#saveShareSettingsBtn");a&&a.addEventListener("click",P),document.querySelectorAll('input[name="shareFormat"]').forEach(d=>{d.addEventListener("change",q)});const s=e("#copyShareUrlBtn");s&&s.addEventListener("click",b);const l=e("#shareMaxDownloads"),c=e("#shareExpiresDays");l&&l.addEventListener("input",x),c&&c.addEventListener("input",x)}function E(n,o,i=""){const t=e("#editFileId"),a=e("#replaceFileId"),r=e("#editFileName"),s=e("#replaceFileName"),l=e("#editComment");t&&(t.value=n),a&&(a.value=n),r&&(r.value=o),s&&(s.value=o),l&&(l.value=i),I("comment-tab","commentTab"),w("editModal"),setTimeout(()=>{const c=e("#saveCommentBtn"),d=e("#replaceFileBtn");c&&(u(c,"d-none"),c.style.display="inline-block"),d&&(m(d,"d-none"),d.style.display="none")},10)}function T(n,o,i=""){const t=e("#editFileId"),a=e("#replaceFileId"),r=e("#editFileName"),s=e("#replaceFileName"),l=e("#editComment");t&&(t.value=n),a&&(a.value=n),r&&(r.value=o),s&&(s.value=o),l&&(l.value=i);const c=e("#editReplaceKeyInput");c&&(c.value=""),I("comment-tab","commentTab"),w("editModal"),setTimeout(()=>{const d=e("#saveCommentBtn"),g=e("#replaceFileBtn");d&&(u(d,"d-none"),d.style.display="inline-block"),g&&(m(g,"d-none"),g.style.display="none")},10)}function L(n,o=""){const i=e("#replaceFileId"),t=e("#editFileName"),a=e("#replaceFileName");i&&(i.value=n),t&&(t.value=o),a&&(a.value=o),I("replace-tab","replaceTab"),w("editModal"),setTimeout(()=>{const r=e("#saveCommentBtn"),s=e("#replaceFileBtn");s&&(u(s,"d-none"),s.style.display="inline-block"),r&&(m(r,"d-none"),r.style.display="none")},10)}function S(n,o,i=""){const t=e("#shareFileName"),a=e("#shareFileComment");t&&(t.value=o,t.setAttribute("data-file-id",n)),a&&(a.value=i),K(n),setTimeout(()=>{x()},100);const r=e("#shareResultPanel"),s=e("#regenerateShareLinkBtn"),l=e("#generateShareLinkBtn");r&&(m(r,"d-none"),r.style.display="none"),s&&(s.style.display="none"),l&&(l.style.display="inline-block"),w("shareLinkModal")}async function N(){const n=e("#editFileId"),o=e("#editComment"),i=e("#editReplaceKeyInput");if(!n||!o){p("必要な入力項目が見つかりません。");return}const t=n.value,a=o.value,r=i?.value||"";if(!t){p("ファイルIDが指定されていません。");return}if(!r.trim()){p("差し替えキーが必要です。");return}try{const s=new FormData;s.append("file_id",t),s.append("comment",a),s.append("replace_key",r),s.append("csrf_token",k());const l=await v("/api/edit-comment.php",s);if(l.success)h("コメントを保存しました。"),F("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(l.error||"コメントの保存に失敗しました。")}catch(s){console.error("コメント保存エラー:",s),p("コメントの保存に失敗しました。")}}async function R(){const n=e("#replaceFileId"),o=e("#replaceFileInput");if(!n||!o){p("必要な入力項目が見つかりません。");return}const i=n.value,t=o.files;if(!i){p("ファイルIDが指定されていません。");return}if(!t||t.length===0){p("差し替えるファイルを選択してください。");return}const a=t[0],r=new FormData;r.append("file",a),r.append("replacekey",document.getElementById("modalReplaceKeyInput")?.value||""),r.append("csrf_token",window.config?.csrf_token||"");try{const s=await v(`/api/replace-file.php?id=${encodeURIComponent(i)}`,r);if(s.success)h("ファイルを差し替えました。"),F("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(s.error||"ファイルの差し替えに失敗しました。")}catch(s){console.error("ファイル差し替えエラー:",s),p("ファイルの差し替えに失敗しました。")}}function U(n){const o=n.target,i=y(o,"data-bs-target"),t=e("#saveCommentBtn"),a=e("#replaceFileBtn");i==="#commentTab"?(t&&(u(t,"d-none"),t.style.display="inline-block"),a&&(m(a,"d-none"),a.style.display="none")):i==="#replaceTab"&&(t&&(m(t,"d-none"),t.style.display="none"),a&&(u(a,"d-none"),a.style.display="inline-block"))}async function H(){const n=e("#shareFileName"),o=e("#shareMaxDownloads"),i=e("#shareExpiresDays");if(!n){p("ファイル情報が見つかりません。");return}const t=y(n,"data-file-id"),a=o?.value||null,r=i?.value||null;if(!t){p("ファイルIDが見つかりません。");return}const s=e("#generateShareLinkBtn");s&&(s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const l=await v("/api/generatesharelink.php",{id:t,max_downloads:a,expires_days:r});if(l.success&&l.data)f=l.data,$(l.data),await b(),h("共有リンクを生成しました。");else{const c=l,d=c.message||c.error||"共有リンクの生成に失敗しました。";throw new Error(d)}}catch(l){console.error("共有リンク生成エラー:",l);const c=l instanceof Error?l.message:"共有リンクの生成に失敗しました。";p(c)}finally{s&&(s.disabled=!1,s.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function $(n){const o=e("#shareMaxDownloads");o&&(o.value=n.max_downloads?.toString()||"");const i=e("#shareExpiresDays");i&&(i.value=n.expires_days?.toString()||"");const t=e("#currentMaxDownloads"),a=e("#currentExpiresDays");if(t){const d=n.max_downloads||"無制限";t.innerHTML=`<strong>最大ダウンロード数:</strong> ${d}`}if(a){const d=n.expires_days||"無期限";a.innerHTML=`<strong>有効期限:</strong> ${d}`}const r=e("#shareResultPanel");r&&(u(r,"d-none"),r.style.display="block");const s=e("#regenerateShareLinkBtn"),l=e("#generateShareLinkBtn");s&&(s.style.display="inline-block"),l&&(l.style.display="none");const c=document.querySelector('input[name="shareFormat"][value="url_only"]');c&&(c.checked=!0,B(n))}function q(){f&&B(f)}function B(n){const o=document.querySelector('input[name="shareFormat"]:checked'),i=e("#shareUrl");if(!o||!i)return;const t=o.value;t==="url_only"?i.value=n.urlOnly||n.share_url||"":t==="url_with_comment"&&(i.value=n.urlWithComment||n.share_url_with_comment||"")}function I(n,o){document.querySelectorAll(".nav-link").forEach(a=>{u(a,"active"),y(a,"aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(a=>{u(a,"active"),u(a,"show")});const i=e("#"+n),t=e("#"+o);i&&(m(i,"active"),y(i,"aria-selected","true")),t&&(m(t,"active"),m(t,"show"))}function A(n,o="",i=""){E(n,o,i)}if(typeof window<"u"){const n=window;n.openEditDialog=E,n.editFile=A,n.editComment=T,n.replaceFile=L,n.openShareModal=S}async function K(n){try{const o=await C(`/api/generatesharelink.php?id=${encodeURIComponent(n)}`);if(o.success&&o.data){const i=o.data,t=e("#shareMaxDownloads"),a=e("#shareExpiresDays");t&&(t.value=i.max_downloads?.toString()||""),a&&(a.value=i.expires_days?.toString()||""),f={...f,max_downloads:i.max_downloads,expires_days:i.expires_days}}}catch(o){console.error("設定取得エラー:",o)}}async function P(){const n=e("#shareFileName"),o=e("#shareMaxDownloads"),i=e("#shareExpiresDays");if(!n){p("ファイル情報が見つかりません。");return}const t=n.getAttribute("data-file-id")||"",a=o?.value||null,r=i?.value||null,s=e("#saveShareSettingsBtn");s&&(s.disabled=!0,s.innerText="保存中...");try{const l=await v("/api/generatesharelink.php",{action:"updateSettings",id:t,max_downloads:a,expires_days:r});if(l.success)h("設定を保存しました。"),f={...f,max_downloads:a?parseInt(a):void 0,expires_days:r?parseInt(r):void 0};else throw new Error(l.error||"設定保存に失敗しました。")}catch(l){console.error("設定保存エラー:",l),p("設定の保存に失敗しました。")}finally{s&&(s.disabled=!1,s.innerText="設定を保存")}}async function b(){const n=e("#shareUrl");if(!n||!n.value){p("コピーする共有内容がありません。");return}try{await navigator.clipboard.writeText(n.value),h("共有内容をクリップボードにコピーしました。")}catch{n.select(),document.execCommand("copy"),h("共有内容をクリップボードにコピーしました。")}}function x(){const n=e("#shareMaxDownloads"),o=e("#shareExpiresDays"),i=e("#currentMaxDownloads"),t=e("#currentExpiresDays");if(i&&n){const a=n.value.trim()||"無制限";i.innerHTML=`<strong>最大ダウンロード数:</strong> ${a}`}if(t&&o){const a=o.value.trim()||"無期限";t.innerHTML=`<strong>有効期限:</strong> ${a} ${a!=="無期限"?"日":""}`}}window.openShareModal=S;
