import{r as k,i as D,$ as e,b as p,c as h,a as v,d as u,e as m}from"./error-handling.js";import{g as C,p as w,a as _}from"./http.js";import{h as E,s as I}from"./bootstrap.js";let y=null;k(()=>{D(),T()});function T(){const n=e("#saveCommentBtn");n&&n.addEventListener("click",K);const s=e("#replaceFileBtn");s&&s.addEventListener("click",N),document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(d=>{d.addEventListener("shown.bs.tab",U)});const a=e("#generateShareLinkBtn");a&&a.addEventListener("click",H);const t=e("#saveShareSettingsBtn");t&&t.addEventListener("click",z),document.querySelectorAll('input[name="shareFormat"]').forEach(d=>{d.addEventListener("change",q)});const o=e("#copyShareUrlBtn");o&&o.addEventListener("click",b);const i=e("#shareMaxDownloads"),c=e("#shareExpiresDays");i&&i.addEventListener("input",x),c&&c.addEventListener("input",x)}function S(n,s,r=""){const a=e("#editFileId"),t=e("#replaceFileId"),l=e("#editFileName"),o=e("#replaceFileName"),i=e("#editComment");a&&(a.value=n),t&&(t.value=n),l&&(l.value=s),o&&(o.value=s),i&&(i.value=r),F("comment-tab","commentTab"),I("editModal"),setTimeout(()=>{const c=e("#saveCommentBtn"),d=e("#replaceFileBtn");c&&(u(c,"d-none"),c.style.display="inline-block"),d&&(m(d,"d-none"),d.style.display="none")},10)}function L(n,s,r=""){const a=e("#editFileId"),t=e("#replaceFileId"),l=e("#editFileName"),o=e("#replaceFileName"),i=e("#editComment");a&&(a.value=n),t&&(t.value=n),l&&(l.value=s),o&&(o.value=s),i&&(i.value=r);const c=e("#editReplaceKeyInput");c&&(c.value="");const d=e("#editMasterKeyInput");d&&(d.value=""),F("comment-tab","commentTab"),I("editModal"),setTimeout(()=>{const f=e("#saveCommentBtn"),g=e("#replaceFileBtn");f&&(u(f,"d-none"),f.style.display="inline-block"),g&&(m(g,"d-none"),g.style.display="none")},10)}function R(n,s=""){const r=e("#replaceFileId"),a=e("#editFileName"),t=e("#replaceFileName");r&&(r.value=n),a&&(a.value=s),t&&(t.value=s),F("replace-tab","replaceTab"),I("editModal"),setTimeout(()=>{const l=e("#saveCommentBtn"),o=e("#replaceFileBtn");o&&(u(o,"d-none"),o.style.display="inline-block"),l&&(m(l,"d-none"),l.style.display="none")},10)}function M(n,s,r=""){const a=e("#shareFileName"),t=e("#shareFileComment");a&&(a.value=s,a.setAttribute("data-file-id",n)),t&&(t.value=r),P(n),setTimeout(()=>{x()},100);const l=e("#shareResultPanel"),o=e("#regenerateShareLinkBtn"),i=e("#generateShareLinkBtn");l&&(m(l,"d-none"),l.style.display="none"),o&&(o.style.display="none"),i&&(i.style.display="inline-block"),I("shareLinkModal")}async function K(){const n=e("#editFileId"),s=e("#editComment"),r=e("#editReplaceKeyInput"),a=e("#editMasterKeyInput");if(!n||!s){p("必要な入力項目が見つかりません。");return}const t=n.value,l=s.value,o=r?.value||"",i=a?.value||"";if(!t){p("ファイルIDが指定されていません。");return}if(!i.trim()&&!o.trim()){p("マスターキーまたは差し替えキーのいずれかを入力してください。");return}try{const c=new FormData;c.append("file_id",t),c.append("comment",l),c.append("master_key",i.trim()),c.append("replace_key",o.trim()),c.append("csrf_token",C());const d=await w("/api/edit-comment.php",c);if(d.success)h("コメントを保存しました。"),E("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(d.error||"コメントの保存に失敗しました。")}catch(c){console.error("コメント保存エラー:",c),p("コメントの保存に失敗しました。")}}async function N(){const n=e("#replaceFileId"),s=e("#replaceFileInput"),r=e("#replaceMasterKeyInput"),a=e("#modalReplaceKeyInput");if(!n||!s){p("必要な入力項目が見つかりません。");return}const t=n.value,l=s.files;if(!t){p("ファイルIDが指定されていません。");return}if(!l||l.length===0){p("差し替えるファイルを選択してください。");return}const o=l[0],i=r?.value||"",c=a?.value||"";if(!i.trim()&&!c.trim()){p("マスターキーまたは差し替えキーのいずれかを入力してください。");return}const d=new FormData;d.append("file",o),d.append("master_key",i.trim()),d.append("replacekey",c.trim()),d.append("csrf_token",window.config?.csrf_token||"");try{const f=await w(`/api/replace-file.php?id=${encodeURIComponent(t)}`,d);if(f.success)h("ファイルを差し替えました。"),E("editModal"),window.fileManagerInstance?await window.fileManagerInstance.refreshFromServer():window.location.reload();else throw new Error(f.error||"ファイルの差し替えに失敗しました。")}catch(f){console.error("ファイル差し替えエラー:",f),p("ファイルの差し替えに失敗しました。")}}function U(n){const s=n.target,r=v(s,"data-bs-target"),a=e("#saveCommentBtn"),t=e("#replaceFileBtn");r==="#commentTab"?(a&&(u(a,"d-none"),a.style.display="inline-block"),t&&(m(t,"d-none"),t.style.display="none")):r==="#replaceTab"&&(a&&(m(a,"d-none"),a.style.display="none"),t&&(u(t,"d-none"),t.style.display="inline-block"))}async function H(){const n=e("#shareFileName"),s=e("#shareMaxDownloads"),r=e("#shareExpiresDays");if(!n){p("ファイル情報が見つかりません。");return}const a=v(n,"data-file-id"),t=s?.value||null,l=r?.value||null;if(!a){p("ファイルIDが見つかりません。");return}const o=e("#generateShareLinkBtn");o&&(o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm" role="status"></span> 生成中...');try{const i=await w("/api/generatesharelink.php",{id:a,max_downloads:t,expires_days:l});if(i.success&&i.data)y=i.data,$(i.data),await b(),h("共有リンクを生成しました。");else{const c=i,d=c.message||c.error||"共有リンクの生成に失敗しました。";throw new Error(d)}}catch(i){console.error("共有リンク生成エラー:",i);const c=i instanceof Error?i.message:"共有リンクの生成に失敗しました。";p(c)}finally{o&&(o.disabled=!1,o.innerHTML='<i class="fas fa-link"></i> 共有リンクを生成')}}function $(n){const s=e("#shareMaxDownloads");s&&(s.value=n.max_downloads?.toString()||"");const r=e("#shareExpiresDays");r&&(r.value=n.expires_days?.toString()||"");const a=e("#currentMaxDownloads"),t=e("#currentExpiresDays");if(a){const d=n.max_downloads||"無制限";a.innerHTML=`<strong>最大ダウンロード数:</strong> ${d}`}if(t){const d=n.expires_days||"無期限";t.innerHTML=`<strong>有効期限:</strong> ${d}`}const l=e("#shareResultPanel");l&&(u(l,"d-none"),l.style.display="block");const o=e("#regenerateShareLinkBtn"),i=e("#generateShareLinkBtn");o&&(o.style.display="inline-block"),i&&(i.style.display="none");const c=document.querySelector('input[name="shareFormat"][value="url_only"]');c&&(c.checked=!0,B(n))}function q(){y&&B(y)}function B(n){const s=document.querySelector('input[name="shareFormat"]:checked'),r=e("#shareUrl");if(!s||!r)return;const a=s.value;a==="url_only"?r.value=n.urlOnly||n.share_url||"":a==="url_with_comment"&&(r.value=n.urlWithComment||n.share_url_with_comment||"")}function F(n,s){document.querySelectorAll(".nav-link").forEach(t=>{u(t,"active"),v(t,"aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(t=>{u(t,"active"),u(t,"show")});const r=e("#"+n),a=e("#"+s);r&&(m(r,"active"),v(r,"aria-selected","true")),a&&(m(a,"active"),m(a,"show"))}function A(n,s="",r=""){S(n,s,r)}if(typeof window<"u"){const n=window;n.openEditDialog=S,n.editFile=A,n.editComment=L,n.replaceFile=R,n.openShareModal=M}async function P(n){try{const s=await _(`/api/generatesharelink.php?id=${encodeURIComponent(n)}`);if(s.success&&s.data){const r=s.data,a=e("#shareMaxDownloads"),t=e("#shareExpiresDays");a&&(a.value=r.max_downloads?.toString()||""),t&&(t.value=r.expires_days?.toString()||""),y={...y,max_downloads:r.max_downloads,expires_days:r.expires_days}}}catch(s){console.error("設定取得エラー:",s)}}async function z(){const n=e("#shareFileName"),s=e("#shareMaxDownloads"),r=e("#shareExpiresDays");if(!n){p("ファイル情報が見つかりません。");return}const a=n.getAttribute("data-file-id")||"",t=s?.value||null,l=r?.value||null,o=e("#saveShareSettingsBtn");o&&(o.disabled=!0,o.innerText="保存中...");try{const i=await w("/api/generatesharelink.php",{action:"updateSettings",id:a,max_downloads:t,expires_days:l});if(i.success)h("設定を保存しました。"),y={...y,max_downloads:t?parseInt(t):void 0,expires_days:l?parseInt(l):void 0};else throw new Error(i.error||"設定保存に失敗しました。")}catch(i){console.error("設定保存エラー:",i),p("設定の保存に失敗しました。")}finally{o&&(o.disabled=!1,o.innerText="設定を保存")}}async function b(){const n=e("#shareUrl");if(!n||!n.value){p("コピーする共有内容がありません。");return}try{await navigator.clipboard.writeText(n.value),h("共有内容をクリップボードにコピーしました。")}catch{n.select(),document.execCommand("copy"),h("共有内容をクリップボードにコピーしました。")}}function x(){const n=e("#shareMaxDownloads"),s=e("#shareExpiresDays"),r=e("#currentMaxDownloads"),a=e("#currentExpiresDays");if(r&&n){const t=n.value.trim()||"無制限";r.innerHTML=`<strong>最大ダウンロード数:</strong> ${t}`}if(a&&s){const t=s.value.trim()||"無期限";a.innerHTML=`<strong>有効期限:</strong> ${t} ${t!=="無期限"?"日":""}`}}window.openShareModal=M;
