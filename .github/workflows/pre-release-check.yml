name: ðŸ” Pre-Release Quality Check

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to check'
        required: true
        default: 'main'
        type: string
  push:
    branches:
      - 'main'
      - 'release/*'
  pull_request:
    branches:
      - 'main'
      - 'release/*'

jobs:
  quality-check:
    name: ðŸ§ª Quality Assurance
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, sqlite3, openssl, json
          coverage: none

      - name: ðŸ“¦ Install Composer dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --no-dev --optimize-autoloader
            echo "âœ… Composer dependencies installed"
          else
            echo "â„¹ï¸  No composer.json found, skipping dependency installation"
          fi

      - name: ðŸ” PHP Syntax Check
        run: |
          echo "ðŸ” Checking PHP syntax..."
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l
          echo "âœ… PHP syntax check completed"

      - name: ðŸ“‹ Validate Configuration
        run: |
          echo "ðŸ“‹ Validating configuration files..."
          
          # config.php.example ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "backend/config/config.php.example" ]; then
            echo "âŒ backend/config/config.php.example not found"
            exit 1
          fi
          
          # composer.json ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "composer.json" ]; then
            echo "âŒ composer.json not found"
            exit 1
          fi
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ç¢ºèª
          VERSION=$(grep '"version"' composer.json | sed 's/.*"version": "\(.*\)".*/\1/')
          echo "ðŸ“Œ Current version: $VERSION"
          
          # README.md ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "README.md" ]; then
            echo "âš ï¸  README.md not found"
          fi
          
          echo "âœ… Configuration validation completed"

      - name: ðŸ—„ï¸ Database Schema Check
        run: |
          echo "ðŸ—„ï¸ Checking database schema files..."
          
          # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "backend/scripts/migrate_db.php" ]; then
            php -l backend/scripts/migrate_db.php
            echo "âœ… migrate_db.php syntax OK"
          fi
          
          if [ -f "backend/models/init.php" ]; then
            php -l backend/models/init.php
            echo "âœ… backend/models/init.php syntax OK"
          fi
          
          echo "âœ… Database schema check completed"

      - name: ðŸŒ API Endpoints Check
        run: |
          echo "ðŸŒ Checking API endpoints..."
          
          # APIé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          if [ -d "backend/api" ]; then
            find backend/api -name "*.php" -print0 | xargs -0 -n1 php -l
            echo "âœ… API files syntax check completed"
          fi
          
          # APIæ–‡æ›¸ã®ç¢ºèª
          if [ -f "docs/API.md" ]; then
            echo "âœ… API documentation found"
          else
            echo "âš ï¸  API documentation not found"
          fi

      - name: ðŸŽ¨ Frontend Assets Check
        run: |
          echo "ðŸŽ¨ Checking frontend assets..."
          
          # CSS ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -d "asset/css" ]; then
            echo "âœ… CSS directory found"
            ls -la asset/css/
          fi
          
          # JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -d "asset/js" ]; then
            echo "âœ… JavaScript directory found"
            ls -la asset/js/
          fi
          
          # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -d "asset/images" ] || [ -d "image" ]; then
            echo "âœ… Image directory found"
          fi

      - name: ðŸ“š Documentation Check
        run: |
          echo "ðŸ“š Checking documentation..."
          
          # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã®ç¢ºèª
          RELEASE_NOTES=$(find . -name "RELEASE_NOTES*.md" | head -1)
          if [ -n "$RELEASE_NOTES" ]; then
            echo "âœ… Release notes found: $RELEASE_NOTES"
            wc -l "$RELEASE_NOTES"
          else
            echo "âš ï¸  Release notes not found"
          fi
          
          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "LICENSE" ] || [ -f "MIT-LICENSE.txt" ]; then
            echo "âœ… License file found"
          else
            echo "âš ï¸  License file not found"
          fi

      - name: ðŸ”’ Security Check
        run: |
          echo "ðŸ”’ Performing basic security checks..."
          
          # å±é™ºãªé–¢æ•°ã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯
          echo "ðŸ” Checking for potentially dangerous functions..."
          DANGEROUS_FUNCTIONS="eval exec system shell_exec passthru"
          
          for func in $DANGEROUS_FUNCTIONS; do
            if grep -r "$func(" --include="*.php" . --exclude-dir=vendor; then
              echo "âš ï¸  Found usage of potentially dangerous function: $func"
            fi
          done
          
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
          echo "ðŸ” Checking for default passwords..."
          if grep -r "CHANGE_THIS" --include="*.php" .; then
            echo "âš ï¸  Found default passwords that should be changed"
          fi
          
          echo "âœ… Security check completed"

      - name: ðŸ“Š Generate Quality Report
        run: |
          echo "## ðŸ“Š Quality Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Checks" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ˜ PHP Syntax Validation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ Configuration Validation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—„ï¸ Database Schema Check" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ API Endpoints Check" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ Frontend Assets Check" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“š Documentation Check" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
          VERSION=$(grep '"version"' composer.json | sed 's/.*"version": "\(.*\)".*/\1/')
          echo "### ðŸ“Œ Version Information" >> $GITHUB_STEP_SUMMARY
          echo "**Current Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ
          echo "### ðŸ“ˆ Project Statistics" >> $GITHUB_STEP_SUMMARY
          echo "**PHP Files**: $(find . -name '*.php' -not -path './vendor/*' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**CSS Files**: $(find . -name '*.css' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**JS Files**: $(find . -name '*.js' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Total Lines of PHP**: $(find . -name '*.php' -not -path './vendor/*' -exec wc -l {} + | tail -1 | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ‰ Quality Check Status" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: âœ… All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for Release**: ðŸš€ Yes" >> $GITHUB_STEP_SUMMARY

  release-readiness:
    name: ðŸš€ Release Readiness Check
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: ðŸ·ï¸ Check version consistency
        run: |
          echo "ðŸ·ï¸ Checking version consistency..."
          
          # composer.json ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          COMPOSER_VERSION=$(grep '"version"' composer.json | sed 's/.*"version": "\(.*\)".*/\1/')
          echo "Composer version: $COMPOSER_VERSION"
          
          # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          EXPECTED_NOTES="RELEASE_NOTES_v${COMPOSER_VERSION}.md"
          if [ -f "$EXPECTED_NOTES" ]; then
            echo "âœ… Release notes found: $EXPECTED_NOTES"
          else
            echo "âš ï¸  Expected release notes file not found: $EXPECTED_NOTES"
            echo "Available release notes:"
            ls -la RELEASE_NOTES*.md 2>/dev/null || echo "No release notes found"
          fi

      - name: ðŸŽ¯ Release Checklist
        run: |
          echo "## ðŸŽ¯ Release Readiness Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å¿…é ˆé …ç›®ã®ãƒã‚§ãƒƒã‚¯
          CHECKLIST_ITEMS=(
            "composer.json:$([ -f composer.json ] && echo 'âœ…' || echo 'âŒ')"
            "config.php.example:$([ -f backend/config/config.php.example ] && echo 'âœ…' || echo 'âŒ')"
            "README.md:$([ -f README.md ] && echo 'âœ…' || echo 'âŒ')"
            "License file:$([ -f LICENSE ] || [ -f MIT-LICENSE.txt ] && echo 'âœ…' || echo 'âŒ')"
            "Release notes:$(ls RELEASE_NOTES*.md >/dev/null 2>&1 && echo 'âœ…' || echo 'âŒ')"
            "API documentation:$([ -f docs/API.md ] && echo 'âœ…' || echo 'âŒ')"
          )
          
          for item in "${CHECKLIST_ITEMS[@]}"; do
            echo "- ${item}" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "If all items are âœ…, you can proceed with creating a release:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Run 'Tag and Release' workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Specify version and branch" >> $GITHUB_STEP_SUMMARY
          echo "4. The release will be created automatically" >> $GITHUB_STEP_SUMMARY