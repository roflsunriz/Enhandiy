name: ğŸš€ Automated Release

on:
  push:
    tags:
      - 'v*.*.*'  # v4.0.0 ãªã©ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      tag_name:
        description: 'Release tag (e.g., v4.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  create-release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦changelogã‚’ç”Ÿæˆ

      - name: ğŸ·ï¸ Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Extract version from tag
        id: version
        run: |
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"
          # ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º (v4.0.0 -> 4.0.0)
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: ğŸ” Find release notes
        id: release_notes
        run: |
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™ï¼ˆè¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™ï¼‰
          if [ -f "docs/RELEASE_NOTES_v${VERSION}.md" ]; then
            NOTES_FILE="docs/RELEASE_NOTES_v${VERSION}.md"
          elif [ -f "docs/RELEASE_NOTES_${VERSION}.md" ]; then
            NOTES_FILE="docs/RELEASE_NOTES_${VERSION}.md"
          elif [ -f "docs/RELEASE_NOTES_${TAG_NAME}.md" ]; then
            NOTES_FILE="docs/RELEASE_NOTES_${TAG_NAME}.md"
          elif [ -f "CHANGELOG.md" ]; then
            NOTES_FILE="CHANGELOG.md"
          else
            echo "No release notes found, using default"
            NOTES_FILE=""
          fi
          
          echo "notes_file=$NOTES_FILE" >> $GITHUB_OUTPUT
          echo "Found release notes: $NOTES_FILE"
          echo "Searched patterns:"
          echo "  - RELEASE_NOTES_v${VERSION}.md"
          echo "  - RELEASE_NOTES_${VERSION}.md"
          echo "  - RELEASE_NOTES_${TAG_NAME}.md"
          echo "  - CHANGELOG.md"

      - name: ğŸ“ Prepare release body
        id: release_body
        run: |
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"
          VERSION="${{ steps.version.outputs.version }}"
          NOTES_FILE="${{ steps.release_notes.outputs.notes_file }}"
          
          # ãƒªãƒªãƒ¼ã‚¹ãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          cat > release_body.md << 'EOF'
          # Enhandiy ${{ steps.tag.outputs.tag_name }} - Official Release

          ## ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
          EOF

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°è¿½åŠ 
          if [ -n "$NOTES_FILE" ] && [ -f "$NOTES_FILE" ]; then
            echo "" >> release_body.md
            cat "$NOTES_FILE" >> release_body.md
          fi

          # å¤‰æ›´å±¥æ­´ã‚’è¿½åŠ 
          echo "" >> release_body.md
          echo "## ğŸ”„ Recent Changes" >> release_body.md
          echo "" >> release_body.md
          echo '```' >> release_body.md
          git log --oneline -5 >> release_body.md
          echo '```' >> release_body.md

          # CHANGELOG.md ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€æœ€æ–°ã®3ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡ºã—ã¦è¿½åŠ 
          if [ -f "CHANGELOG.md" ]; then
            echo "" >> release_body.md
            echo "## CHANGELOG - Latest 3 entries" >> release_body.md
            awk 'BEGIN{count=0;printing=0} /^##\s/ {count++; if(count>3) exit; printing=1} { if(printing) print }' CHANGELOG.md >> release_body.md
          fi

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’è¿½åŠ 
          cat >> release_body.md << 'EOF'

          ## ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          ### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³
          - **Source Code**: ä»¥ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - **Git Clone**: `git clone https://github.com/roflsunriz/Enhandiy.git`
          - **ç‰¹å®šã®ã‚¿ã‚°**: `git clone -b ${{ steps.tag.outputs.tag_name }} https://github.com/roflsunriz/Enhandiy.git`

          ### ã‚¯ã‚¤ãƒƒã‚¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          1. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å±•é–‹
          2. `backend/config/config.php.example` ã‚’ `backend/config/config.php` ã«ã‚³ãƒ”ãƒ¼
          3. `backend/config/config.php` ã«è¨­å®šã‚’è¨­å®š
          4. ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’backend/publicã®ãƒ«ãƒ¼ãƒˆã«è¨­å®š
          5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™

          ## ğŸ”— ãƒªãƒ³ã‚¯
          - **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `docs/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‚ç…§
          - **APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹**: `docs/API.md`
          - **ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: [shimosyan/phpUploader](https://github.com/shimosyan/phpUploader)

          ## ğŸ™ è¬è¾
          ã“ã®æ‹¡å¼µãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã®phpUploaderãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæä¾›ã™ã‚‹å„ªã‚ŒãŸåŸºç›¤ã«åŸºã¥ã„ã¦æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

          **å¤‰æ›´å±¥æ­´**: https://github.com/roflsunriz/Enhandiy/commits/${{ steps.tag.outputs.tag_name }}
          EOF
          
          echo "ãƒªãƒªãƒ¼ã‚¹ãƒœãƒ‡ã‚£ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: ğŸ—ï¸ Build release assets
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"
          PROJECT_NAME="Enhandiy-${TAG_NAME}"
          
          # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
          mkdir -p dist
          
          # Gitå±¥æ­´ã‚’é™¤å¤–ã—ãŸå®Œå…¨ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
          git archive --format=zip --prefix="${PROJECT_NAME}/" HEAD > "dist/${PROJECT_NAME}-source.zip"
          git archive --format=tar.gz --prefix="${PROJECT_NAME}/" HEAD > "dist/${PROJECT_NAME}-source.tar.gz"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèª
          ls -lh dist/
          
          echo "ãƒªãƒªãƒ¼ã‚¹ã‚¢ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: ğŸš€ Create GitHub Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          release_name: Enhandiy ${{ steps.tag.outputs.tag_name }}
          body_path: release_body.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}

      - name: ğŸ“ Upload ZIP Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/Enhandiy-${{ steps.tag.outputs.tag_name }}-source.zip
          asset_name: Enhandiy-${{ steps.tag.outputs.tag_name }}-source.zip
          asset_content_type: application/zip

      - name: ğŸ“ Upload TAR.GZ Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/Enhandiy-${{ steps.tag.outputs.tag_name }}-source.tar.gz
          asset_name: Enhandiy-${{ steps.tag.outputs.tag_name }}-source.tar.gz
          asset_content_type: application/gzip

      - name: ğŸ“¢ Release Summary
        run: |
          echo "## ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ steps.tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL**: ${{ steps.create_release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ã‚¢ã‚»ãƒƒãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "- Source code (ZIP)" >> $GITHUB_STEP_SUMMARY
          echo "- Source code (TAR.GZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ³ã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](${{ steps.create_release.outputs.html_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Download ZIP](https://github.com/roflsunriz/Enhandiy/releases/download/${{ steps.tag.outputs.tag_name }}/Enhandiy-${{ steps.tag.outputs.tag_name }}-source.zip)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download TAR.GZ](https://github.com/roflsunriz/Enhandiy/releases/download/${{ steps.tag.outputs.tag_name }}/Enhandiy-${{ steps.tag.outputs.tag_name }}-source.tar.gz)" >> $GITHUB_STEP_SUMMARY

  notify-completion:
    name: ğŸ“¬ Notify Completion
    runs-on: ubuntu-latest
    needs: create-release
    if: always()
    
    steps:
      - name: ğŸ‰ Success Notification
        if: needs.create-release.result == 'success'
        run: |
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹è‡ªå‹•åŒ–ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸš€ æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ãŒGitHubã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ"
          
      - name: âŒ Failure Notification
        if: needs.create-release.result == 'failure'
        run: |
          echo "âŒ ãƒªãƒªãƒ¼ã‚¹è‡ªå‹•åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã€å†åº¦è©¦è¡Œã—ã¦ãã ã•ã„"
          exit 1